"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.packageJson = packageJson;
exports.cleanError = cleanError;
exports.wrap = wrap;
exports.toLog = toLog;
exports.RegistryMap = exports.QError = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function packageJson() {
  let testPath = _path.default.resolve(__dirname);

  const packagePath = () => _path.default.resolve(testPath, 'package.json');

  while (testPath && !_fs.default.existsSync(packagePath())) {
    testPath = _path.default.dirname(testPath);
  }

  return JSON.parse(_fs.default.readFileSync(packagePath(), 'utf8'));
}

function cleanError(error) {
  if ('ArangoError' in error) {
    return error.ArangoError;
  }

  delete error.request;
  delete error.response;
  return error;
}

const QErrorCode = {
  MESSAGE_EXPIRED: 10001,
  MULTIPLE_ACCESS_KEYS: 10002,
  UNAUTHORIZED: 10003,
  AUTH_SERVICE_UNAVAILABLE: 10004,
  AUTH_FAILED: 10005
};

class QError {
  static messageExpired(id, expiredAt) {
    return QError.create(QErrorCode.MESSAGE_EXPIRED, `Message expired`, {
      id,
      expiredAt,
      now: Date.now()
    });
  }

  static create(code, message, data) {
    const error = new Error(message);
    error.source = 'graphql';
    error.code = code;

    if (data !== undefined) {
      error.data = data;
    }

    return error;
  }

  static multipleAccessKeys() {
    return QError.create(QErrorCode.MULTIPLE_ACCESS_KEYS, 'Request must use the same access key for all queries and mutations');
  }

  static unauthorized() {
    return QError.create(QErrorCode.UNAUTHORIZED, 'Unauthorized');
  }

  static authServiceUnavailable() {
    return QError.create(QErrorCode.AUTH_SERVICE_UNAVAILABLE, 'Auth service unavailable');
  }

  static auth(error) {
    return QError.create(QErrorCode.AUTH_FAILED, error.message || error.description, {
      authErrorCode: error.code
    });
  }

}

exports.QError = QError;

function isInternalServerError(error) {
  if ('type' in error && error.type === 'system') {
    return true;
  }

  if ('errno' in error && 'syscall' in error) {
    return true;
  }
}

async function wrap(log, op, args, fetch) {
  try {
    return await fetch();
  } catch (err) {
    let cleaned = cleanError(err);
    log.error('FAILED', op, args, cleaned);

    if (isInternalServerError(cleaned)) {
      cleaned = QError.create(500, 'Service temporary unavailable');
    }

    throw cleaned;
  }
}

class RegistryMap {
  constructor(name) {
    this.name = name;
    this.lastId = 0;
    this.items = new Map();
  }

  add(item) {
    let id = this.lastId;

    do {
      id = id < Number.MAX_SAFE_INTEGER ? id + 1 : 1;
    } while (this.items.has(id));

    this.lastId = id;
    this.items.set(id, item);
    return id;
  }

  remove(id) {
    if (!this.items.delete(id)) {
      console.error(`Failed to remove ${this.name}: item with id [${id}] does not exists`);
    }
  }

  entries() {
    return [...this.items.entries()];
  }

  values() {
    return [...this.items.values()];
  }

}

exports.RegistryMap = RegistryMap;

function toLog(value, objs) {
  const typeOf = typeof value;

  switch (typeOf) {
    case "undefined":
    case "boolean":
    case "number":
    case "bigint":
    case "symbol":
      return value;

    case "string":
      if (value.length > 80) {
        return `${value.substr(0, 50)}â€¦ [${value.length}]`;
      }

      return value;

    case "function":
      return undefined;

    default:
      if (value === null) {
        return value;
      }

      if (objs && objs.includes(value)) {
        return undefined;
      }

      const newObjs = objs ? [...objs, value] : [value];

      if (Array.isArray(value)) {
        return value.map(x => toLog(x, newObjs));
      }

      const valueToLog = {};
      Object.entries(value).forEach(([n, v]) => {
        const propertyValueToLog = toLog(v, newObjs);

        if (propertyValueToLog !== undefined) {
          valueToLog[n] = propertyValueToLog;
        }
      });
      return valueToLog;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci91dGlscy5qcyJdLCJuYW1lcyI6WyJwYWNrYWdlSnNvbiIsInRlc3RQYXRoIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJwYWNrYWdlUGF0aCIsImZzIiwiZXhpc3RzU3luYyIsImRpcm5hbWUiLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZVN5bmMiLCJjbGVhbkVycm9yIiwiZXJyb3IiLCJBcmFuZ29FcnJvciIsInJlcXVlc3QiLCJyZXNwb25zZSIsIlFFcnJvckNvZGUiLCJNRVNTQUdFX0VYUElSRUQiLCJNVUxUSVBMRV9BQ0NFU1NfS0VZUyIsIlVOQVVUSE9SSVpFRCIsIkFVVEhfU0VSVklDRV9VTkFWQUlMQUJMRSIsIkFVVEhfRkFJTEVEIiwiUUVycm9yIiwibWVzc2FnZUV4cGlyZWQiLCJpZCIsImV4cGlyZWRBdCIsImNyZWF0ZSIsIm5vdyIsIkRhdGUiLCJjb2RlIiwibWVzc2FnZSIsImRhdGEiLCJFcnJvciIsInNvdXJjZSIsInVuZGVmaW5lZCIsIm11bHRpcGxlQWNjZXNzS2V5cyIsInVuYXV0aG9yaXplZCIsImF1dGhTZXJ2aWNlVW5hdmFpbGFibGUiLCJhdXRoIiwiZGVzY3JpcHRpb24iLCJhdXRoRXJyb3JDb2RlIiwiaXNJbnRlcm5hbFNlcnZlckVycm9yIiwidHlwZSIsIndyYXAiLCJsb2ciLCJvcCIsImFyZ3MiLCJmZXRjaCIsImVyciIsImNsZWFuZWQiLCJSZWdpc3RyeU1hcCIsImNvbnN0cnVjdG9yIiwibmFtZSIsImxhc3RJZCIsIml0ZW1zIiwiTWFwIiwiYWRkIiwiaXRlbSIsIk51bWJlciIsIk1BWF9TQUZFX0lOVEVHRVIiLCJoYXMiLCJzZXQiLCJyZW1vdmUiLCJkZWxldGUiLCJjb25zb2xlIiwiZW50cmllcyIsInZhbHVlcyIsInRvTG9nIiwidmFsdWUiLCJvYmpzIiwidHlwZU9mIiwibGVuZ3RoIiwic3Vic3RyIiwiaW5jbHVkZXMiLCJuZXdPYmpzIiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwi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QixNQUFLSixLQUFLLENBQUNHLE1BQU8sR0FBaEQ7QUFDSDs7QUFDRCxhQUFPSCxLQUFQOztBQUNKLFNBQUssVUFBTDtBQUNJLGFBQU9sQyxTQUFQOztBQUNKO0FBQ0ksVUFBSWtDLEtBQUssS0FBSyxJQUFkLEVBQW9CO0FBQ2hCLGVBQU9BLEtBQVA7QUFDSDs7QUFDRCxVQUFJQyxJQUFJLElBQUlBLElBQUksQ0FBQ0ksUUFBTCxDQUFjTCxLQUFkLENBQVosRUFBa0M7QUFDOUIsZUFBT2xDLFNBQVA7QUFDSDs7QUFDRCxZQUFNd0MsT0FBTyxHQUFHTCxJQUFJLEdBQUcsQ0FBQyxHQUFHQSxJQUFKLEVBQVVELEtBQVYsQ0FBSCxHQUFzQixDQUFDQSxLQUFELENBQTFDOztBQUNBLFVBQUlPLEtBQUssQ0FBQ0MsT0FBTixDQUFjUixLQUFkLENBQUosRUFBMEI7QUFDdEIsZUFBT0EsS0FBSyxDQUFDUyxHQUFOLENBQVVDLENBQUMsSUFBSVgsS0FBSyxDQUFDVyxDQUFELEVBQUlKLE9BQUosQ0FBcEIsQ0FBUDtBQUNIOztBQUNELFlBQU1LLFVBQTZCLEdBQUcsRUFBdEM7QUFDQUMsTUFBQUEsTUFBTSxDQUFDZixPQUFQLENBQWVHLEtBQWYsRUFBc0JhLE9BQXRCLENBQThCLENBQUMsQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLENBQUQsS0FBWTtBQUN0QyxjQUFNQyxrQkFBa0IsR0FBR2pCLEtBQUssQ0FBQ2dCLENBQUQsRUFBSVQsT0FBSixDQUFoQzs7QUFDQSxZQUFJVSxrQkFBa0IsS0FBS2xELFNBQTNCLEVBQXNDO0FBQ2xDNkMsVUFBQUEsVUFBVSxDQUFDRyxDQUFELENBQVYsR0FBZ0JFLGtCQUFoQjtBQUNIO0FBQ0osT0FMRDtBQU1BLGFBQU9MLFVBQVA7QUFoQ0o7QUFrQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuL2xvZ3MnO1xyXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwYWNrYWdlSnNvbigpOiBhbnkge1xyXG4gICAgbGV0IHRlc3RQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSk7XHJcbiAgICBjb25zdCBwYWNrYWdlUGF0aCA9ICgpID0+IHBhdGgucmVzb2x2ZSh0ZXN0UGF0aCwgJ3BhY2thZ2UuanNvbicpO1xyXG4gICAgd2hpbGUgKHRlc3RQYXRoICYmICFmcy5leGlzdHNTeW5jKHBhY2thZ2VQYXRoKCkpKSB7XHJcbiAgICAgICAgdGVzdFBhdGggPSBwYXRoLmRpcm5hbWUodGVzdFBhdGgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHBhY2thZ2VQYXRoKCksICd1dGY4JykpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xlYW5FcnJvcihlcnJvcjogYW55KTogYW55IHtcclxuICAgIGlmICgnQXJhbmdvRXJyb3InIGluIGVycm9yKSB7XHJcbiAgICAgICAgcmV0dXJuIGVycm9yLkFyYW5nb0Vycm9yO1xyXG4gICAgfVxyXG4gICAgZGVsZXRlIGVycm9yLnJlcXVlc3Q7XHJcbiAgICBkZWxldGUgZXJyb3IucmVzcG9uc2U7XHJcbiAgICByZXR1cm4gZXJyb3I7XHJcbn1cclxuXHJcbmNvbnN0IFFFcnJvckNvZGUgPSB7XHJcbiAgICBNRVNTQUdFX0VYUElSRUQ6IDEwMDAxLFxyXG4gICAgTVVMVElQTEVfQUNDRVNTX0tFWVM6IDEwMDAyLFxyXG4gICAgVU5BVVRIT1JJWkVEOiAxMDAwMyxcclxuICAgIEFVVEhfU0VSVklDRV9VTkFWQUlMQUJMRTogMTAwMDQsXHJcbiAgICBBVVRIX0ZBSUxFRDogMTAwMDUsXHJcbn07XHJcblxyXG5leHBvcnQgY2xhc3MgUUVycm9yIHtcclxuICAgIHN0YXRpYyBtZXNzYWdlRXhwaXJlZChpZDogc3RyaW5nLCBleHBpcmVkQXQ6IG51bWJlcik6IEVycm9yIHtcclxuICAgICAgICByZXR1cm4gUUVycm9yLmNyZWF0ZShRRXJyb3JDb2RlLk1FU1NBR0VfRVhQSVJFRCwgYE1lc3NhZ2UgZXhwaXJlZGAsIHtcclxuICAgICAgICAgICAgaWQsXHJcbiAgICAgICAgICAgIGV4cGlyZWRBdCxcclxuICAgICAgICAgICAgbm93OiBEYXRlLm5vdygpLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBjcmVhdGUoY29kZTogbnVtYmVyLCBtZXNzYWdlOiBzdHJpbmcsIGRhdGE/OiBhbnkpOiBFcnJvciB7XHJcbiAgICAgICAgY29uc3QgZXJyb3I6IGFueSA9IG5ldyBFcnJvcihtZXNzYWdlKTtcclxuICAgICAgICBlcnJvci5zb3VyY2UgPSAnZ3JhcGhxbCc7XHJcbiAgICAgICAgZXJyb3IuY29kZSA9IGNvZGU7XHJcbiAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBlcnJvci5kYXRhID0gZGF0YTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGVycm9yO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBtdWx0aXBsZUFjY2Vzc0tleXMoKSB7XHJcbiAgICAgICAgcmV0dXJuIFFFcnJvci5jcmVhdGUoXHJcbiAgICAgICAgICAgIFFFcnJvckNvZGUuTVVMVElQTEVfQUNDRVNTX0tFWVMsXHJcbiAgICAgICAgICAgICdSZXF1ZXN0IG11c3QgdXNlIHRoZSBzYW1lIGFjY2VzcyBrZXkgZm9yIGFsbCBxdWVyaWVzIGFuZCBtdXRhdGlvbnMnLFxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHVuYXV0aG9yaXplZCgpIHtcclxuICAgICAgICByZXR1cm4gUUVycm9yLmNyZWF0ZShRRXJyb3JDb2RlLlVOQVVUSE9SSVpFRCwgJ1VuYXV0aG9yaXplZCcpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBhdXRoU2VydmljZVVuYXZhaWxhYmxlKCkge1xyXG4gICAgICAgIHJldHVybiBRRXJyb3IuY3JlYXRlKFFFcnJvckNvZGUuQVVUSF9TRVJWSUNFX1VOQVZBSUxBQkxFLCAnQXV0aCBzZXJ2aWNlIHVuYXZhaWxhYmxlJyk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGF1dGgoZXJyb3IpIHtcclxuICAgICAgICByZXR1cm4gUUVycm9yLmNyZWF0ZShRRXJyb3JDb2RlLkFVVEhfRkFJTEVELFxyXG4gICAgICAgICAgICBlcnJvci5tZXNzYWdlIHx8IGVycm9yLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICB7IGF1dGhFcnJvckNvZGU6IGVycm9yLmNvZGUgfSxcclxuICAgICAgICApXHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzSW50ZXJuYWxTZXJ2ZXJFcnJvcihlcnJvcjogRXJyb3IpOiBib29sZWFuIHtcclxuICAgIGlmICgndHlwZScgaW4gZXJyb3IgJiYgZXJyb3IudHlwZSA9PT0gJ3N5c3RlbScpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIGlmICgnZXJybm8nIGluIGVycm9yICYmICdzeXNjYWxsJyBpbiBlcnJvcikge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd3JhcDxSPihsb2c6IFFMb2csIG9wOiBzdHJpbmcsIGFyZ3M6IGFueSwgZmV0Y2g6ICgpID0+IFByb21pc2U8Uj4pIHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZldGNoKCk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICBsZXQgY2xlYW5lZCA9IGNsZWFuRXJyb3IoZXJyKTtcclxuICAgICAgICBsb2cuZXJyb3IoJ0ZBSUxFRCcsIG9wLCBhcmdzLCBjbGVhbmVkKTtcclxuICAgICAgICBpZiAoaXNJbnRlcm5hbFNlcnZlckVycm9yKGNsZWFuZWQpKSB7XHJcbiAgICAgICAgICAgIGNsZWFuZWQgPSBRRXJyb3IuY3JlYXRlKDUwMCwgJ1NlcnZpY2UgdGVtcG9yYXJ5IHVuYXZhaWxhYmxlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRocm93IGNsZWFuZWQ7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBSZWdpc3RyeU1hcDxUPiB7XHJcbiAgICBuYW1lOiBzdHJpbmc7XHJcbiAgICBpdGVtczogTWFwPG51bWJlciwgVD47XHJcbiAgICBsYXN0SWQ6IG51bWJlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xyXG4gICAgICAgIHRoaXMubGFzdElkID0gMDtcclxuICAgICAgICB0aGlzLml0ZW1zID0gbmV3IE1hcCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZChpdGVtOiBUKTogbnVtYmVyIHtcclxuICAgICAgICBsZXQgaWQgPSB0aGlzLmxhc3RJZDtcclxuICAgICAgICBkbyB7XHJcbiAgICAgICAgICAgIGlkID0gaWQgPCBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUiA/IGlkICsgMSA6IDE7XHJcbiAgICAgICAgfSB3aGlsZSAodGhpcy5pdGVtcy5oYXMoaWQpKTtcclxuICAgICAgICB0aGlzLmxhc3RJZCA9IGlkO1xyXG4gICAgICAgIHRoaXMuaXRlbXMuc2V0KGlkLCBpdGVtKTtcclxuICAgICAgICByZXR1cm4gaWQ7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlKGlkOiBudW1iZXIpIHtcclxuICAgICAgICBpZiAoIXRoaXMuaXRlbXMuZGVsZXRlKGlkKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gcmVtb3ZlICR7dGhpcy5uYW1lfTogaXRlbSB3aXRoIGlkIFske2lkfV0gZG9lcyBub3QgZXhpc3RzYCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGVudHJpZXMoKTogW251bWJlciwgVF1bXSB7XHJcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLml0ZW1zLmVudHJpZXMoKV07XHJcbiAgICB9XHJcblxyXG4gICAgdmFsdWVzKCk6IFRbXSB7XHJcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLml0ZW1zLnZhbHVlcygpXTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRvTG9nKHZhbHVlOiBhbnksIG9ianM/OiBPYmplY3RbXSk6IGFueSB7XHJcbiAgICBjb25zdCB0eXBlT2YgPSB0eXBlb2YgdmFsdWU7XHJcbiAgICBzd2l0Y2ggKHR5cGVPZikge1xyXG4gICAgY2FzZSBcInVuZGVmaW5lZFwiOlxyXG4gICAgY2FzZSBcImJvb2xlYW5cIjpcclxuICAgIGNhc2UgXCJudW1iZXJcIjpcclxuICAgIGNhc2UgXCJiaWdpbnRcIjpcclxuICAgIGNhc2UgXCJzeW1ib2xcIjpcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICBjYXNlIFwic3RyaW5nXCI6XHJcbiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDgwKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHt2YWx1ZS5zdWJzdHIoMCwgNTApfeKApiBbJHt2YWx1ZS5sZW5ndGh9XWBcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgY2FzZSBcImZ1bmN0aW9uXCI6XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9ianMgJiYgb2Jqcy5pbmNsdWRlcyh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgbmV3T2JqcyA9IG9ianMgPyBbLi4ub2JqcywgdmFsdWVdIDogW3ZhbHVlXTtcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh4ID0+IHRvTG9nKHgsIG5ld09ianMpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgdmFsdWVUb0xvZzogeyBbc3RyaW5nXTogYW55IH0gPSB7fTtcclxuICAgICAgICBPYmplY3QuZW50cmllcyh2YWx1ZSkuZm9yRWFjaCgoW24sIHZdKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByb3BlcnR5VmFsdWVUb0xvZyA9IHRvTG9nKHYsIG5ld09ianMpO1xyXG4gICAgICAgICAgICBpZiAocHJvcGVydHlWYWx1ZVRvTG9nICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlVG9Mb2dbbl0gPSBwcm9wZXJ0eVZhbHVlVG9Mb2c7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gdmFsdWVUb0xvZ1xyXG4gICAgfVxyXG59XHJcbiJdfQ==