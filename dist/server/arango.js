"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

var _config = require("./config");

var _logs = _interopRequireDefault(require("./logs"));

var _resolversGenerated = require("./resolvers-generated");

var _opentracing = require("opentracing");

var _tracer = require("./tracer");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class Arango {
  constructor(config, logs, auth, tracer, stats) {
    this.config = config;
    this.log = logs.create('db');
    this.auth = auth;
    this.serverAddress = config.database.server;
    this.databaseName = config.database.name;
    this.tracer = tracer;
    this.statPostCount = new _tracer.StatsCounter(stats, _config.STATS.post.count, []);
    this.statPostFailed = new _tracer.StatsCounter(stats, _config.STATS.post.failed, []);

    const createDb = config => {
      const db = new _arangojs.Database({
        url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
        agentOptions: {
          maxSockets: config.maxSockets
        }
      });
      db.useDatabase(config.name);

      if (config.auth) {
        const authParts = config.auth.split(':');
        db.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
      }

      return db;
    };

    this.db = createDb(config.database);
    const slowDb = createDb(config.slowDatabase);
    this.collections = [];
    this.collectionsByName = new Map();

    const addCollection = (name, docType) => {
      const collection = new _arangoCollection.Collection(name, docType, logs, this.auth, this.tracer, stats, this.db, slowDb, config.isTests || false);
      this.collections.push(collection);
      this.collectionsByName.set(name, collection);
      return collection;
    };

    this.transactions = addCollection('transactions', _resolversGenerated.Transaction);
    this.messages = addCollection('messages', _resolversGenerated.Message);
    this.accounts = addCollection('accounts', _resolversGenerated.Account);
    this.blocks = addCollection('blocks', _resolversGenerated.Block);
    this.blocks_signatures = addCollection('blocks_signatures', _resolversGenerated.BlockSignatures);
  }

  start() {
    const listenerUrl = `${(0, _config.ensureProtocol)(this.serverAddress, 'http')}/${this.databaseName}`;
    this.listener = new _arangochair.default(listenerUrl);

    if (this.config.database.auth) {
      const userPassword = Buffer.from(this.config.database.auth).toString('base64');
      this.listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    this.collections.forEach(collection => {
      const name = collection.name;
      this.listener.subscribe({
        collection: name
      });
      this.listener.on(name, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDocumentInsertOrUpdate(name, docJson);
        }
      });
    });
    this.listener.start();
    this.log.debug('LISTEN', listenerUrl);
    this.listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => this.listener.start(), this.config.listener.restartTimeout);
    });
  }

  onDocumentInsertOrUpdate(name, doc) {
    const collection = this.collectionsByName.get(name);

    if (collection) {
      collection.onDocumentInsertOrUpdate(doc);
    }
  }

  dropCachedDbInfo() {
    this.collections.forEach(x => x.dropCachedDbInfo());
  }

  async query(query, bindVars) {
    return (0, _utils.wrap)(this.log, 'QUERY', {
      query,
      bindVars
    }, async () => {
      const cursor = await this.db.query({
        query,
        bindVars
      });
      return cursor.all();
    });
  }

  async finishOperations(operationIds) {
    let count = 0;
    this.collections.forEach(x => count += x.finishOperations(operationIds));
    return count;
  }

}

exports.default = Arango;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28uanMiXSwibmFtZXMiOlsiQXJhbmdvIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJsb2dzIiwiYXV0aCIsInRyYWNlciIsInN0YXRzIiwibG9nIiwiY3JlYXRlIiwic2VydmVyQWRkcmVzcyIsImRhdGFiYXNlIiwic2VydmVyIiwiZGF0YWJhc2VOYW1lIiwibmFtZSIsInN0YXRQb3N0Q291bnQiLCJTdGF0c0NvdW50ZXIiLCJTVEFUUyIsInBvc3QiLCJjb3VudCIsInN0YXRQb3N0RmFpbGVkIiwiZmFpbGVkIiwiY3JlYXRlRGIiLCJkYiIsIkRhdGFiYXNlIiwidXJsIiwiYWdlbnRPcHRpb25zIiwibWF4U29ja2V0cyIsInVzZURhdGFiYXNlIiwiYXV0aFBhcnRzIiwic3BsaXQiLCJ1c2VCYXNpY0F1dGgiLCJzbGljZSIsImpvaW4iLCJzbG93RGIiLCJzbG93RGF0YWJhc2UiLCJjb2xsZWN0aW9ucyIsImNvbGxlY3Rpb25zQnlOYW1lIiwiTWFwIiwiYWRkQ29sbGVjdGlvbiIsImRvY1R5cGUiLCJjb2xsZWN0aW9uIiwiQ29sbGVjdGlvbiIsImlzVGVzdHMiLCJwdXNoIiwic2V0IiwidHJhbnNhY3Rpb25zIiwiVHJhbnNhY3Rpb24iLCJtZXNzYWdlcyIsIk1lc3NhZ2UiLCJhY2NvdW50cyIsIkFjY291bnQiLCJibG9ja3MiLCJCbG9jayIsImJsb2Nrc19zaWduYXR1cmVzIiwiQmxvY2tTaWduYXR1cmVzIiwic3RhcnQiLCJsaXN0ZW5lclVybCIsImxpc3RlbmVyIiwiYXJhbmdvY2hhaXIiLCJ1c2VyUGFzc3dvcmQiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJyZXEiLCJvcHRzIiwiaGVhZGVycyIsImZvckVhY2giLCJzdWJzY3JpYmUiLCJvbiIsImRvY0pzb24iLCJ0eXBlIiwib25Eb2N1bWVudEluc2VydE9yVXBkYXRlIiwiZGVidWciLCJlcnIiLCJzdGF0dXMiLCJib2R5IiwiZXJyb3IiLCJKU09OIiwicGFyc2UiLCJzZXRUaW1lb3V0IiwicmVzdGFydFRpbWVvdXQiLCJkb2MiLCJnZXQiLCJkcm9wQ2FjaGVkRGJJbmZvIiwieCIsInF1ZXJ5IiwiYmluZFZhcnMiLCJjdXJzb3IiLCJhbGwiLCJmaW5pc2hPcGVyYXRpb25zIiwib3BlcmF0aW9uSWRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBa0JBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUVBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOzs7O0FBL0JBOzs7Ozs7Ozs7Ozs7Ozs7QUFrQ2UsTUFBTUEsTUFBTixDQUFhO0FBdUJ4QkMsRUFBQUEsV0FBVyxDQUNQQyxNQURPLEVBRVBDLElBRk8sRUFHUEMsSUFITyxFQUlQQyxNQUpPLEVBS1BDLEtBTE8sRUFNVDtBQUNFLFNBQUtKLE1BQUwsR0FBY0EsTUFBZDtBQUNBLFNBQUtLLEdBQUwsR0FBV0osSUFBSSxDQUFDSyxNQUFMLENBQVksSUFBWixDQUFYO0FBQ0EsU0FBS0osSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0ssYUFBTCxHQUFxQlAsTUFBTSxDQUFDUSxRQUFQLENBQWdCQyxNQUFyQztBQUNBLFNBQUtDLFlBQUwsR0FBb0JWLE1BQU0sQ0FBQ1EsUUFBUCxDQUFnQkcsSUFBcEM7QUFDQSxTQUFLUixNQUFMLEdBQWNBLE1BQWQ7QUFFQSxTQUFLUyxhQUFMLEdBQXFCLElBQUlDLG9CQUFKLENBQWlCVCxLQUFqQixFQUF3QlUsY0FBTUMsSUFBTixDQUFXQyxLQUFuQyxFQUEwQyxFQUExQyxDQUFyQjtBQUNBLFNBQUtDLGNBQUwsR0FBc0IsSUFBSUosb0JBQUosQ0FBaUJULEtBQWpCLEVBQXdCVSxjQUFNQyxJQUFOLENBQVdHLE1BQW5DLEVBQTJDLEVBQTNDLENBQXRCOztBQUVBLFVBQU1DLFFBQVEsR0FBSW5CLE1BQUQsSUFBaUM7QUFDOUMsWUFBTW9CLEVBQUUsR0FBRyxJQUFJQyxrQkFBSixDQUFhO0FBQ3BCQyxRQUFBQSxHQUFHLEVBQUcsR0FBRSw0QkFBZXRCLE1BQU0sQ0FBQ1MsTUFBdEIsRUFBOEIs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O0FBQ1pBLE1BQUFBLFVBQVUsQ0FBQytCLHdCQUFYLENBQW9DVSxHQUFwQztBQUNIO0FBQ0o7O0FBR0RFLEVBQUFBLGdCQUFnQixHQUFHO0FBQ2YsU0FBS2hELFdBQUwsQ0FBaUIrQixPQUFqQixDQUEwQmtCLENBQUQsSUFBbUJBLENBQUMsQ0FBQ0QsZ0JBQUYsRUFBNUM7QUFDSDs7QUFFRCxRQUFNRSxLQUFOLENBQVlBLEtBQVosRUFBd0JDLFFBQXhCLEVBQXVDO0FBQ25DLFdBQU8saUJBQUssS0FBSy9FLEdBQVYsRUFBZSxPQUFmLEVBQXdCO0FBQUU4RSxNQUFBQSxLQUFGO0FBQVNDLE1BQUFBO0FBQVQsS0FBeEIsRUFBNkMsWUFBWTtBQUM1RCxZQUFNQyxNQUFNLEdBQUcsTUFBTSxLQUFLakUsRUFBTCxDQUFRK0QsS0FBUixDQUFjO0FBQUVBLFFBQUFBLEtBQUY7QUFBU0MsUUFBQUE7QUFBVCxPQUFkLENBQXJCO0FBQ0EsYUFBT0MsTUFBTSxDQUFDQyxHQUFQLEVBQVA7QUFDSCxLQUhNLENBQVA7QUFJSDs7QUFFRCxRQUFNQyxnQkFBTixDQUF1QkMsWUFBdkIsRUFBbUU7QUFDL0QsUUFBSXhFLEtBQUssR0FBRyxDQUFaO0FBQ0EsU0FBS2lCLFdBQUwsQ0FBaUIrQixPQUFqQixDQUF5QmtCLENBQUMsSUFBS2xFLEtBQUssSUFBSWtFLENBQUMsQ0FBQ0ssZ0JBQUYsQ0FBbUJDLFlBQW5CLENBQXhDO0FBQ0EsV0FBT3hFLEtBQVA7QUFDSDs7QUEzSXVCIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQ29weXJpZ2h0IDIwMTgtMjAyMCBUT04gREVWIFNPTFVUSU9OUyBMVEQuXHJcbiAqXHJcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxyXG4gKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGVcclxuICogTGljZW5zZSBhdDpcclxuICpcclxuICogaHR0cDovL3d3dy50b24uZGV2L2xpY2Vuc2VzXHJcbiAqXHJcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxyXG4gKi9cclxuXHJcbi8vIEBmbG93XHJcblxyXG5pbXBvcnQgYXJhbmdvY2hhaXIgZnJvbSAnYXJhbmdvY2hhaXInO1xyXG5pbXBvcnQgeyBEYXRhYmFzZSB9IGZyb20gJ2FyYW5nb2pzJztcclxuaW1wb3J0IHsgQ29sbGVjdGlvbiB9IGZyb20gJy4vYXJhbmdvLWNvbGxlY3Rpb24nO1xyXG5pbXBvcnQgeyBBdXRoIH0gZnJvbSAnLi9hdXRoJztcclxuaW1wb3J0IHR5cGUgeyBRQ29uZmlnLCBRRGJDb25maWcgfSBmcm9tICcuL2NvbmZpZydcclxuaW1wb3J0IHsgZW5zdXJlUHJvdG9jb2wsIFNUQVRTIH0gZnJvbSAnLi9jb25maWcnO1xyXG5pbXBvcnQgdHlwZSB7IFFMb2cgfSBmcm9tICcuL2xvZ3MnO1xyXG5pbXBvcnQgUUxvZ3MgZnJvbSAnLi9sb2dzJ1xyXG5pbXBvcnQgdHlwZSB7IFFUeXBlIH0gZnJvbSAnLi9kYi10eXBlcyc7XHJcbmltcG9ydCB7IEFjY291bnQsIEJsb2NrLCBCbG9ja1NpZ25hdHVyZXMsIE1lc3NhZ2UsIFRyYW5zYWN0aW9uIH0gZnJvbSAnLi9yZXNvbHZlcnMtZ2VuZXJhdGVkJztcclxuaW1wb3J0IHsgVHJhY2VyIH0gZnJvbSAnb3BlbnRyYWNpbmcnO1xyXG5pbXBvcnQgeyBTdGF0c0NvdW50ZXIgfSBmcm9tICcuL3RyYWNlcic7XHJcbmltcG9ydCB0eXBlIHsgSVN0YXRzIH0gZnJvbSAnLi90cmFjZXInO1xyXG5pbXBvcnQgeyB3cmFwIH0gZnJvbSAnLi91dGlscyc7XHJcblxyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXJhbmdvIHtcclxuICAgIGNvbmZpZzogUUNvbmZpZztcclxuICAgIGxvZzogUUxvZztcclxuICAgIHNlcnZlckFkZHJlc3M6IHN0cmluZztcclxuICAgIGRhdGFiYXNlTmFtZTogc3RyaW5nO1xyXG4gICAgZGI6IERhdGFiYXNlO1xyXG5cclxuICAgIGF1dGg6IEF1dGg7XHJcbiAgICB0cmFjZXI6IFRyYWNlcjtcclxuICAgIHN0YXRQb3N0Q291bnQ6IFN0YXRzQ291bnRlcjtcclxuICAgIHN0YXRQb3N0RmFpbGVkOiBTdGF0c0NvdW50ZXI7XHJcblxyXG4gICAgdHJhbnNhY3Rpb25zOiBDb2xsZWN0aW9uO1xyXG4gICAgbWVzc2FnZXM6IENvbGxlY3Rpb247XHJcbiAgICBhY2NvdW50czogQ29sbGVjdGlvbjtcclxuICAgIGJsb2NrczogQ29sbGVjdGlvbjtcclxuICAgIGJsb2Nrc19zaWduYXR1cmVzOiBDb2xsZWN0aW9uO1xyXG5cclxuICAgIGNvbGxlY3Rpb25zOiBDb2xsZWN0aW9uW107XHJcbiAgICBjb2xsZWN0aW9uc0J5TmFtZTogTWFwPHN0cmluZywgQ29sbGVjdGlvbj47XHJcblxyXG4gICAgbGlzdGVuZXI6IGFueTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBjb25maWc6IFFDb25maWcsXHJcbiAgICAgICAgbG9nczogUUxvZ3MsXHJcbiAgICAgICAgYXV0aDogQXV0aCxcclxuICAgICAgICB0cmFjZXI6IFRyYWNlcixcclxuICAgICAgICBzdGF0czogSVN0YXRzLFxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XHJcbiAgICAgICAgdGhpcy5sb2cgPSBsb2dzLmNyZWF0ZSgnZGInKTtcclxuICAgICAgICB0aGlzLmF1dGggPSBhdXRoO1xyXG4gICAgICAgIHRoaXMuc2VydmVyQWRkcmVzcyA9IGNvbmZpZy5kYXRhYmFzZS5zZXJ2ZXI7XHJcbiAgICAgICAgdGhpcy5kYXRhYmFzZU5hbWUgPSBjb25maWcuZGF0YWJhc2UubmFtZTtcclxuICAgICAgICB0aGlzLnRyYWNlciA9IHRyYWNlcjtcclxuXHJcbiAgICAgICAgdGhpcy5zdGF0UG9zdENvdW50ID0gbmV3IFN0YXRzQ291bnRlcihzdGF0cywgU1RBVFMucG9zdC5jb3VudCwgW10pO1xyXG4gICAgICAgIHRoaXMuc3RhdFBvc3RGYWlsZWQgPSBuZXcgU3RhdHNDb3VudGVyKHN0YXRzLCBTVEFUUy5wb3N0LmZhaWxlZCwgW10pO1xyXG5cclxuICAgICAgICBjb25zdCBjcmVhdGVEYiA9IChjb25maWc6IFFEYkNvbmZpZyk6IERhdGFiYXNlID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZGIgPSBuZXcgRGF0YWJhc2Uoe1xyXG4gICAgICAgICAgICAgICAgdXJsOiBgJHtlbnN1cmVQcm90b2NvbChjb25maWcuc2VydmVyLCAnaHR0cCcpfWAsXHJcbiAgICAgICAgICAgICAgICBhZ2VudE9wdGlvbnM6IHtcclxuICAgICAgICAgICAgICAgICAgICBtYXhTb2NrZXRzOiBjb25maWcubWF4U29ja2V0cyxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBkYi51c2VEYXRhYmFzZShjb25maWcubmFtZSk7XHJcbiAgICAgICAgICAgIGlmIChjb25maWcuYXV0aCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXV0aFBhcnRzID0gY29uZmlnLmF1dGguc3BsaXQoJzonKTtcclxuICAgICAgICAgICAgICAgIGRiLnVzZUJhc2ljQXV0aChhdXRoUGFydHNbMF0sIGF1dGhQYXJ0cy5zbGljZSgxKS5qb2luKCc6JykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBkYjtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLmRiID0gY3JlYXRlRGIoY29uZmlnLmRhdGFiYXNlKTtcclxuICAgICAgICBjb25zdCBzbG93RGIgPSBjcmVhdGVEYihjb25maWcuc2xvd0RhdGFiYXNlKTtcclxuXHJcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucyA9IFtdO1xyXG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnNCeU5hbWUgPSBuZXcgTWFwKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGFkZENvbGxlY3Rpb24gPSAobmFtZTogc3RyaW5nLCBkb2NUeXBlOiBRVHlwZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb2xsZWN0aW9uID0gbmV3IENvbGxlY3Rpb24oXHJcbiAgICAgICAgICAgICAgICBuYW1lLFxyXG4gICAgICAgICAgICAgICAgZG9jVHlwZSxcclxuICAgICAgICAgICAgICAgIGxvZ3MsXHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dGgsXHJcbiAgICAgICAgICAgICAgICB0aGlzLnRyYWNlcixcclxuICAgICAgICAgICAgICAgIHN0YXRzLFxyXG4gICAgICAgICAgICAgICAgdGhpcy5kYixcclxuICAgICAgICAgICAgICAgIHNsb3dEYixcclxuICAgICAgICAgICAgICAgIGNvbmZpZy5pc1Rlc3RzIHx8IGZhbHNlLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLnB1c2goY29sbGVjdGlvbik7XHJcbiAgICAgICAgICAgIHRoaXMuY29sbGVjdGlvbnNCeU5hbWUuc2V0KG5hbWUsIGNvbGxlY3Rpb24pO1xyXG4gICAgICAgICAgICByZXR1cm4gY29sbGVjdGlvbjtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLnRyYW5zYWN0aW9ucyA9IGFkZENvbGxlY3Rpb24oJ3RyYW5zYWN0aW9ucycsIFRyYW5zYWN0aW9uKTtcclxuICAgICAgICB0aGlzLm1lc3NhZ2VzID0gYWRkQ29sbGVjdGlvbignbWVzc2FnZXMnLCBNZXNzYWdlKTtcclxuICAgICAgICB0aGlzLmFjY291bnRzID0gYWRkQ29sbGVjdGlvbignYWNjb3VudHMnLCBBY2NvdW50KTtcclxuICAgICAgICB0aGlzLmJsb2NrcyA9IGFkZENvbGxlY3Rpb24oJ2Jsb2NrcycsIEJsb2NrKTtcclxuICAgICAgICB0aGlzLmJsb2Nrc19zaWduYXR1cmVzID0gYWRkQ29sbGVjdGlvbignYmxvY2tzX3NpZ25hdHVyZXMnLCBCbG9ja1NpZ25hdHVyZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXJ0KCkge1xyXG4gICAgICAgIGNvbnN0IGxpc3RlbmVyVXJsID0gYCR7ZW5zdXJlUHJvdG9jb2wodGhpcy5zZXJ2ZXJBZGRyZXNzLCAnaHR0cCcpfS8ke3RoaXMuZGF0YWJhc2VOYW1lfWA7XHJcbiAgICAgICAgdGhpcy5saXN0ZW5lciA9IG5ldyBhcmFuZ29jaGFpcihsaXN0ZW5lclVybCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5kYXRhYmFzZS5hdXRoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVzZXJQYXNzd29yZCA9IEJ1ZmZlci5mcm9tKHRoaXMuY29uZmlnLmRhdGFiYXNlLmF1dGgpLnRvU3RyaW5nKCdiYXNlNjQnKTtcclxuICAgICAgICAgICAgdGhpcy5saXN0ZW5lci5yZXEub3B0cy5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBgQmFzaWMgJHt1c2VyUGFzc3dvcmR9YDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMuZm9yRWFjaChjb2xsZWN0aW9uID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbmFtZSA9IGNvbGxlY3Rpb24ubmFtZTtcclxuICAgICAgICAgICAgdGhpcy5saXN0ZW5lci5zdWJzY3JpYmUoeyBjb2xsZWN0aW9uOiBuYW1lIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmxpc3RlbmVyLm9uKG5hbWUsIChkb2NKc29uLCB0eXBlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2luc2VydC91cGRhdGUnIHx8IHR5cGUgPT09ICdpbnNlcnQnIHx8IHR5cGUgPT09ICd1cGRhdGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkRvY3VtZW50SW5zZXJ0T3JVcGRhdGUobmFtZSwgZG9jSnNvbik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMubGlzdGVuZXIuc3RhcnQoKTtcclxuICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnTElTVEVOJywgbGlzdGVuZXJVcmwpO1xyXG4gICAgICAgIHRoaXMubGlzdGVuZXIub24oJ2Vycm9yJywgKGVyciwgc3RhdHVzLCBoZWFkZXJzLCBib2R5KSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBlcnJvciA9IGVycjtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGVycm9yID0gSlNPTi5wYXJzZShib2R5KTtcclxuICAgICAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ0ZBSUxFRCcsICdMSVNURU4nLCBgJHtlcnJ9YCwgZXJyb3IpO1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMubGlzdGVuZXIuc3RhcnQoKSwgdGhpcy5jb25maWcubGlzdGVuZXIucmVzdGFydFRpbWVvdXQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG9uRG9jdW1lbnRJbnNlcnRPclVwZGF0ZShuYW1lOiBzdHJpbmcsIGRvYzogYW55KSB7XHJcbiAgICAgICAgY29uc3QgY29sbGVjdGlvbjogKENvbGxlY3Rpb24gfCB0eXBlb2YgdW5kZWZpbmVkKSA9IHRoaXMuY29sbGVjdGlvbnNCeU5hbWUuZ2V0KG5hbWUpO1xyXG4gICAgICAgIGlmIChjb2xsZWN0aW9uKSB7XHJcbiAgICAgICAgICAgIGNvbGxlY3Rpb24ub25Eb2N1bWVudEluc2VydE9yVXBkYXRlKGRvYyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBkcm9wQ2FjaGVkRGJJbmZvKCkge1xyXG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMuZm9yRWFjaCgoeDogQ29sbGVjdGlvbikgPT4geC5kcm9wQ2FjaGVkRGJJbmZvKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHF1ZXJ5KHF1ZXJ5OiBhbnksIGJpbmRWYXJzOiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gd3JhcCh0aGlzLmxvZywgJ1FVRVJZJywgeyBxdWVyeSwgYmluZFZhcnMgfSwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjdXJzb3IgPSBhd2FpdCB0aGlzLmRiLnF1ZXJ5KHsgcXVlcnksIGJpbmRWYXJzIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gY3Vyc29yLmFsbCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzOiBTZXQ8c3RyaW5nPik6IFByb21pc2U8bnVtYmVyPiB7XHJcbiAgICAgICAgbGV0IGNvdW50ID0gMDtcclxuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zLmZvckVhY2goeCA9PiAoY291bnQgKz0geC5maW5pc2hPcGVyYXRpb25zKG9wZXJhdGlvbklkcykpKTtcclxuICAgICAgICByZXR1cm4gY291bnQ7XHJcbiAgICB9XHJcbn1cclxuIl19