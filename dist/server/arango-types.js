"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.struct = struct;
exports.array = array;
exports.join = join;
exports.joinArray = joinArray;
exports.scalar = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

/*
 * Copyright 2018-2019 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
function qlFields(path, filter, fieldTypes, qlField) {
  var conditions = [];
  Object.entries(filter).forEach(function (_ref) {
    var _ref2 = (0, _slicedToArray2["default"])(_ref, 2),
        filterKey = _ref2[0],
        filterValue = _ref2[1];

    var fieldType = fieldTypes[filterKey];

    if (fieldType) {
      conditions.push(qlField(fieldType, path, filterKey, filterValue));
    }
  });
  return qlCombine(conditions, 'AND', 'false');
}

function testFields(value, filter, fieldTypes, testField) {
  var failed = Object.entries(filter).find(function (_ref3) {
    var _ref4 = (0, _slicedToArray2["default"])(_ref3, 2),
        filterKey = _ref4[0],
        filterValue = _ref4[1];

    var fieldType = fieldTypes[filterKey];
    return !!(fieldType && testField(fieldType, value, filterKey, filterValue));
  });
  return !failed;
}

function combine(path, key) {
  return key !== '' ? "".concat(path, ".").concat(key) : path;
}

function qlOp(path, op, filter) {
  return "".concat(path, " ").concat(op, " ").concat(JSON.stringify(filter));
}

function qlCombine(conditions, op, defaultConditions) {
  if (conditions.length === 0) {
    return defaultConditions;
  }

  if (conditions.length === 1) {
    return conditions[0];
  }

  return '(' + conditions.join(") ".concat(op, " (")) + ')';
}

function qlIn(path, filter) {
  var conditions = filter.map(function (value) {
    return qlOp(path, '==', value);
  });
  return qlCombine(conditions, 'OR', 'false');
} // Scalars


var scalarEq = {
  ql: function ql(path, filter) {
    return qlOp(path, '==', filter);
  },
  test: function test(value, filter) {
    return value === filter;
  }
};
var scalarNe = {
  ql: function ql(path, filter) {
    return qlOp(path, '!=', filter);
  },
  test: function test(value, filter) {
    return value !== filter;
  }
};
var scalarLt = {
  ql: function ql(path, filter) {
    return qlOp(path, '<', filter);
  },
  test: function test(value, filter) {
    return value < filter;
  }
};
var scalarLe = {
  ql: function ql(path, filter) {
    return qlOp(path, '<=', filter);
  },
  test: function test(value, filter) {
    return value <= filter;
  }
};
var scalarGt = {
  ql: function ql(path, filter) {
    return qlOp(path, '>', filter);
  },
  test: function test(value, filter) {
    return value > filter;
  }
};
var scalarGe = {
  ql: function ql(path, filter) {
    return qlOp(path, '>=', filter);
  },
  test: function test(value, filter) {
    return value >= filter;
  }
};
var scalarIn = {
  ql: function ql(path, filter) {
    return qlIn(path, filter);
  },
  test: function test(value, filter) {
    return filter.includes(value);
  }
};
var scalarNotIn = {
  ql: function ql(path, filter) {
    return "NOT (".concat(qlIn(path, filter), ")");
  },
  test: function test(value, filter) {
    return !filter.includes(value);
  }
};

function createScalar() {
  var fields = {
    eq: scalarEq,
    ne: scalarNe,
    lt: scalarLt,
    le: scalarLe,
    gt: scalarGt,
    ge: scalarGe,
    "in": scalarIn,
    notIn: scalarNotIn
  };
  return {
    ql: function ql(path, filter) {
      return qlFields(path, filter, fields, function (op, path, filterKey, filterValue) {
        return op.ql(path, filterValue);
      });
    },
    test: function test(value, filter) {
      return testFields(value, filter, fields, function (op, value, filterKey, filterValue) {
        return op.test(value, filterValue);
      });
    }
  };
}

var scalar = createScalar(); // Structs

exports.scalar = scalar;

function struct(fields, isCollection) {
  return {
    ql: function ql(path, filter) {
      return qlFields(path, filter, fields, function (fieldType, path, filterKey, filterValue) {
        var fieldName = isCollection && filterKey === 'id' ? '_key' : filterKey;
        return fieldType.ql(combine(path, fieldName), filterValue);
      });
    },
    test: function test(value, filter) {
      if (!value) {
        return false;
      }

      return testFields(value, filter, fields, function (fieldType, value, filterKey, filterValue) {
        var fieldName = isCollection && filterKey === 'id' ? '_key' : filterKey;
        return fieldType.test(value[fieldName], filterValue);
      });
    }
  };
} // Arrays


function array(itemType) {
  var ops = {
    all: {
      ql: function ql(path, filter) {
        var itemQl = itemType.ql('CURRENT', filter);
        return "LENGTH(".concat(path, "[* FILTER ").concat(itemQl, "]) == LENGTH(").concat(path, ")");
      },
      test: function test(value, filter) {
        var failedIndex = value.findIndex(function (x) {
          return !itemType.test(x, filter);
        });
        return failedIndex < 0;
      }
    },
    any: {
      ql: function ql(path, filter) {
        var itemQl = itemType.ql('CURRENT', filter);
        return "LENGTH(".concat(path, "[* FILTER ").concat(itemQl, "]) > 0");
      },
      test: function test(value, filter) {
        var succeededIndex = value.findIndex(function (x) {
          return itemType.test(x, filter);
        });
        return succeededIndex >= 0;
      }
    }
  };
  return {
    ql: function ql(path, filter) {
      return qlFields(path, filter, ops, function (op, path, filterKey, filterValue) {
        return op.ql(path, filterValue);
      });
    },
    test: function test(value, filter) {
      if (!value) {
        return false;
      }

      return testFields(value, filter, ops, function (op, value, filterKey, filterValue) {
        return op.test(value, filterValue);
      });
    }
  };
} // Joins


function join(onField, refCollection, refType) {
  return {
    ql: function ql(path, filter) {
      var on_path = path.split('.').slice(0, -1).concat(onField).join('.');
      var alias = "".concat(on_path.replace('.', '_'));
      var refQl = refType.ql(alias, filter);
      return "\n                LENGTH(\n                    FOR ".concat(alias, " IN ").concat(refCollection, " \n                    FILTER (").concat(alias, "._key == ").concat(on_path, ") AND (").concat(refQl, ")\n                    LIMIT 1\n                    RETURN 1\n                ) > 0");
    },
    test: refType.test
  };
}

function joinArray(onField, refCollection, refType) {
  return {
    ql: function ql(path, filter) {
      var refFilter = filter.all || filter.any;
      var all = !!filter.all;
      var on_path = path.split('.').slice(0, -1).concat(onField).join('.');
      var alias = "".concat(on_path.replace('.', '_'));
      var refQl = refType.ql(alias, refFilter);
      return "\n                (LENGTH(".concat(on_path, ") > 0)\n                AND (LENGTH(\n                    FOR ").concat(alias, " IN ").concat(refCollection, " \n                    FILTER (").concat(alias, "._key IN ").concat(on_path, ") AND (").concat(refQl, ")\n                    ").concat(!all ? 'LIMIT 1' : '', "\n                    RETURN 1\n                ) ").concat(all ? "== LENGTH(".concat(on_path, ")") : '> 0', ")");
    },
    test: refType.test
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28tdHlwZXMuanMiXSwibmFtZXMiOlsicWxGaWVsZHMiLCJwYXRoIiwiZmlsdGVyIiwiZmllbGRUeXBlcyIsInFsRmllbGQiLCJjb25kaXRpb25zIiwiT2JqZWN0IiwiZW50cmllcyIsImZvckVhY2giLCJmaWx0ZXJLZXkiLCJmaWx0ZXJWYWx1ZSIsImZpZWxkVHlwZSIsInB1c2giLCJxbENvbWJpbmUiLCJ0ZXN0RmllbGRzIiwidmFsdWUiLCJ0ZXN0RmllbGQiLCJmYWlsZWQiLCJmaW5kIiwiY29tYmluZSIsImtleSIsInFsT3AiLCJvcCIsIkpTT04iLCJzdHJpbmdpZnkiLCJkZWZhdWx0Q29uZGl0aW9ucyIsImxlbmd0aCIsImpvaW4iLCJxbEluIiwibWFwIiwic2NhbGFyRXEiLCJxbCIsInRlc3QiLCJzY2FsYXJOZSIsInNjYWxhckx0Iiwic2NhbGFyTGUiLCJzY2FsYXJHdCIsInNjYWxhckdlIiwic2NhbGFySW4iLCJpbmNsdWRlcyIsInNjYWxhck5vdEluIiwiY3JlYXRlU2NhbGFyIiwiZmllbGRzIiwiZXEiLCJuZSIsImx0IiwibGUiLCJndCIsImdlIiwibm90SW4iLCJzY2FsYXIiLCJzdHJ1Y3QiLCJpc0NvbGxlY3Rpb24iLCJmaWVsZE5hbWUiLCJhcnJheSIsIml0ZW1UeXBlIiwib3BzIiwiYWxsIiwiaXRlbVFsIiwiZmFpbGVkSW5kZXgiLCJmaW5kSW5kZXgiLCJ4IiwiYW55Iiwic3VjY2VlZGVkSW5kZXgiLCJvbkZpZWxkIiwicmVmQ29sbGVjdGlvbiIsInJlZlR5cGUiLCJvbl9wYXRoIiwic3BsaXQiLCJzbGljZSIsImNvbmNhdCIsImFsaWFzIiwicmVwbGFjZSIsInJlZlFsIiwiam9pbkFycmF5IiwicmVmRmlsdGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7O0FBcUJBLFNBQVNBLFFBQVQsQ0FDSUMsSUFESixFQUVJQyxNQUZKLEVBR0lDLFVBSEosRUFJSUMsT0FK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QUFNLENBQUN1RCxHQUFQLElBQWN2RCxNQUFNLENBQUM0RCxHQUF2QztBQUNBLFVBQU1MLEdBQUcsR0FBRyxDQUFDLENBQUN2RCxNQUFNLENBQUN1RCxHQUFyQjtBQUNBLFVBQU1VLE9BQU8sR0FBR2xFLElBQUksQ0FBQ21FLEtBQUwsQ0FBVyxHQUFYLEVBQWdCQyxLQUFoQixDQUFzQixDQUF0QixFQUF5QixDQUFDLENBQTFCLEVBQTZCQyxNQUE3QixDQUFvQ04sT0FBcEMsRUFBNkNyQyxJQUE3QyxDQUFrRCxHQUFsRCxDQUFoQjtBQUNBLFVBQU00QyxLQUFLLGFBQU1KLE9BQU8sQ0FBQ0ssT0FBUixDQUFnQixHQUFoQixFQUFxQixHQUFyQixDQUFOLENBQVg7QUFDQSxVQUFNQyxLQUFLLEdBQUdQLE9BQU8sQ0FBQ25DLEVBQVIsQ0FBV3dDLEtBQVgsRUFBa0JJLFNBQWxCLENBQWQ7QUFDQSxpREFDY1IsT0FEZCwyRUFHY0ksS0FIZCxpQkFHMEJOLGFBSDFCLDRDQUlrQk0sS0FKbEIsc0JBSW1DSixPQUpuQyxvQkFJb0RNLEtBSnBELG9DQUtVLENBQUNoQixHQUFELEdBQU8sU0FBUCxHQUFtQixFQUw3QiwrREFPUUEsR0FBRyx1QkFBZ0JVLE9BQWhCLFNBQTZCLEtBUHhDO0FBUUgsS0FmRTtBQWdCSG5DLElBQUFBLElBQUksRUFBRWtDLE9BQU8sQ0FBQ2xDO0FBaEJYLEdBQVA7QUFrQkgiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDE5IFRPTiBERVYgU09MVVRJT05TIExURC5cclxuICpcclxuICogTGljZW5zZWQgdW5kZXIgdGhlIFNPRlRXQVJFIEVWQUxVQVRJT04gTGljZW5zZSAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heSBub3QgdXNlXHJcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxyXG4gKiBMaWNlbnNlIGF0OlxyXG4gKlxyXG4gKiBodHRwOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcclxuICpcclxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBUT04gREVWIHNvZnR3YXJlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXHJcbiAqL1xyXG5cclxudHlwZSBRVHlwZSA9IHtcclxuICAgIHFsOiAocGF0aDogc3RyaW5nLCBmaWx0ZXI6IGFueSkgPT4gc3RyaW5nLFxyXG4gICAgdGVzdDogKHZhbHVlOiBhbnksIGZpbHRlcjogYW55KSA9PiBib29sZWFuLFxyXG59XHJcblxyXG5mdW5jdGlvbiBxbEZpZWxkcyhcclxuICAgIHBhdGg6IHN0cmluZyxcclxuICAgIGZpbHRlcjogYW55LFxyXG4gICAgZmllbGRUeXBlczogeyBbc3RyaW5nXTogUVR5cGUgfSxcclxuICAgIHFsRmllbGQ6IChmaWVsZDogYW55LCBwYXRoOiBzdHJpbmcsIGZpbHRlcktleTogc3RyaW5nLCBmaWx0ZXJWYWx1ZTogYW55KSA9PiBzdHJpbmdcclxuKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGNvbmRpdGlvbnM6IHN0cmluZ1tdID0gW107XHJcbiAgICBPYmplY3QuZW50cmllcyhmaWx0ZXIpLmZvckVhY2goKFtmaWx0ZXJLZXksIGZpbHRlclZhbHVlXSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IGZpZWxkVHlwZXNbZmlsdGVyS2V5XTtcclxuICAgICAgICBpZiAoZmllbGRUeXBlKSB7XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbnMucHVzaChxbEZpZWxkKGZpZWxkVHlwZSwgcGF0aCwgZmlsdGVyS2V5LCBmaWx0ZXJWYWx1ZSkpXHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcWxDb21iaW5lKGNvbmRpdGlvbnMsICdBTkQnLCAnZmFsc2UnKTtcclxufVxyXG5cclxuZnVuY3Rpb24gdGVzdEZpZWxkcyhcclxuICAgIHZhbHVlOiBhbnksXHJcbiAgICBmaWx0ZXI6IGFueSxcclxuICAgIGZpZWxkVHlwZXM6IHsgW3N0cmluZ106IFFUeXBlIH0sXHJcbiAgICB0ZXN0RmllbGQ6IChmaWVsZFR5cGU6IGFueSwgdmFsdWU6IGFueSwgZmlsdGVyS2V5OiBzdHJpbmcsIGZpbHRlclZhbHVlOiBhbnkpID0+IGJvb2xlYW5cclxuKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBmYWlsZWQgPSBPYmplY3QuZW50cmllcyhmaWx0ZXIpLmZpbmQoKFtmaWx0ZXJLZXksIGZpbHRlclZhbHVlXSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IGZpZWxkVHlwZXNbZmlsdGVyS2V5XTtcclxuICAgICAgICByZXR1cm4gISEoZmllbGRUeXBlICYmIHRlc3RGaWVsZChmaWVsZFR5cGUsIHZhbHVlLCBmaWx0ZXJLZXksIGZpbHRlclZhbHVlKSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiAhZmFpbGVkO1xyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gY29tYmluZShwYXRoOiBzdHJpbmcsIGtleTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBrZXkgIT09ICcnID8gYCR7cGF0aH0uJHtrZXl9YCA6IHBhdGg7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHFsT3AocGF0aDogc3RyaW5nLCBvcDogc3RyaW5nLCBmaWx0ZXI6IGFueSk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gYCR7cGF0aH0gJHtvcH0gJHtKU09OLnN0cmluZ2lmeShmaWx0ZXIpfWA7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHFsQ29tYmluZShjb25kaXRpb25zOiBzdHJpbmdbXSwgb3A6IHN0cmluZywgZGVmYXVsdENvbmRpdGlvbnM6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBpZiAoY29uZGl0aW9ucy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICByZXR1cm4gZGVmYXVsdENvbmRpdGlvbnM7XHJcbiAgICB9XHJcbiAgICBpZiAoY29uZGl0aW9ucy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICByZXR1cm4gY29uZGl0aW9uc1swXTtcclxuICAgIH1cclxuICAgIHJldHVybiAnKCcgKyBjb25kaXRpb25zLmpvaW4oYCkgJHtvcH0gKGApICsgJyknO1xyXG59XHJcblxyXG5mdW5jdGlvbiBxbEluKHBhdGg6IHN0cmluZywgZmlsdGVyOiBhbnkpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgY29uZGl0aW9ucyA9IGZpbHRlci5tYXAodmFsdWUgPT4gcWxPcChwYXRoLCAnPT0nLCB2YWx1ZSkpO1xyXG4gICAgcmV0dXJuIHFsQ29tYmluZShjb25kaXRpb25zLCAnT1InLCAnZmFsc2UnKTtcclxufVxyXG5cclxuLy8gU2NhbGFyc1xyXG5cclxuY29uc3Qgc2NhbGFyRXE6IFFUeXBlID0ge1xyXG4gICAgcWwocGF0aCwgZmlsdGVyKSB7XHJcbiAgICAgICAgcmV0dXJuIHFsT3AocGF0aCwgJz09JywgZmlsdGVyKTtcclxuICAgIH0sXHJcbiAgICB0ZXN0KHZhbHVlLCBmaWx0ZXIpIHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgPT09IGZpbHRlcjtcclxuICAgIH0sXHJcbn07XHJcblxyXG5jb25zdCBzY2FsYXJOZTogUVR5cGUgPSB7XHJcbiAgICBxbChwYXRoLCBmaWx0ZXIpIHtcclxuICAgICAgICByZXR1cm4gcWxPcChwYXRoLCAnIT0nLCBmaWx0ZXIpO1xyXG4gICAgfSxcclxuICAgIHRlc3QodmFsdWUsIGZpbHRlcikge1xyXG4gICAgICAgIHJldHVybiB2YWx1ZSAhPT0gZmlsdGVyO1xyXG4gICAgfSxcclxufTtcclxuXHJcbmNvbnN0IHNjYWxhckx0OiBRVHlwZSA9IHtcclxuICAgIHFsKHBhdGgsIGZpbHRlcikge1xyXG4gICAgICAgIHJldHVybiBxbE9wKHBhdGgsICc8JywgZmlsdGVyKTtcclxuICAgIH0sXHJcbiAgICB0ZXN0KHZhbHVlLCBmaWx0ZXIpIHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgPCBmaWx0ZXI7XHJcbiAgICB9LFxyXG59O1xyXG5cclxuY29uc3Qgc2NhbGFyTGU6IFFUeXBlID0ge1xyXG4gICAgcWwocGF0aCwgZmlsdGVyKSB7XHJcbiAgICAgICAgcmV0dXJuIHFsT3AocGF0aCwgJzw9JywgZmlsdGVyKTtcclxuICAgIH0sXHJcbiAgICB0ZXN0KHZhbHVlLCBmaWx0ZXIpIHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgPD0gZmlsdGVyO1xyXG4gICAgfSxcclxufTtcclxuXHJcbmNvbnN0IHNjYWxhckd0OiBRVHlwZSA9IHtcclxuICAgIHFsKHBhdGgsIGZpbHRlcikge1xyXG4gICAgICAgIHJldHVybiBxbE9wKHBhdGgsICc+JywgZmlsdGVyKTtcclxuICAgIH0sXHJcbiAgICB0ZXN0KHZhbHVlLCBmaWx0ZXIpIHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgPiBmaWx0ZXI7XHJcbiAgICB9LFxyXG59O1xyXG5cclxuY29uc3Qgc2NhbGFyR2U6IFFUeXBlID0ge1xyXG4gICAgcWwocGF0aCwgZmlsdGVyKSB7XHJcbiAgICAgICAgcmV0dXJuIHFsT3AocGF0aCwgJz49JywgZmlsdGVyKTtcclxuICAgIH0sXHJcbiAgICB0ZXN0KHZhbHVlLCBmaWx0ZXIpIHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgPj0gZmlsdGVyO1xyXG4gICAgfSxcclxufTtcclxuXHJcbmNvbnN0IHNjYWxhckluOiBRVHlwZSA9IHtcclxuICAgIHFsKHBhdGgsIGZpbHRlcikge1xyXG4gICAgICAgIHJldHVybiBxbEluKHBhdGgsIGZpbHRlcik7XHJcbiAgICB9LFxyXG4gICAgdGVzdCh2YWx1ZSwgZmlsdGVyKSB7XHJcbiAgICAgICAgcmV0dXJuIGZpbHRlci5pbmNsdWRlcyh2YWx1ZSk7XHJcbiAgICB9LFxyXG59O1xyXG5cclxuY29uc3Qgc2NhbGFyTm90SW46IFFUeXBlID0ge1xyXG4gICAgcWwocGF0aCwgZmlsdGVyKSB7XHJcbiAgICAgICAgcmV0dXJuIGBOT1QgKCR7cWxJbihwYXRoLCBmaWx0ZXIpfSlgO1xyXG4gICAgfSxcclxuICAgIHRlc3QodmFsdWUsIGZpbHRlcikge1xyXG4gICAgICAgIHJldHVybiAhZmlsdGVyLmluY2x1ZGVzKHZhbHVlKTtcclxuICAgIH1cclxufTtcclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVNjYWxhcigpOiBRVHlwZSB7XHJcbiAgICBjb25zdCBmaWVsZHMgPSB7XHJcbiAgICAgICAgZXE6IHNjYWxhckVxLFxyXG4gICAgICAgIG5lOiBzY2FsYXJOZSxcclxuICAgICAgICBsdDogc2NhbGFyTHQsXHJcbiAgICAgICAgbGU6IHNjYWxhckxlLFxyXG4gICAgICAgIGd0OiBzY2FsYXJHdCxcclxuICAgICAgICBnZTogc2NhbGFyR2UsXHJcbiAgICAgICAgaW46IHNjYWxhckluLFxyXG4gICAgICAgIG5vdEluOiBzY2FsYXJOb3RJbixcclxuICAgIH07XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHFsKHBhdGgsIGZpbHRlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gcWxGaWVsZHMocGF0aCwgZmlsdGVyLCBmaWVsZHMsIChvcCwgcGF0aCwgZmlsdGVyS2V5LCBmaWx0ZXJWYWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9wLnFsKHBhdGgsIGZpbHRlclZhbHVlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB0ZXN0KHZhbHVlLCBmaWx0ZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRlc3RGaWVsZHModmFsdWUsIGZpbHRlciwgZmllbGRzLCAob3AsIHZhbHVlLCBmaWx0ZXJLZXksIGZpbHRlclZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3AudGVzdCh2YWx1ZSwgZmlsdGVyVmFsdWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59XHJcblxyXG5jb25zdCBzY2FsYXI6IFFUeXBlID0gY3JlYXRlU2NhbGFyKCk7XHJcblxyXG4vLyBTdHJ1Y3RzXHJcblxyXG5mdW5jdGlvbiBzdHJ1Y3QoZmllbGRzOiB7IFtzdHJpbmddOiBRVHlwZSB9LCBpc0NvbGxlY3Rpb24/OiBib29sZWFuKTogUVR5cGUge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBxbChwYXRoLCBmaWx0ZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHFsRmllbGRzKHBhdGgsIGZpbHRlciwgZmllbGRzLCAoZmllbGRUeXBlLCBwYXRoLCBmaWx0ZXJLZXksIGZpbHRlclZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmaWVsZE5hbWUgPSBpc0NvbGxlY3Rpb24gJiYgKGZpbHRlcktleSA9PT0gJ2lkJykgPyAnX2tleScgOiBmaWx0ZXJLZXk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmllbGRUeXBlLnFsKGNvbWJpbmUocGF0aCwgZmllbGROYW1lKSwgZmlsdGVyVmFsdWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHRlc3QodmFsdWUsIGZpbHRlcikge1xyXG4gICAgICAgICAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRlc3RGaWVsZHModmFsdWUsIGZpbHRlciwgZmllbGRzLCAoZmllbGRUeXBlLCB2YWx1ZSwgZmlsdGVyS2V5LCBmaWx0ZXJWYWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmllbGROYW1lID0gaXNDb2xsZWN0aW9uICYmIChmaWx0ZXJLZXkgPT09ICdpZCcpID8gJ19rZXknIDogZmlsdGVyS2V5O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkVHlwZS50ZXN0KHZhbHVlW2ZpZWxkTmFtZV0sIGZpbHRlclZhbHVlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG4vLyBBcnJheXNcclxuXHJcbmZ1bmN0aW9uIGFycmF5KGl0ZW1UeXBlOiBRVHlwZSk6IFFUeXBlIHtcclxuICAgIGNvbnN0IG9wcyA9IHtcclxuICAgICAgICBhbGw6IHtcclxuICAgICAgICAgICAgcWwocGF0aCwgZmlsdGVyKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtUWwgPSBpdGVtVHlwZS5xbCgnQ1VSUkVOVCcsIGZpbHRlcik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYExFTkdUSCgke3BhdGh9WyogRklMVEVSICR7aXRlbVFsfV0pID09IExFTkdUSCgke3BhdGh9KWA7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHRlc3QodmFsdWUsIGZpbHRlcikge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmFpbGVkSW5kZXggPSB2YWx1ZS5maW5kSW5kZXgoeCA9PiAhaXRlbVR5cGUudGVzdCh4LCBmaWx0ZXIpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWlsZWRJbmRleCA8IDA7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgICBhbnk6IHtcclxuICAgICAgICAgICAgcWwocGF0aCwgZmlsdGVyKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtUWwgPSBpdGVtVHlwZS5xbCgnQ1VSUkVOVCcsIGZpbHRlcik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYExFTkdUSCgke3BhdGh9WyogRklMVEVSICR7aXRlbVFsfV0pID4gMGA7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHRlc3QodmFsdWUsIGZpbHRlcikge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3VjY2VlZGVkSW5kZXggPSB2YWx1ZS5maW5kSW5kZXgoeCA9PiBpdGVtVHlwZS50ZXN0KHgsIGZpbHRlcikpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN1Y2NlZWRlZEluZGV4ID49IDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgfTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgcWwocGF0aCwgZmlsdGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBxbEZpZWxkcyhwYXRoLCBmaWx0ZXIsIG9wcywgKG9wLCBwYXRoLCBmaWx0ZXJLZXksIGZpbHRlclZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3AucWwocGF0aCwgZmlsdGVyVmFsdWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHRlc3QodmFsdWUsIGZpbHRlcikge1xyXG4gICAgICAgICAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRlc3RGaWVsZHModmFsdWUsIGZpbHRlciwgb3BzLCAob3AsIHZhbHVlLCBmaWx0ZXJLZXksIGZpbHRlclZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3AudGVzdCh2YWx1ZSwgZmlsdGVyVmFsdWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIEpvaW5zXHJcblxyXG5mdW5jdGlvbiBqb2luKG9uRmllbGQ6IHN0cmluZywgcmVmQ29sbGVjdGlvbjogc3RyaW5nLCByZWZUeXBlOiBRVHlwZSk6IFFUeXBlIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgcWwocGF0aCwgZmlsdGVyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9uX3BhdGggPSBwYXRoLnNwbGl0KCcuJykuc2xpY2UoMCwgLTEpLmNvbmNhdChvbkZpZWxkKS5qb2luKCcuJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFsaWFzID0gYCR7b25fcGF0aC5yZXBsYWNlKCcuJywgJ18nKX1gO1xyXG4gICAgICAgICAgICBjb25zdCByZWZRbCA9IHJlZlR5cGUucWwoYWxpYXMsIGZpbHRlcik7XHJcbiAgICAgICAgICAgIHJldHVybiBgXHJcbiAgICAgICAgICAgICAgICBMRU5HVEgoXHJcbiAgICAgICAgICAgICAgICAgICAgRk9SICR7YWxpYXN9IElOICR7cmVmQ29sbGVjdGlvbn0gXHJcbiAgICAgICAgICAgICAgICAgICAgRklMVEVSICgke2FsaWFzfS5fa2V5ID09ICR7b25fcGF0aH0pIEFORCAoJHtyZWZRbH0pXHJcbiAgICAgICAgICAgICAgICAgICAgTElNSVQgMVxyXG4gICAgICAgICAgICAgICAgICAgIFJFVFVSTiAxXHJcbiAgICAgICAgICAgICAgICApID4gMGA7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB0ZXN0OiByZWZUeXBlLnRlc3QsXHJcbiAgICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBqb2luQXJyYXkob25GaWVsZDogc3RyaW5nLCByZWZDb2xsZWN0aW9uOiBzdHJpbmcsIHJlZlR5cGU6IFFUeXBlKTogUVR5cGUge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBxbChwYXRoLCBmaWx0ZXIpIHtcclxuICAgICAgICAgICAgY29uc3QgcmVmRmlsdGVyID0gZmlsdGVyLmFsbCB8fCBmaWx0ZXIuYW55O1xyXG4gICAgICAgICAgICBjb25zdCBhbGwgPSAhIWZpbHRlci5hbGw7XHJcbiAgICAgICAgICAgIGNvbnN0IG9uX3BhdGggPSBwYXRoLnNwbGl0KCcuJykuc2xpY2UoMCwgLTEpLmNvbmNhdChvbkZpZWxkKS5qb2luKCcuJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFsaWFzID0gYCR7b25fcGF0aC5yZXBsYWNlKCcuJywgJ18nKX1gO1xyXG4gICAgICAgICAgICBjb25zdCByZWZRbCA9IHJlZlR5cGUucWwoYWxpYXMsIHJlZkZpbHRlcik7XHJcbiAgICAgICAgICAgIHJldHVybiBgXHJcbiAgICAgICAgICAgICAgICAoTEVOR1RIKCR7b25fcGF0aH0pID4gMClcclxuICAgICAgICAgICAgICAgIEFORCAoTEVOR1RIKFxyXG4gICAgICAgICAgICAgICAgICAgIEZPUiAke2FsaWFzfSBJTiAke3JlZkNvbGxlY3Rpb259IFxyXG4gICAgICAgICAgICAgICAgICAgIEZJTFRFUiAoJHthbGlhc30uX2tleSBJTiAke29uX3BhdGh9KSBBTkQgKCR7cmVmUWx9KVxyXG4gICAgICAgICAgICAgICAgICAgICR7IWFsbCA/ICdMSU1JVCAxJyA6ICcnfVxyXG4gICAgICAgICAgICAgICAgICAgIFJFVFVSTiAxXHJcbiAgICAgICAgICAgICAgICApICR7YWxsID8gYD09IExFTkdUSCgke29uX3BhdGh9KWAgOiAnPiAwJ30pYDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHRlc3Q6IHJlZlR5cGUudGVzdCxcclxuICAgIH07XHJcbn1cclxuXHJcbmV4cG9ydCB7XHJcbiAgICBzY2FsYXIsXHJcbiAgICBzdHJ1Y3QsXHJcbiAgICBhcnJheSxcclxuICAgIGpvaW4sXHJcbiAgICBqb2luQXJyYXlcclxufVxyXG5cclxuZXhwb3J0IHR5cGUge1xyXG4gICAgUVR5cGVcclxufVxyXG5cclxuIl19