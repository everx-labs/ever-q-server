"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.u8enum = u8enum;
exports.isBigInt = isBigInt;
exports.unresolvedType = unresolvedType;
exports.toEnumStyle = toEnumStyle;
exports.stringifyEnumValues = stringifyEnumValues;
exports.getDocMD = getDocMD;
exports.parseDbSchema = parseDbSchema;
exports.scalarTypes = exports.DbTypeCategory = exports.otherCurrencyCollection = exports.OtherCurrency = exports.grams = exports.unixSeconds = exports.u32WithFormatter = exports.u128 = exports.u64 = exports.u32 = exports.u16 = exports.u8 = exports.i32 = exports.i8 = exports.required = exports.withDoc = exports.join = void 0;

var _gen = require("./gen.js");

var _schema = require("./schema.js");

const {
  ref,
  arrayOf
} = _schema.Def;
const ToStringFormatter = {
  unixMillisecondsToString: 'unixMillisecondsToString',
  unixSecondsToString: 'unixSecondsToString'
};

const join = (refDef, on, refOn, preCondition) => {
  return { ...ref(refDef),
    _: {
      join: {
        on,
        refOn,
        preCondition: preCondition || ''
      }
    }
  };
};

exports.join = join;

const withDoc = (def, doc) => ({ ...def,
  ...(doc ? {
    _doc: doc
  } : {})
});

exports.withDoc = withDoc;

const required = def => def;

exports.required = required;

const uint = (size, doc) => withDoc({
  _int: {
    unsigned: true,
    size
  }
}, doc);

const int = (size, doc) => withDoc({
  _int: {
    unsigned: false,
    size
  }
}, doc);

const i8 = doc => int(8, doc);

exports.i8 = i8;

const i32 = doc => int(32, doc);

exports.i32 = i32;

const u8 = doc => uint(8, doc);

exports.u8 = u8;

const u16 = doc => uint(16, doc);

exports.u16 = u16;

const u32 = doc => uint(32, doc);

exports.u32 = u32;

const u64 = doc => uint(64, doc);

exports.u64 = u64;

const u128 = doc => uint(128, doc);

exports.u128 = u128;

const u256 = doc => uint(256, doc);

const u32WithFormatter = (formatter, doc) => withDoc({
  _int: {
    unsigned: true,
    size: 32
  },
  _: {
    formatter
  }
}, doc);

exports.u32WithFormatter = u32WithFormatter;

const unixSeconds = doc => u32WithFormatter(ToStringFormatter.unixSecondsToString, doc);

exports.unixSeconds = unixSeconds;
const grams = u128;
exports.grams = grams;

function u8enum(name, values) {
  return doc => {
    const valuesDoc = Object.entries(values).map(([name, value]) => {
      return `- ${value} â€“ ${name}`;
    }).join('\n');
    const effectiveDoc = `${doc ? `${doc}\n` : ''}${valuesDoc}`;
    return withDoc({
      _int: {
        unsigned: true,
        size: 8
      },
      _: {
        enum: {
          name,
          values
        }
      }
    }, effectiveDoc);
  };
}

const OtherCurrency = {
  currency: u32(),
  value: u256()
};
exports.OtherCurrency = OtherCurrency;

const otherCurrencyCollection = doc => arrayOf(ref({
  OtherCurrency
}), doc);

exports.otherCurrencyCollection = otherCurrencyCollection;
const DbTypeCategory = {
  unresolved: 'unresolved',
  scalar: 'scalar',
  union: 'union',
  struct: 'struct'
};
exports.DbTypeCategory = DbTypeCategory;

function scalarType(name) {
  return {
    name,
    category: DbTypeCategory.scalar,
    fields: [],
    doc: ''
  };
}

const scalarTypes = {
  int: scalarType('Int'),
  uint64: scalarType('String'),
  uint1024: scalarType('String'),
  float: scalarType('Float'),
  boolean: scalarType('Boolean'),
  string: scalarType('String')
};
exports.scalarTypes = scalarTypes;

function isBigInt(type) {
  return type === scalarTypes.uint1024 || type === scalarTypes.uint64;
}

function unresolvedType(name) {
  return {
    name,
    category: DbTypeCategory.unresolved,
    fields: [],
    doc: ''
  };
}

function toEnumStyle(s) {
  return `${s.substr(0, 1).toUpperCase()}${s.substr(1)}`;
}

function stringifyEnumValues(values) {
  const fields = Object.entries(values).map(([name, value]) => {
    return `${toEnumStyle(name)}: ${value}`;
  });
  return `{ ${fields.join(', ')} }`;
}

function getDocMD(schema) {
  const doc = schema.doc;

  if (!doc) {
    return '';
  }

  if (typeof doc === 'string') {
    return doc;
  }

  if (doc.md) {
    return doc.md;
  }

  return '';
}

function parseDbSchema(schemaDef) {
  const dbTypes = [];
  const enumTypes = new Map();

  function parseDbField(typeName, schemaField) {
    let schemaType = schemaField;
    const field = {
      name: schemaField.name,
      arrayDepth: 0,
      type: scalarTypes.string,
      doc: getDocMD(schemaField)
    };

    while (schemaType.array) {
      field.arrayDepth += 1;
      schemaType = schemaType.array;
    }

    const ex = schemaType._;
    const enumDef = ex && ex.enum || null;

    if (enumDef) {
      field.enumDef = enumDef;
      enumTypes.set(enumDef.name, enumDef);
    }

    const join = ex && ex.join;

    if (join) {
      field.join = join;
    }

    if (ex && ex.formatter) {
      field.formatter = ex.formatter;
    }

    if (schemaType.union || schemaType.struct) {
      field.type = unresolvedType((0, _gen.makeFieldTypeName)(typeName, schemaField.name));
    } else if (schemaType.ref) {
      field.type = unresolvedType(schemaType.ref.name);
    } else if (schemaType.bool) {
      field.type = scalarTypes.boolean;
    } else if (schemaType.int) {
      const unsigned = schemaType.int && schemaType.int.unsigned || false;
      const size = schemaType.int && schemaType.int.size || 32;

      if (unsigned) {
        if (size >= 128) {
          field.type = scalarTypes.uint1024;
        } else if (size >= 64) {
          field.type = scalarTypes.uint64;
        } else if (size >= 32) {
          field.type = scalarTypes.float;
        } else {
          field.type = scalarTypes.int;
        }
      } else {
        if (size > 32) {
          throw new Error(`Integer type with size ${size} bit does not supported`);
        } else {
          field.type = scalarTypes.int;
        }
      }
    } else if (schemaType.float) {
      field.type = scalarTypes.float;
    } else if (schemaType.string) {
      field.type = scalarTypes.string;
    } else {
      field.type = scalarTypes.string;
      console.log('Invalid field type: ', JSON.stringify(schemaType));
      process.exit(1);
    }

    return field;
  }

  function unwrapArrays(type) {
    if (type.array) {
      return unwrapArrays(type.array);
    }

    return type;
  }

  function parseDbType(name, schemaType) {
    const struct = schemaType.union || schemaType.struct;

    if (!struct) {
      console.log(`?? ${name}: ${JSON.stringify(schemaType).substr(0, 200)}`);
      return;
    }

    const type = {
      name,
      category: schemaType.union ? DbTypeCategory.union : DbTypeCategory.struct,
      fields: [],
      collection: schemaType._.collection,
      doc: getDocMD(schemaType)
    };

    if (type.collection) {
      type.fields.push({
        name: 'id',
        arrayDepth: 0,
        type: scalarTypes.string,
        doc: ''
      });
    }

    struct.forEach(field => {
      type.fields.push(parseDbField(name, field));
      const unwrapped = unwrapArrays(field);
      const ownType = unwrapped.struct || unwrapped.union ? unwrapped : null;

      if (ownType) {
        parseDbType((0, _gen.makeFieldTypeName)(name, field.name), ownType);
      }
    });
    dbTypes.push(type);
  }

  const schema = (0, _schema.parseTypeDef)(schemaDef);

  if (schema.class) {
    schema.class.types.forEach(type => {
      parseDbType(type.name, type);
    });
  }

  const unresolved = new Map();
  const resolving = new Set();
  const resolved = new Map();
  const orderedResolved = [];
  dbTypes.forEach(t => unresolved.set(t.name, t));

  const resolveType = type => {
    if (resolved.has(type.name)) {
      return;
    }

    if (resolving.has(type.name)) {
      console.log(`WARNING: Circular reference to type ${type.name}`);
      return;
    }

    resolving.add(type.name);
    type.fields.forEach(field => {
      if (field.type.category === DbTypeCategory.unresolved) {
        let type = resolved.get(field.type.name);

        if (!type) {
          type = unresolved.get(field.type.name);

          if (type) {
            resolveType(type);
          } else {
            console.log(`Referenced type not found: ${field.type.name}`);
            process.exit(1);
          }
        }

        if (type) {
          field.type = type;
        }
      }
    });
    resolving.delete(type.name);
    orderedResolved.push(type);
    unresolved.delete(type.name);
    resolved.set(type.name, type);
  };

  dbTypes.forEach(resolveType);
  return {
    types: orderedResolved,
    enumTypes
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9zY2hlbWEvZGItc2NoZW1hLXR5cGVzLmpzIl0sIm5hbWVzIjpbInJlZiIsImFycmF5T2YiLCJEZWYiLCJUb1N0cmluZ0Zvcm1hdHRlciIsInVuaXhNaWxsaXNlY29uZHNUb1N0cmluZyIsInVuaXhTZWNvbmRzVG9TdHJpbmciLCJqb2luIiwicmVmRGVmIiwib24iLCJyZWZPbiIsInByZUNvbmRpdGlvbiIsIl8iLCJ3aXRoRG9jIiwiZGVmIiwiZG9jIiwiX2RvYyIsInJlcXVpcmVkIiwidWludCIsInNpemUiLCJfaW50IiwidW5zaWduZWQiLCJpbnQiLCJpOCIsImkzMiIsInU4IiwidTE2IiwidTMyIiwidTY0IiwidTEyOCIsInUyNTYiLCJ1MzJXaXRoRm9ybWF0dGVyIiwiZm9ybWF0dGVyIiwidW5peFNlY29uZHMiLCJncmFtcyIsInU4ZW51bSIsIm5hbWUiLCJ2YWx1ZXMiLCJ2YWx1ZXNEb2MiLCJPYmplY3QiLCJlbnRyaWVzIiwibWFwIiwidmFsdWUiLCJlZmZlY3RpdmVEb2MiLCJlbnVtIiwiT3RoZXJDdXJyZW5jeSIsImN1cnJlbmN5Iiwib3RoZXJDdXJyZW5jeUNvbGxlY3Rpb24iLCJEYlR5cGVDYXRlZ29yeSIsInVucmVzb2x2ZWQiLCJzY2FsYXIiLCJ1bmlvbiIsInN0cnVjdCIsInNjYWxhclR5cGUiLCJjYXRlZ29yeSIsImZpZWxkcyIsInNjYWxhclR5cGVzIiwidWludDY0IiwidWludDEwMjQiLCJmbG9hdCIsImJvb2xlYW4iLCJzdHJpbmciLCJpc0JpZ0ludCIsInR5cGUiLCJ1bnJlc29sdmVkVHlwZSIsInRvRW51bVN0eWxlIiwicyIsInN1YnN0ciIsInRvVXBwZXJDYXNlIiwic3RyaW5naWZ5RW51bVZhbHVlcyIsImdldERvY01EIiwic2NoZW1hIiwibWQiLCJwYXJzZURiU2NoZW1hIiwic2NoZW1hRGVmIiwiZGJUeXBlcyIsImVudW1UeXBlcyIsIk1hcCIsInBhcnNlRGJGaWVsZCIsInR5cGVOYW1lIiwic2NoZW1hRmllbGQiLCJzY2hlbWFUeXBlIiwiZmllbGQiLCJhcnJheURlcHRoIiwiYXJyYXkiLCJleCIsImVudW1EZWYiLCJzZXQiLCJib29sIiwiRXJyb3IiLCJjb25zb2xlIiwibG9nIiwiSlNPTiIsInN0cmluZ2lmeSIsInByb2Nlc3MiLCJleGl0IiwidW53cmFwQXJyYXlzIiwicGFyc2VEYlR5cGUiLCJjb2xsZWN0aW9uIiwicHVzaCIsImZvckVhY2giLCJ1bndyYXBwZWQiLCJvd25UeXBlIiwiY2xhc3MiLCJ0eXBlcyIsInJlc29sdmluZyIsIlNldCIsInJlc29sdmVkIiwib3JkZXJlZFJlc29sdmVkIiwidCIsInJlc29sdmVUeXBlIiwiaGFzIiwiYWRkIiwiZ2V0IiwiZGVsZXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUNBOztBQUNBOztBQVNBLE1BQU07QUFBRUEsRUFBQUEsR0FBRjtBQUFPQyxFQUFBQTtBQUFQLElBQW1CQyxXQUF6QjtBQUVBLE1BQU1DLGlCQUFpQixHQUFHO0FBQ3RCQyxFQUFBQSx3QkFBd0IsRUFBRSwwQkFESjtBQUV0QkMsRUFBQUEsbUJBQW1CLEVBQUU7QUFGQyxDQUExQjs7QUFRTyxNQUFNQyxJQUFJLEdBQUcsQ0FDaEJDLE1BRGdCLEVBRWhCQyxFQUZnQixFQUdoQkMsS0FIZ0IsRUFJaEJDLFlBSmdCLEtBS047QUFDVixTQUFPLEVBQ0gsR0FBR1YsR0FBRyxDQUFDTyxNQUFELENBREg7QUFFSEksSUFBQUEsQ0FBQyxFQUFFO0FBQ0NMLE1BQUFBLElBQUksRUFBRTtBQUNGRSxRQUFBQSxFQURFO0FBRUZDLFFBQUFBLEtBRkU7QUFHRkMsUUFBQUEsWUFBWSxFQUFHQSxZQUFZLElBQUk7QUFIN0I7QUFEUDtBQUZBLEdBQVA7QUFVSCxDQWhCTTs7OztBQWtCQSxNQUFNRSxPQUFPLEdBQUcsQ0FBQ0MsR0FBRCxFQUFlQyxHQUFmLE1BQWlDLEVBQ3BELEdBQUdELEdBRGlEO0FBRXBELE1BQUlDLEdBQUcsR0FBRztBQUFFQyxJQUFBQSxJQUFJLEVBQUVEO0FBQVIs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QUNTLE1BQVYsQ0FBaUJuRCxJQUFJLENBQUMzQixJQUF0QjtBQUNBd0UsSUFBQUEsZUFBZSxDQUFDVCxJQUFoQixDQUFxQnBDLElBQXJCO0FBQ0FkLElBQUFBLFVBQVUsQ0FBQ2lFLE1BQVgsQ0FBa0JuRCxJQUFJLENBQUMzQixJQUF2QjtBQUNBdUUsSUFBQUEsUUFBUSxDQUFDcEIsR0FBVCxDQUFheEIsSUFBSSxDQUFDM0IsSUFBbEIsRUFBd0IyQixJQUF4QjtBQUNILEdBOUJEOztBQStCQVksRUFBQUEsT0FBTyxDQUFDeUIsT0FBUixDQUFnQlUsV0FBaEI7QUFDQSxTQUFPO0FBQ0hOLElBQUFBLEtBQUssRUFBRUksZUFESjtBQUVIaEMsSUFBQUE7QUFGRyxHQUFQO0FBSUgiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xyXG5pbXBvcnQge21ha2VGaWVsZFR5cGVOYW1lfSBmcm9tIFwiLi9nZW4uanNcIjtcclxuaW1wb3J0IHtEZWYsIHBhcnNlVHlwZURlZn0gZnJvbSBcIi4vc2NoZW1hLmpzXCI7XHJcbmltcG9ydCB0eXBlIHtcclxuICAgIEludFNpemVUeXBlLFxyXG4gICAgU2NoZW1hRG9jLFxyXG4gICAgU2NoZW1hTWVtYmVyLFxyXG4gICAgU2NoZW1hVHlwZSxcclxuICAgIFR5cGVEZWZcclxufSBmcm9tIFwiLi9zY2hlbWEuanNcIjtcclxuXHJcbmNvbnN0IHsgcmVmLCBhcnJheU9mIH0gPSBEZWY7XHJcblxyXG5jb25zdCBUb1N0cmluZ0Zvcm1hdHRlciA9IHtcclxuICAgIHVuaXhNaWxsaXNlY29uZHNUb1N0cmluZzogJ3VuaXhNaWxsaXNlY29uZHNUb1N0cmluZycsXHJcbiAgICB1bml4U2Vjb25kc1RvU3RyaW5nOiAndW5peFNlY29uZHNUb1N0cmluZycsXHJcblxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBUb1N0cmluZ0Zvcm1hdHRlclR5cGUgPSAkVmFsdWVzPHR5cGVvZiBUb1N0cmluZ0Zvcm1hdHRlcj47XHJcblxyXG5leHBvcnQgY29uc3Qgam9pbiA9IChcclxuICAgIHJlZkRlZjogKHN0cmluZyB8IHsgW3N0cmluZ106IFR5cGVEZWYgfSksXHJcbiAgICBvbjogc3RyaW5nLFxyXG4gICAgcmVmT246IHN0cmluZyxcclxuICAgIHByZUNvbmRpdGlvbj86IHN0cmluZyxcclxuKTogVHlwZURlZiA9PiB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnJlZihyZWZEZWYpLFxyXG4gICAgICAgIF86IHtcclxuICAgICAgICAgICAgam9pbjoge1xyXG4gICAgICAgICAgICAgICAgb24sXHJcbiAgICAgICAgICAgICAgICByZWZPbixcclxuICAgICAgICAgICAgICAgIHByZUNvbmRpdGlvbjogKHByZUNvbmRpdGlvbiB8fCAnJyksXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgIH1cclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCB3aXRoRG9jID0gKGRlZjogVHlwZURlZiwgZG9jPzogc3RyaW5nKSA9PiAoe1xyXG4gICAgLi4uZGVmLFxyXG4gICAgLi4uKGRvYyA/IHsgX2RvYzogZG9jIH0gOiB7fSksXHJcbn0pO1xyXG5cclxuZXhwb3J0IGNvbnN0IHJlcXVpcmVkID0gKGRlZjogVHlwZURlZikgPT4gZGVmO1xyXG5cclxuY29uc3QgdWludCA9IChzaXplOiBJbnRTaXplVHlwZSwgZG9jPzogc3RyaW5nKSA9PiB3aXRoRG9jKHtcclxuICAgIF9pbnQ6IHtcclxuICAgICAgICB1bnNpZ25lZDogdHJ1ZSxcclxuICAgICAgICBzaXplLFxyXG4gICAgfSxcclxufSwgZG9jKTtcclxuXHJcbmNvbnN0IGludCA9IChzaXplOiBJbnRTaXplVHlwZSwgZG9jPzogc3RyaW5nKSA9PiB3aXRoRG9jKHtcclxuICAgIF9pbnQ6IHtcclxuICAgICAgICB1bnNpZ25lZDogZmFsc2UsXHJcbiAgICAgICAgc2l6ZSxcclxuICAgIH0sXHJcbn0sIGRvYyk7XHJcblxyXG5leHBvcnQgY29uc3QgaTggPSAoZG9jPzogc3RyaW5nKSA9PiBpbnQoOCwgZG9jKTtcclxuZXhwb3J0IGNvbnN0IGkzMiA9IChkb2M/OiBzdHJpbmcpID0+IGludCgzMiwgZG9jKTtcclxuZXhwb3J0IGNvbnN0IHU4ID0gKGRvYz86IHN0cmluZykgPT4gdWludCg4LCBkb2MpO1xyXG5leHBvcnQgY29uc3QgdTE2ID0gKGRvYz86IHN0cmluZykgPT4gdWludCgxNiwgZG9jKTtcclxuZXhwb3J0IGNvbnN0IHUzMiA9IChkb2M/OiBzdHJpbmcpID0+IHVpbnQoMzIsIGRvYyk7XHJcbmV4cG9ydCBjb25zdCB1NjQgPSAoZG9jPzogc3RyaW5nKSA9PiB1aW50KDY0LCBkb2MpO1xyXG5leHBvcnQgY29uc3QgdTEyOCA9IChkb2M/OiBzdHJpbmcpID0+IHVpbnQoMTI4LCBkb2MpO1xyXG5jb25zdCB1MjU2ID0gKGRvYz86IHN0cmluZykgPT4gdWludCgyNTYsIGRvYyk7XHJcblxyXG5leHBvcnQgY29uc3QgdTMyV2l0aEZvcm1hdHRlciA9IChmb3JtYXR0ZXI6IFRvU3RyaW5nRm9ybWF0dGVyVHlwZSwgZG9jPzogc3RyaW5nKSA9PiB3aXRoRG9jKHtcclxuICAgIF9pbnQ6IHtcclxuICAgICAgICB1bnNpZ25lZDogdHJ1ZSxcclxuICAgICAgICBzaXplOiAzMixcclxuICAgIH0sXHJcbiAgICBfOiB7XHJcbiAgICAgICAgZm9ybWF0dGVyLFxyXG4gICAgfSxcclxufSwgZG9jKTtcclxuXHJcbmV4cG9ydCBjb25zdCB1bml4U2Vjb25kcyA9IChkb2M/OiBzdHJpbmcpID0+IHUzMldpdGhGb3JtYXR0ZXIoVG9TdHJpbmdGb3JtYXR0ZXIudW5peFNlY29uZHNUb1N0cmluZywgZG9jKTtcclxuXHJcbmV4cG9ydCBjb25zdCBncmFtcyA9IHUxMjg7XHJcblxyXG50eXBlIEludEVudW1WYWx1ZXMgPSB7XHJcbiAgICBbc3RyaW5nXTogbnVtYmVyXHJcbn07XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdThlbnVtKG5hbWU6IHN0cmluZywgdmFsdWVzOiBJbnRFbnVtVmFsdWVzKSB7XHJcbiAgICByZXR1cm4gKGRvYz86IHN0cmluZyk6IFR5cGVEZWYgPT4ge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlc0RvYyA9IE9iamVjdC5lbnRyaWVzKHZhbHVlcykubWFwKChbbmFtZSwgdmFsdWVdKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBgLSAkeyh2YWx1ZTogYW55KX0g4oCTICR7bmFtZX1gO1xyXG4gICAgICAgIH0pLmpvaW4oJ1xcbicpO1xyXG4gICAgICAgIGNvbnN0IGVmZmVjdGl2ZURvYyA9IGAke2RvYyA/IGAke2RvY31cXG5gIDogJyd9JHt2YWx1ZXNEb2N9YDtcclxuICAgICAgICByZXR1cm4gd2l0aERvYyh7XHJcbiAgICAgICAgICAgIF9pbnQ6IHtcclxuICAgICAgICAgICAgICAgIHVuc2lnbmVkOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgc2l6ZTogOCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgXzoge1xyXG4gICAgICAgICAgICAgICAgZW51bToge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LCBlZmZlY3RpdmVEb2MpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY29uc3QgT3RoZXJDdXJyZW5jeTogVHlwZURlZiA9IHtcclxuICAgIGN1cnJlbmN5OiB1MzIoKSxcclxuICAgIHZhbHVlOiB1MjU2KCksXHJcbn07XHJcblxyXG5leHBvcnQgY29uc3Qgb3RoZXJDdXJyZW5jeUNvbGxlY3Rpb24gPSAoZG9jPzogc3RyaW5nKTogVHlwZURlZiA9PiBhcnJheU9mKHJlZih7IE90aGVyQ3VycmVuY3kgfSksIGRvYyk7XHJcbmV4cG9ydCBjb25zdCBEYlR5cGVDYXRlZ29yeSA9IHtcclxuICAgIHVucmVzb2x2ZWQ6ICd1bnJlc29sdmVkJyxcclxuICAgIHNjYWxhcjogJ3NjYWxhcicsXHJcbiAgICB1bmlvbjogJ3VuaW9uJyxcclxuICAgIHN0cnVjdDogJ3N0cnVjdCcsXHJcbn07XHJcbnR5cGUgRGJKb2luID0ge1xyXG4gICAgY29sbGVjdGlvbjogc3RyaW5nLFxyXG4gICAgb246IHN0cmluZyxcclxuICAgIHJlZk9uOiBzdHJpbmcsXHJcbiAgICBwcmVDb25kaXRpb246IHN0cmluZyxcclxufVxyXG5leHBvcnQgdHlwZSBEYlR5cGUgPSB7XHJcbiAgICBuYW1lOiBzdHJpbmcsXHJcbiAgICBmaWVsZHM6IERiRmllbGRbXSxcclxuICAgIGNhdGVnb3J5OiAndW5yZXNvbHZlZCcgfCAnc2NhbGFyJyB8ICd1bmlvbicgfCAnc3RydWN0JyxcclxuICAgIGNvbGxlY3Rpb24/OiBzdHJpbmcsXHJcbiAgICBkb2M6IHN0cmluZyxcclxufVxyXG5leHBvcnQgdHlwZSBJbnRFbnVtRGVmID0ge1xyXG4gICAgbmFtZTogc3RyaW5nLFxyXG4gICAgdmFsdWVzOiB7XHJcbiAgICAgICAgW3N0cmluZ106IG51bWJlclxyXG4gICAgfSxcclxufVxyXG5leHBvcnQgdHlwZSBEYkZpZWxkID0ge1xyXG4gICAgbmFtZTogc3RyaW5nLFxyXG4gICAgdHlwZTogRGJUeXBlLFxyXG4gICAgYXJyYXlEZXB0aDogbnVtYmVyLFxyXG4gICAgam9pbj86IERiSm9pbixcclxuICAgIGVudW1EZWY/OiBJbnRFbnVtRGVmLFxyXG4gICAgZm9ybWF0dGVyPzogVG9TdHJpbmdGb3JtYXR0ZXJUeXBlLFxyXG4gICAgZG9jOiBzdHJpbmcsXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNjYWxhclR5cGUobmFtZTogc3RyaW5nKTogRGJUeXBlIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgbmFtZSxcclxuICAgICAgICBjYXRlZ29yeTogRGJUeXBlQ2F0ZWdvcnkuc2NhbGFyLFxyXG4gICAgICAgIGZpZWxkczogW10sXHJcbiAgICAgICAgZG9jOiAnJyxcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHNjYWxhclR5cGVzID0ge1xyXG4gICAgaW50OiBzY2FsYXJUeXBlKCdJbnQnKSxcclxuICAgIHVpbnQ2NDogc2NhbGFyVHlwZSgnU3RyaW5nJyksXHJcbiAgICB1aW50MTAyNDogc2NhbGFyVHlwZSgnU3RyaW5nJyksXHJcbiAgICBmbG9hdDogc2NhbGFyVHlwZSgnRmxvYXQnKSxcclxuICAgIGJvb2xlYW46IHNjYWxhclR5cGUoJ0Jvb2xlYW4nKSxcclxuICAgIHN0cmluZzogc2NhbGFyVHlwZSgnU3RyaW5nJyksXHJcbn07XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNCaWdJbnQodHlwZTogRGJUeXBlKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdHlwZSA9PT0gc2NhbGFyVHlwZXMudWludDEwMjQgfHwgdHlwZSA9PT0gc2NhbGFyVHlwZXMudWludDY0O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdW5yZXNvbHZlZFR5cGUobmFtZTogc3RyaW5nKTogRGJUeXBlIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgbmFtZSxcclxuICAgICAgICBjYXRlZ29yeTogRGJUeXBlQ2F0ZWdvcnkudW5yZXNvbHZlZCxcclxuICAgICAgICBmaWVsZHM6IFtdLFxyXG4gICAgICAgIGRvYzogJycsXHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0b0VudW1TdHlsZShzOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGAke3Muc3Vic3RyKDAsIDEpLnRvVXBwZXJDYXNlKCl9JHtzLnN1YnN0cigxKX1gO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc3RyaW5naWZ5RW51bVZhbHVlcyh2YWx1ZXM6IHsgW3N0cmluZ106IG51bWJlciB9KTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGZpZWxkcyA9IE9iamVjdC5lbnRyaWVzKHZhbHVlcykubWFwKChbbmFtZSwgdmFsdWVdKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGAke3RvRW51bVN0eWxlKG5hbWUpfTogJHsodmFsdWU6IGFueSl9YDtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGB7ICR7ZmllbGRzLmpvaW4oJywgJyl9IH1gO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RG9jTUQoc2NoZW1hOiBTY2hlbWFEb2MpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgZG9jID0gc2NoZW1hLmRvYztcclxuICAgIGlmICghZG9jKSB7XHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBkb2MgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgcmV0dXJuIGRvYztcclxuICAgIH1cclxuICAgIGlmIChkb2MubWQpIHtcclxuICAgICAgICByZXR1cm4gKGRvYy5tZDogYW55KTtcclxuICAgIH1cclxuICAgIHJldHVybiAnJztcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgRGJTY2hlbWEgPSB7XHJcbiAgICB0eXBlczogRGJUeXBlW10sXHJcbiAgICBlbnVtVHlwZXM6IE1hcDxzdHJpbmcsIEludEVudW1EZWY+LFxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VEYlNjaGVtYShzY2hlbWFEZWY6IFR5cGVEZWYpOiBEYlNjaGVtYSB7XHJcbiAgICBjb25zdCBkYlR5cGVzOiBEYlR5cGVbXSA9IFtdO1xyXG4gICAgY29uc3QgZW51bVR5cGVzOiBNYXA8c3RyaW5nLCBJbnRFbnVtRGVmPiA9IG5ldyBNYXAoKTtcclxuXHJcbiAgICBmdW5jdGlvbiBwYXJzZURiRmllbGQoXHJcbiAgICAgICAgdHlwZU5hbWU6IHN0cmluZyxcclxuICAgICAgICBzY2hlbWFGaWVsZDogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+LFxyXG4gICAgKTogRGJGaWVsZCB7XHJcbiAgICAgICAgbGV0IHNjaGVtYVR5cGUgPSBzY2hlbWFGaWVsZDtcclxuICAgICAgICBjb25zdCBmaWVsZDogRGJGaWVsZCA9IHtcclxuICAgICAgICAgICAgbmFtZTogc2NoZW1hRmllbGQubmFtZSxcclxuICAgICAgICAgICAgYXJyYXlEZXB0aDogMCxcclxuICAgICAgICAgICAgdHlwZTogc2NhbGFyVHlwZXMuc3RyaW5nLFxyXG4gICAgICAgICAgICBkb2M6IGdldERvY01EKHNjaGVtYUZpZWxkKSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHdoaWxlIChzY2hlbWFUeXBlLmFycmF5KSB7XHJcbiAgICAgICAgICAgIGZpZWxkLmFycmF5RGVwdGggKz0gMTtcclxuICAgICAgICAgICAgc2NoZW1hVHlwZSA9IHNjaGVtYVR5cGUuYXJyYXk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGV4ID0gKHNjaGVtYVR5cGU6IGFueSkuXztcclxuICAgICAgICBjb25zdCBlbnVtRGVmOiA/SW50RW51bURlZiA9IChleCAmJiBleC5lbnVtKSB8fCBudWxsO1xyXG4gICAgICAgIGlmIChlbnVtRGVmKSB7XHJcbiAgICAgICAgICAgIGZpZWxkLmVudW1EZWYgPSBlbnVtRGVmO1xyXG4gICAgICAgICAgICBlbnVtVHlwZXMuc2V0KGVudW1EZWYubmFtZSwgZW51bURlZik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGpvaW4gPSBleCAmJiBleC5qb2luO1xyXG4gICAgICAgIGlmIChqb2luKSB7XHJcbiAgICAgICAgICAgIGZpZWxkLmpvaW4gPSBqb2luO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZXggJiYgZXguZm9ybWF0dGVyKSB7XHJcbiAgICAgICAgICAgIGZpZWxkLmZvcm1hdHRlciA9IGV4LmZvcm1hdHRlcjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNjaGVtYVR5cGUudW5pb24gfHwgc2NoZW1hVHlwZS5zdHJ1Y3QpIHtcclxuICAgICAgICAgICAgZmllbGQudHlwZSA9IHVucmVzb2x2ZWRUeXBlKG1ha2VGaWVsZFR5cGVOYW1lKHR5cGVOYW1lLCBzY2hlbWFGaWVsZC5uYW1lKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChzY2hlbWFUeXBlLnJlZikge1xyXG4gICAgICAgICAgICBmaWVsZC50eXBlID0gdW5yZXNvbHZlZFR5cGUoc2NoZW1hVHlwZS5yZWYubmFtZSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChzY2hlbWFUeXBlLmJvb2wpIHtcclxuICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLmJvb2xlYW47XHJcbiAgICAgICAgfSBlbHNlIGlmIChzY2hlbWFUeXBlLmludCkge1xyXG4gICAgICAgICAgICBjb25zdCB1bnNpZ25lZDogYm9vbGVhbiA9IChzY2hlbWFUeXBlLmludCAmJiBzY2hlbWFUeXBlLmludC51bnNpZ25lZCkgfHwgZmFsc2U7XHJcbiAgICAgICAgICAgIGNvbnN0IHNpemU6IG51bWJlciA9IChzY2hlbWFUeXBlLmludCAmJiBzY2hlbWFUeXBlLmludC5zaXplKSB8fCAzMjtcclxuICAgICAgICAgICAgaWYgKHVuc2lnbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+PSAxMjgpIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMudWludDEwMjQ7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNpemUgPj0gNjQpIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMudWludDY0O1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzaXplID49IDMyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLmZsb2F0O1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMuaW50O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNpemUgPiAzMikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW50ZWdlciB0eXBlIHdpdGggc2l6ZSAke3NpemV9IGJpdCBkb2VzIG5vdCBzdXBwb3J0ZWRgKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmllbGQudHlwZSA9IHNjYWxhclR5cGVzLmludDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoc2NoZW1hVHlwZS5mbG9hdCkge1xyXG4gICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMuZmxvYXQ7XHJcbiAgICAgICAgfSBlbHNlIGlmIChzY2hlbWFUeXBlLnN0cmluZykge1xyXG4gICAgICAgICAgICBmaWVsZC50eXBlID0gc2NhbGFyVHlwZXMuc3RyaW5nO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZpZWxkLnR5cGUgPSBzY2FsYXJUeXBlcy5zdHJpbmc7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJbnZhbGlkIGZpZWxkIHR5cGU6ICcsIEpTT04uc3RyaW5naWZ5KHNjaGVtYVR5cGUpKTtcclxuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmllbGQ7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdW53cmFwQXJyYXlzKHR5cGU6IFNjaGVtYVR5cGUpOiBTY2hlbWFUeXBlIHtcclxuICAgICAgICBpZiAodHlwZS5hcnJheSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdW53cmFwQXJyYXlzKHR5cGUuYXJyYXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHlwZTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBwYXJzZURiVHlwZShcclxuICAgICAgICBuYW1lOiBzdHJpbmcsXHJcbiAgICAgICAgc2NoZW1hVHlwZTogU2NoZW1hVHlwZVxyXG4gICAgKSB7XHJcbiAgICAgICAgY29uc3Qgc3RydWN0ID0gc2NoZW1hVHlwZS51bmlvbiB8fCBzY2hlbWFUeXBlLnN0cnVjdDtcclxuICAgICAgICBpZiAoIXN0cnVjdCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgPz8gJHtuYW1lfTogJHtKU09OLnN0cmluZ2lmeShzY2hlbWFUeXBlKS5zdWJzdHIoMCwgMjAwKX1gKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB0eXBlOiBEYlR5cGUgPSB7XHJcbiAgICAgICAgICAgIG5hbWUsXHJcbiAgICAgICAgICAgIGNhdGVnb3J5OiBzY2hlbWFUeXBlLnVuaW9uID8gRGJUeXBlQ2F0ZWdvcnkudW5pb24gOiBEYlR5cGVDYXRlZ29yeS5zdHJ1Y3QsXHJcbiAgICAgICAgICAgIGZpZWxkczogW10sXHJcbiAgICAgICAgICAgIGNvbGxlY3Rpb246IChzY2hlbWFUeXBlOiBhbnkpLl8uY29sbGVjdGlvbixcclxuICAgICAgICAgICAgZG9jOiBnZXREb2NNRChzY2hlbWFUeXBlKSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAodHlwZS5jb2xsZWN0aW9uKSB7XHJcbiAgICAgICAgICAgIHR5cGUuZmllbGRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgbmFtZTogJ2lkJyxcclxuICAgICAgICAgICAgICAgIGFycmF5RGVwdGg6IDAsXHJcbiAgICAgICAgICAgICAgICB0eXBlOiBzY2FsYXJUeXBlcy5zdHJpbmcsXHJcbiAgICAgICAgICAgICAgICBkb2M6ICcnLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3RydWN0LmZvckVhY2goKGZpZWxkKSA9PiB7XHJcbiAgICAgICAgICAgIHR5cGUuZmllbGRzLnB1c2gocGFyc2VEYkZpZWxkKG5hbWUsIGZpZWxkKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHVud3JhcHBlZCA9IHVud3JhcEFycmF5cyhmaWVsZCk7XHJcbiAgICAgICAgICAgIGNvbnN0IG93blR5cGUgPSAodW53cmFwcGVkLnN0cnVjdCB8fCB1bndyYXBwZWQudW5pb24pID8gdW53cmFwcGVkIDogbnVsbDtcclxuICAgICAgICAgICAgaWYgKG93blR5cGUpIHtcclxuICAgICAgICAgICAgICAgIHBhcnNlRGJUeXBlKG1ha2VGaWVsZFR5cGVOYW1lKG5hbWUsIGZpZWxkLm5hbWUpLCBvd25UeXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGRiVHlwZXMucHVzaCh0eXBlKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzY2hlbWEgPSBwYXJzZVR5cGVEZWYoc2NoZW1hRGVmKTtcclxuXHJcbiAgICBpZiAoc2NoZW1hLmNsYXNzKSB7XHJcbiAgICAgICAgc2NoZW1hLmNsYXNzLnR5cGVzLmZvckVhY2goKHR5cGU6IFNjaGVtYU1lbWJlcjxTY2hlbWFUeXBlPikgPT4ge1xyXG4gICAgICAgICAgICBwYXJzZURiVHlwZSh0eXBlLm5hbWUsIHR5cGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBjb25zdCB1bnJlc29sdmVkOiBNYXA8c3RyaW5nLCBEYlR5cGU+ID0gbmV3IE1hcDxzdHJpbmcsIERiVHlwZT4oKTtcclxuICAgIGNvbnN0IHJlc29sdmluZzogU2V0PHN0cmluZz4gPSBuZXcgU2V0PHN0cmluZz4oKTtcclxuICAgIGNvbnN0IHJlc29sdmVkOiBNYXA8c3RyaW5nLCBEYlR5cGU+ID0gbmV3IE1hcDxzdHJpbmcsIERiVHlwZT4oKTtcclxuICAgIGNvbnN0IG9yZGVyZWRSZXNvbHZlZDogRGJUeXBlW10gPSBbXTtcclxuICAgIGRiVHlwZXMuZm9yRWFjaCh0ID0+IHVucmVzb2x2ZWQuc2V0KHQubmFtZSwgdCkpO1xyXG4gICAgY29uc3QgcmVzb2x2ZVR5cGUgPSAodHlwZTogRGJUeXBlKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc29sdmVkLmhhcyh0eXBlLm5hbWUpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHJlc29sdmluZy5oYXModHlwZS5uYW1lKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgV0FSTklORzogQ2lyY3VsYXIgcmVmZXJlbmNlIHRvIHR5cGUgJHt0eXBlLm5hbWV9YCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVzb2x2aW5nLmFkZCh0eXBlLm5hbWUpO1xyXG4gICAgICAgIHR5cGUuZmllbGRzLmZvckVhY2goKGZpZWxkKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZC50eXBlLmNhdGVnb3J5ID09PSBEYlR5cGVDYXRlZ29yeS51bnJlc29sdmVkKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgdHlwZSA9IHJlc29sdmVkLmdldChmaWVsZC50eXBlLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZSA9IHVucmVzb2x2ZWQuZ2V0KGZpZWxkLnR5cGUubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZVR5cGUodHlwZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFJlZmVyZW5jZWQgdHlwZSBub3QgZm91bmQ6ICR7ZmllbGQudHlwZS5uYW1lfWApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWVsZC50eXBlID0gdHlwZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJlc29sdmluZy5kZWxldGUodHlwZS5uYW1lKTtcclxuICAgICAgICBvcmRlcmVkUmVzb2x2ZWQucHVzaCh0eXBlKTtcclxuICAgICAgICB1bnJlc29sdmVkLmRlbGV0ZSh0eXBlLm5hbWUpO1xyXG4gICAgICAgIHJlc29sdmVkLnNldCh0eXBlLm5hbWUsIHR5cGUpO1xyXG4gICAgfTtcclxuICAgIGRiVHlwZXMuZm9yRWFjaChyZXNvbHZlVHlwZSk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHR5cGVzOiBvcmRlcmVkUmVzb2x2ZWQsXHJcbiAgICAgICAgZW51bVR5cGVzLFxyXG4gICAgfVxyXG59XHJcbiJdfQ==