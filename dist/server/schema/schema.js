"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseTypeDef = parseTypeDef;
exports.Def = void 0;

/* eslint-disable no-use-before-define */
// Def
const Def = {
  void_(doc) {
    return {
      _void: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  any(doc) {
    return {
      _any: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  int(doc) {
    return {
      _int: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  float(doc) {
    return {
      _float: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  string(doc) {
    return {
      _string: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  bool(doc) {
    return {
      _bool: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  time(doc) {
    return {
      _time: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  arrayOf(item, doc) {
    return {
      _array: item,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  unionOf(members, doc) {
    return {
      _union: members,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  ref(nameOrType, doc) {
    const name = typeof nameOrType === 'string' ? nameOrType : Object.keys(nameOrType)[0];
    return {
      _ref: name,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  value(value, doc) {
    return {
      _value: value,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  }

}; // Schema

exports.Def = Def;

function isReservedKey(key) {
  return key === '_doc' || key === "_";
}

// Parser
function parseTypeDef(def) {
  const parser = new SchemaParser();
  return parser.parseTypeDef(def, '');
} // Internals


function combineName(base, name) {
  return base !== '' ? `${base}.${name}` : name;
}

const UnresolvedType = {
  void: {},
  doc: ''
};

class SchemaParser {
  constructor() {
    this.types = {};
  }

  typeRef(def) {
    const defRef = def._ref || '';
    const existing = this.types[defRef];

    if (existing) {
      if (existing.type !== UnresolvedType) {
        return {
          ref: {
            name: defRef,
            type: existing.type
          }
        };
      }

      const ref = {
        name: defRef,
        type: UnresolvedType
      };
      existing.unresolved.push(ref);
      return {
        ref
      };
    }

    const ref = {
      name: defRef,
      type: UnresolvedType
    };
    this.types[defRef] = {
      type: UnresolvedType,
      unresolved: [ref]
    };
    return {
      ref
    };
  }

  resolveType(name, type) {
    const existing = this.types[name];

    if (existing) {
      existing.unresolved.forEach(x => x.type = type);
    }

    this.types[name] = {
      type,
      unresolved: []
    };
  }

  namedMembersFromUnorderedDefs(defs, mapMember) {
    return Object.keys(defs).map(memberName => {
      const memberDef = defs[memberName];
      return {
        name: memberName,
        ...mapMember(memberName, memberDef)
      };
    });
  }

  namedMembersFromOrderedDefs(defs, mapMember) {
    const members = [];
    defs.forEach(unorderedDefs => {
      this.namedMembersFromUnorderedDefs(unorderedDefs, mapMember).forEach(member => {
        members.push(member);
      });
    });
    return members;
  }

  namedMembers(defs, mapMember) {
    return Array.isArray(defs) ? this.namedMembersFromOrderedDefs(defs, mapMember) : this.namedMembersFromUnorderedDefs(defs, mapMember);
  }

  typedNamedMembers(memberDefs, name) {
    return this.namedMembers(memberDefs, (memberName, memberDef) => {
      return this.parseTypeDef(memberDef, combineName(name, memberName));
    });
  }

  typedNamedOrderedMembers(memberDefs, name) {
    return this.namedMembersFromOrderedDefs(memberDefs, (memberName, memberDef) => {
      return this.parseTypeDef(memberDef, combineName(name, memberName));
    });
  }

  parseTypeDef(def, name) {
    const scalarTypes = ['_void', '_any', '_int', '_float', '_string', '_bool', '_time'];

    if (!def) {
      console.log('>>>', name, def);
    }

    let type = {
      def,
      doc: def._doc || '',
      _: def._ || {}
    };
    const scalarType = scalarTypes.find(t => t in def);

    if (scalarType) {
      Object.assign(type, def);
      type[scalarType.substr(1)] = def[scalarType];
    } else if (def._ref) {
      Object.assign(type, this.typeRef(def));
    } else if (def._array) {
      type.array = this.parseTypeDef(def._array, combineName(name, 'item'));
    } else if (def._struct) {
      type.struct = this.typedNamedMembers(def._struct, name);
    } else if (def._union) {
      type.union = this.namedMembers(def._union, (memberName, memberDef) => {
        return memberDef._value ? memberDef : this.parseTypeDef(memberDef, combineName(name, memberName));
      });
    } else if (def._class) {
      const classDef = def._class;
      type.class = {
        types: classDef.types ? this.typedNamedMembers(classDef.types, name) : [],
        fields: classDef.fields ? this.typedNamedMembers(classDef.fields, name) : [],
        functions: classDef.functions ? this.namedMembers(classDef.functions, (functionName, functionDef) => {
          return {
            def: functionDef,
            doc: functionDef._doc || '',
            args: functionDef.args ? this.typedNamedOrderedMembers(functionDef.args, combineName(name, functionName)) : [],
            result: functionDef.result ? this.parseTypeDef(functionDef.result, combineName(name, 'Result')) : {
              doc: '',
              void: {}
            }
          };
        }) : []
      };
    } else if (Array.isArray(def)) {
      type.struct = this.typedNamedMembers(def, name);
    } else if (typeof def === 'object') {
      const filteredDef = {};
      Object.keys(def).forEach(key => {
        if (!isReservedKey(key)) {
          filteredDef[key] = def[key];
        }
      });
      type.struct = this.typedNamedMembers(filteredDef, name);
    } else {
      console.log('>>>', name);
    }

    this.resolveType(name, type);
    return type;
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9zY2hlbWEvc2NoZW1hLmpzIl0sIm5hbWVzIjpbIkRlZiIsInZvaWRfIiwiZG9jIiwiX3ZvaWQiLCJfZG9jIiwiYW55IiwiX2FueSIsImludCIsIl9pbnQiLCJmbG9hdCIsIl9mbG9hdCIsInN0cmluZyIsIl9zdHJpbmciLCJib29sIiwiX2Jvb2wiLCJ0aW1lIiwiX3RpbWUiLCJhcnJheU9mIiwiaXRlbSIsIl9hcnJheSIsInVuaW9uT2YiLCJtZW1iZXJzIiwiX3VuaW9uIiwicmVmIiwibmFtZU9yVHlwZSIsIm5hbWUiLCJPYmplY3QiLCJrZXlzIiwiX3JlZiIsInZhbHVlIiwiX3ZhbHVlIiwiaXNSZXNlcnZlZEtleSIsImtleSIsInBhcnNlVHlwZURlZiIsImRlZiIsInBhcnNlciIsIlNjaGVtYVBhcnNlciIsImNvbWJpbmVOYW1lIiwiYmFzZSIsIlVucmVzb2x2ZWRUeXBlIiwidm9pZCIsImNvbnN0cnVjdG9yIiwidHlwZXMiLCJ0eXBlUmVmIiwiZGVmUmVmIiwiZXhpc3RpbmciLCJ0eXBlIiwidW5yZXNvbHZlZCIsInB1c2giLCJyZXNvbHZlVHlwZSIsImZvckVhY2giLCJ4IiwibmFtZWRNZW1iZXJzRnJvbVVub3JkZXJlZERlZnMiLCJkZWZzIiwibWFwTWVtYmVyIiwibWFwIiwibWVtYmVyTmFtZSIsIm1lbWJlckRlZiIsIm5hbWVkTWVtYmVyc0Zyb21PcmRlcmVkRGVmcyIsInVub3JkZXJlZERlZnMiLCJtZW1iZXIiLCJuYW1lZE1lbWJlcnMiLCJBcnJheSIsImlzQXJyYXkiLCJ0eXBlZE5hbWVkTWVtYmVycyIsIm1lbWJlckRlZnMiLCJ0eXBlZE5hbWVkT3JkZXJlZE1lbWJlcnMiLCJzY2FsYXJUeXBlcyIsImNvbnNvbGUiLCJsb2ciLCJfIiwic2NhbGFyVHlwZSIsImZpbmQiLCJ0IiwiYXNzaWduIiwic3Vic3RyIiwiYXJyYXkiLCJfc3RydWN0Iiwic3RydWN0IiwidW5pb24iLCJfY2xhc3MiLCJjbGFzc0RlZiIsImNsYXNzIiwiZmllbGRzIiwiZnVuY3Rpb25zIiwiZnVuY3Rpb25OYW1lIiwiZnVuY3Rpb25EZWYiLCJhcmdzIiwicmVzdWx0IiwiZmlsdGVyZWREZWYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFHQTtBQTJDTyxNQUFNQSxHQUFHLEdBQUc7QUFDZkMsRUFBQUEsS0FBSyxDQUFDQyxHQUFELEVBQStCO0FBQ2hDLFdBQU87QUFBRUMsTUFBQUEsS0FBSyxFQUFFLEVBQVQ7QUFBYSxVQUFJRCxHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgsR0FBbUIsRUFBMUI7QUFBYixLQUFQO0FBQ0gsR0FIYzs7QUFJZkcsRUFBQUEsR0FBRyxDQUFDSCxHQUFELEVBQStCO0FBQzlCLFdBQU87QUFBRUksTUFBQUEsSUFBSSxFQUFFLEVBQVI7QUFBWSxVQUFJSixHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgsR0FBbUIsRUFBMUI7QUFBWixLQUFQO0FBQ0gsR0FOYzs7QUFPZkssRUFBQUEsR0FBRyxDQUFDTCxHQUFELEVBQStCO0FBQzlCLFdBQU87QUFBRU0sTUFBQUEsSUFBSSxFQUFFLEVBQVI7QUFBWSxVQUFJTixHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgsR0FBbUIsRUFBMUI7QUFBWixLQUFQO0FBQ0gsR0FUYzs7QUFVZk8sRUFBQUEsS0FBSyxDQUFDUCxHQUFELEVBQStCO0FBQ2hDLFdBQU87QUFBRVEsTUFBQUEsTUFBTSxFQUFFLEVBQVY7QUFBYyxVQUFJUixHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgsR0FBbUIsRUFBMUI7QUFBZCxLQUFQO0FBQ0gsR0FaYzs7QUFhZlMsRUFBQUEsTUFBTSxDQUFDVCxHQUFELEVBQStCO0FBQ2pDLFdBQU87QUFBRVUsTUFBQUEsT0FBTyxFQUFFLEVBQVg7QUFBZSxVQUFJVixHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgs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QUssQ0FBQ0MsT0FBTixDQUFjN0IsR0FBZCxDQUFKLEVBQXdCO0FBQzNCWSxNQUFBQSxJQUFJLENBQUNnQyxNQUFMLEdBQWMsS0FBS2QsaUJBQUwsQ0FBd0I5QixHQUF4QixFQUFtQ1QsSUFBbkMsQ0FBZDtBQUNILEtBRk0sTUFFQSxJQUFJLE9BQU9TLEdBQVAsS0FBZSxRQUFuQixFQUE2QjtBQUNoQyxZQUFNdUQsV0FBVyxHQUFHLEVBQXBCO0FBQ0EvRCxNQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWU8sR0FBWixFQUFpQmdCLE9BQWpCLENBQTBCbEIsR0FBRCxJQUFTO0FBQzlCLFlBQUksQ0FBQ0QsYUFBYSxDQUFDQyxHQUFELENBQWxCLEVBQXlCO0FBQ3JCeUQsVUFBQUEsV0FBVyxDQUFDekQsR0FBRCxDQUFYLEdBQW1CRSxHQUFHLENBQUNGLEdBQUQsQ0FBdEI7QUFDSDtBQUNKLE9BSkQ7QUFLQWMsTUFBQUEsSUFBSSxDQUFDZ0MsTUFBTCxHQUFjLEtBQUtkLGlCQUFMLENBQXdCeUIsV0FBeEIsRUFBMkNoRSxJQUEzQyxDQUFkO0FBQ0gsS0FSTSxNQVFBO0FBQ0gyQyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxLQUFaLEVBQW1CNUMsSUFBbkI7QUFDSDs7QUFDRCxTQUFLd0IsV0FBTCxDQUFpQnhCLElBQWpCLEVBQXVCcUIsSUFBdkI7QUFDQSxXQUFPQSxJQUFQO0FBQ0g7O0FBMUljIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tdXNlLWJlZm9yZS1kZWZpbmUgKi9cclxuLy8gQGZsb3dcclxuXHJcbi8vIERlZlxyXG5cclxuZXhwb3J0IHR5cGUgRG9jQ29udGVudERlZiA9IHN0cmluZyB8IHsgbWQ6IHN0cmluZyB9IHwgeyBodG1sOiBzdHJpbmcgfTtcclxuXHJcbmV4cG9ydCB0eXBlIERvY0RlZiA9IHsgX2RvYz86IERvY0NvbnRlbnREZWYgfVxyXG5cclxuZXhwb3J0IHR5cGUgQ2xhc3NEZWYgPSB7XHJcbiAgICB0eXBlcz86IE1lbWJlcnNEZWY8VHlwZURlZj4sXHJcbiAgICBmaWVsZHM/OiBNZW1iZXJzRGVmPFR5cGVEZWY+LFxyXG4gICAgZnVuY3Rpb25zPzogTWVtYmVyc0RlZjxGdW5jdGlvbkRlZj5cclxufVxyXG5cclxuZXhwb3J0IHR5cGUgSW50U2l6ZVR5cGUgPSA4IHwgMTYgfCAzMiB8IDY0IHwgMTI4IHwgMjU2O1xyXG5cclxuZXhwb3J0IHR5cGUgVHlwZURlZiA9IERvY0RlZiAmIHtcclxuICAgIF92b2lkPzoge30sXHJcbiAgICBfYW55Pzoge30sXHJcbiAgICBfcmVmPzogc3RyaW5nLFxyXG4gICAgX2Jvb2w/OiB7fSxcclxuICAgIF90aW1lPzoge30sXHJcbiAgICBfc3RyaW5nPzoge30sXHJcbiAgICBfZmxvYXQ/OiB7IHNpemU/OiAzMiB8IDY0IH0sXHJcbiAgICBfaW50PzogeyB1bnNpZ25lZD86IGJvb2xlYW4sIHNpemU/OiBJbnRTaXplVHlwZSB9LFxyXG4gICAgX2FycmF5PzogVHlwZURlZixcclxuICAgIF9zdHJ1Y3Q/OiBNZW1iZXJzRGVmPFR5cGVEZWY+LFxyXG4gICAgX3VuaW9uPzogTWVtYmVyc0RlZjxUeXBlRGVmPixcclxuICAgIF9jbGFzcz86IENsYXNzRGVmLFxyXG4gICAgX3ZhbHVlPzogc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbixcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgRnVuY3Rpb25EZWYgPSBEb2NEZWYgJiB7XHJcbiAgICBhcmdzPzogT3JkZXJlZE1lbWJlcnNEZWY8VHlwZURlZj4sXHJcbiAgICByZXN1bHQ/OiBUeXBlRGVmLFxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBVbm9yZGVyZWRNZW1iZXJzRGVmPE0+ID0ge1xyXG4gICAgW3N0cmluZ106IE1cclxufVxyXG5cclxuZXhwb3J0IHR5cGUgT3JkZXJlZE1lbWJlcnNEZWY8TT4gPSBVbm9yZGVyZWRNZW1iZXJzRGVmPE0+W11cclxuXHJcbmV4cG9ydCB0eXBlIE1lbWJlcnNEZWY8TT4gPSBPcmRlcmVkTWVtYmVyc0RlZjxNPiB8IFVub3JkZXJlZE1lbWJlcnNEZWY8TT5cclxuXHJcbmV4cG9ydCBjb25zdCBEZWYgPSB7XHJcbiAgICB2b2lkXyhkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XHJcbiAgICAgICAgcmV0dXJuIHsgX3ZvaWQ6IHt9LCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9XHJcbiAgICB9LFxyXG4gICAgYW55KGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcclxuICAgICAgICByZXR1cm4geyBfYW55OiB7fSwgLi4uKGRvYyA/IHsgX2RvYzogZG9jIH0gOiB7fSkgfVxyXG4gICAgfSxcclxuICAgIGludChkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XHJcbiAgICAgICAgcmV0dXJuIHsgX2ludDoge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cclxuICAgIH0sXHJcbiAgICBmbG9hdChkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XHJcbiAgICAgICAgcmV0dXJuIHsgX2Zsb2F0OiB7fSwgLi4uKGRvYyA/IHsgX2RvYzogZG9jIH0gOiB7fSkgfVxyXG4gICAgfSxcclxuICAgIHN0cmluZyhkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XHJcbiAgICAgICAgcmV0dXJuIHsgX3N0cmluZzoge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cclxuICAgIH0sXHJcbiAgICBib29sKGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcclxuICAgICAgICByZXR1cm4geyBfYm9vbDoge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cclxuICAgIH0sXHJcbiAgICB0aW1lKGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcclxuICAgICAgICByZXR1cm4geyBfdGltZToge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cclxuICAgIH0sXHJcbiAgICBhcnJheU9mKGl0ZW06IFR5cGVEZWYsIGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcclxuICAgICAgICByZXR1cm4geyBfYXJyYXk6IGl0ZW0sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cclxuICAgIH0sXHJcbiAgICB1bmlvbk9mKG1lbWJlcnM6IE1lbWJlcnNEZWY8VHlwZURlZj4sIGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcclxuICAgICAgICByZXR1cm4geyBfdW5pb246IG1lbWJlcnMsIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cclxuICAgIH0sXHJcbiAgICByZWYobmFtZU9yVHlwZTogc3RyaW5nIHwgeyBbc3RyaW5nXTogVHlwZURlZiB9LCBkb2M/OiBEb2NDb250ZW50RGVmKTogVHlwZURlZiB7XHJcbiAgICAgICAgY29uc3QgbmFtZSA9IHR5cGVvZiBuYW1lT3JUeXBlID09PSAnc3RyaW5nJyA/IG5hbWVPclR5cGUgOiBPYmplY3Qua2V5cyhuYW1lT3JUeXBlKVswXTtcclxuICAgICAgICByZXR1cm4geyBfcmVmOiBuYW1lLCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9O1xyXG4gICAgfSxcclxuICAgIHZhbHVlKHZhbHVlOiBzdHJpbmcsIGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcclxuICAgICAgICByZXR1cm4geyBfdmFsdWU6IHZhbHVlLCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9XHJcbiAgICB9LFxyXG59O1xyXG5cclxuLy8gU2NoZW1hXHJcbmZ1bmN0aW9uIGlzUmVzZXJ2ZWRLZXkoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBrZXkgPT09ICdfZG9jJyB8fCBrZXkgPT09IFwiX1wiO1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBTY2hlbWFEb2MgPSB7XHJcbiAgICBkb2M/OiAoc3RyaW5nIHwgeyBtZDogc3RyaW5nIH0gfCB7IGh0bWw6IHN0cmluZyB9KVxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBTY2hlbWFDbGFzcyA9IHtcclxuICAgIHR5cGVzOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSxcclxuICAgIGZpZWxkczogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+W10sXHJcbiAgICBmdW5jdGlvbnM6IFNjaGVtYU1lbWJlcjxTY2hlbWFGdW5jdGlvbj5bXVxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBTY2hlbWFUeXBlID0gU2NoZW1hRG9jICYge1xyXG4gICAgdm9pZD86IHt9LFxyXG4gICAgYW55Pzoge30sXHJcbiAgICBpbnQ/OiB7IHVuc2lnbmVkPzogYm9vbGVhbiwgc2l6ZT86IEludFNpemVUeXBlIH0sXHJcbiAgICBmbG9hdD86IHsgc2l6ZT86ICgzMiB8IDY0KSB9LFxyXG4gICAgc3RyaW5nPzoge30sXHJcbiAgICBib29sPzoge30sXHJcbiAgICB0aW1lPzoge30sXHJcbiAgICBhcnJheT86IFNjaGVtYVR5cGUsXHJcbiAgICBzdHJ1Y3Q/OiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSxcclxuICAgIHVuaW9uPzogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+W10sXHJcbiAgICByZWY/OiB7IG5hbWU6IHN0cmluZywgdHlwZTogU2NoZW1hVHlwZSB9LFxyXG4gICAgY2xhc3M/OiBTY2hlbWFDbGFzcyxcclxuICAgIHZhbHVlPzogc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhblxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBTY2hlbWFGdW5jdGlvbiA9IFNjaGVtYURvYyAmIHtcclxuICAgIGFyZ3M6IFNjaGVtYU1lbWJlcjxTY2hlbWFUeXBlPltdLFxyXG4gICAgcmVzdWx0OiBTY2hlbWFUeXBlLFxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBTY2hlbWFNZW1iZXI8TT4gPSB7IG5hbWU6IHN0cmluZyB9ICYgTVxyXG5cclxuLy8gUGFyc2VyXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VUeXBlRGVmKGRlZjogVHlwZURlZik6IFNjaGVtYVR5cGUge1xyXG4gICAgY29uc3QgcGFyc2VyID0gbmV3IFNjaGVtYVBhcnNlcigpO1xyXG4gICAgcmV0dXJuIHBhcnNlci5wYXJzZVR5cGVEZWYoZGVmLCAnJyk7XHJcbn1cclxuXHJcbi8vIEludGVybmFsc1xyXG5cclxudHlwZSBQYXJzaW5nVHlwZSA9IHtcclxuICAgIHR5cGU6IFNjaGVtYVR5cGUsXHJcbiAgICB1bnJlc29sdmVkOiB7IG5hbWU6IHN0cmluZywgdHlwZTogU2NoZW1hVHlwZSB9W10sXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbWJpbmVOYW1lKGJhc2U6IHN0cmluZywgbmFtZTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBiYXNlICE9PSAnJyA/IGAke2Jhc2V9LiR7bmFtZX1gIDogbmFtZTtcclxufVxyXG5cclxuY29uc3QgVW5yZXNvbHZlZFR5cGU6IFNjaGVtYVR5cGUgPSB7XHJcbiAgICB2b2lkOiB7fSxcclxuICAgIGRvYzogJycsXHJcbn07XHJcblxyXG5jbGFzcyBTY2hlbWFQYXJzZXIge1xyXG4gICAgdHlwZXM6IHsgW3N0cmluZ106IFBhcnNpbmdUeXBlIH07XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy50eXBlcyA9IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIHR5cGVSZWYoZGVmOiBUeXBlRGVmKTogU2NoZW1hVHlwZSB7XHJcbiAgICAgICAgY29uc3QgZGVmUmVmID0gZGVmLl9yZWYgfHwgJyc7XHJcbiAgICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLnR5cGVzW2RlZlJlZl07XHJcbiAgICAgICAgaWYgKGV4aXN0aW5nKSB7XHJcbiAgICAgICAgICAgIGlmIChleGlzdGluZy50eXBlICE9PSBVbnJlc29sdmVkVHlwZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgcmVmOiB7IG5hbWU6IGRlZlJlZiwgdHlwZTogZXhpc3RpbmcudHlwZSB9IH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCByZWYgPSB7IG5hbWU6IGRlZlJlZiwgdHlwZTogVW5yZXNvbHZlZFR5cGUgfTtcclxuICAgICAgICAgICAgZXhpc3RpbmcudW5yZXNvbHZlZC5wdXNoKHJlZik7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHJlZiB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCByZWYgPSB7IG5hbWU6IGRlZlJlZiwgdHlwZTogVW5yZXNvbHZlZFR5cGUgfTtcclxuICAgICAgICB0aGlzLnR5cGVzW2RlZlJlZl0gPSB7IHR5cGU6IFVucmVzb2x2ZWRUeXBlLCB1bnJlc29sdmVkOiBbcmVmXSB9O1xyXG4gICAgICAgIHJldHVybiB7IHJlZiB9O1xyXG4gICAgfVxyXG5cclxuICAgIHJlc29sdmVUeXBlKG5hbWU6IHN0cmluZywgdHlwZTogU2NoZW1hVHlwZSkge1xyXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy50eXBlc1tuYW1lXTtcclxuICAgICAgICBpZiAoZXhpc3RpbmcpIHtcclxuICAgICAgICAgICAgZXhpc3RpbmcudW5yZXNvbHZlZC5mb3JFYWNoKHggPT4geC50eXBlID0gdHlwZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudHlwZXNbbmFtZV0gPSB7IHR5cGUsIHVucmVzb2x2ZWQ6IFtdIH07XHJcbiAgICB9XHJcblxyXG4gICAgbmFtZWRNZW1iZXJzRnJvbVVub3JkZXJlZERlZnM8RCwgUz4oXHJcbiAgICAgICAgZGVmczogVW5vcmRlcmVkTWVtYmVyc0RlZjxEPixcclxuICAgICAgICBtYXBNZW1iZXI6IChtZW1iZXJOYW1lOiBzdHJpbmcsIG1lbWJlckRlZjogRCkgPT4gU1xyXG4gICAgKTogU2NoZW1hTWVtYmVyPFM+W10ge1xyXG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhkZWZzKS5tYXA8U2NoZW1hTWVtYmVyPFM+PigobWVtYmVyTmFtZTogc3RyaW5nKTogU2NoZW1hTWVtYmVyPFM+ID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbWVtYmVyRGVmID0gZGVmc1ttZW1iZXJOYW1lXTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IG1lbWJlck5hbWUsXHJcbiAgICAgICAgICAgICAgICAuLi5tYXBNZW1iZXIobWVtYmVyTmFtZSwgbWVtYmVyRGVmKVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG5hbWVkTWVtYmVyc0Zyb21PcmRlcmVkRGVmczxELCBTPihcclxuICAgICAgICBkZWZzOiBPcmRlcmVkTWVtYmVyc0RlZjxEPixcclxuICAgICAgICBtYXBNZW1iZXI6IChuYW1lOiBzdHJpbmcsIGRlZjogRCkgPT4gU1xyXG4gICAgKTogU2NoZW1hTWVtYmVyPFM+W10ge1xyXG4gICAgICAgIGNvbnN0IG1lbWJlcnM6IFNjaGVtYU1lbWJlcjxTPltdID0gW107XHJcbiAgICAgICAgZGVmcy5mb3JFYWNoKCh1bm9yZGVyZWREZWZzOiBVbm9yZGVyZWRNZW1iZXJzRGVmPEQ+KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubmFtZWRNZW1iZXJzRnJvbVVub3JkZXJlZERlZnModW5vcmRlcmVkRGVmcywgbWFwTWVtYmVyKS5mb3JFYWNoKChtZW1iZXI6IFNjaGVtYU1lbWJlcjxTPikgPT4ge1xyXG4gICAgICAgICAgICAgICAgbWVtYmVycy5wdXNoKG1lbWJlcilcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gbWVtYmVycztcclxuICAgIH1cclxuXHJcbiAgICBuYW1lZE1lbWJlcnM8RCwgUz4oXHJcbiAgICAgICAgZGVmczogTWVtYmVyc0RlZjxEPixcclxuICAgICAgICBtYXBNZW1iZXI6IChuYW1lOiBzdHJpbmcsIGRlZjogRCkgPT4gU1xyXG4gICAgKTogU2NoZW1hTWVtYmVyPFM+W10ge1xyXG4gICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KGRlZnMpXHJcbiAgICAgICAgICAgID8gdGhpcy5uYW1lZE1lbWJlcnNGcm9tT3JkZXJlZERlZnMoZGVmcywgbWFwTWVtYmVyKVxyXG4gICAgICAgICAgICA6IHRoaXMubmFtZWRNZW1iZXJzRnJvbVVub3JkZXJlZERlZnMoZGVmcywgbWFwTWVtYmVyKTtcclxuICAgIH1cclxuXHJcbiAgICB0eXBlZE5hbWVkTWVtYmVyczxEOiBUeXBlRGVmPihtZW1iZXJEZWZzOiBNZW1iZXJzRGVmPEQ+LCBuYW1lOiBzdHJpbmcpOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubmFtZWRNZW1iZXJzPEQsIFNjaGVtYVR5cGU+KG1lbWJlckRlZnMsIChtZW1iZXJOYW1lOiBzdHJpbmcsIG1lbWJlckRlZjogRCk6IFNjaGVtYVR5cGUgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZVR5cGVEZWYobWVtYmVyRGVmLCBjb21iaW5lTmFtZShuYW1lLCBtZW1iZXJOYW1lKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdHlwZWROYW1lZE9yZGVyZWRNZW1iZXJzPEQ6IFR5cGVEZWY+KG1lbWJlckRlZnM6IE9yZGVyZWRNZW1iZXJzRGVmPEQ+LCBuYW1lOiBzdHJpbmcpOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubmFtZWRNZW1iZXJzRnJvbU9yZGVyZWREZWZzPEQsIFNjaGVtYVR5cGU+KG1lbWJlckRlZnMsIChtZW1iZXJOYW1lOiBzdHJpbmcsIG1lbWJlckRlZjogRCk6IFNjaGVtYVR5cGUgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZVR5cGVEZWYobWVtYmVyRGVmLCBjb21iaW5lTmFtZShuYW1lLCBtZW1iZXJOYW1lKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHBhcnNlVHlwZURlZihkZWY6IFR5cGVEZWYsIG5hbWU6IHN0cmluZyk6IFNjaGVtYVR5cGUge1xyXG4gICAgICAgIGNvbnN0IHNjYWxhclR5cGVzID0gWydfdm9pZCcsICdfYW55JywgJ19pbnQnLCAnX2Zsb2F0JywgJ19zdHJpbmcnLCAnX2Jvb2wnLCAnX3RpbWUnXTtcclxuICAgICAgICBpZiAoIWRlZikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnPj4+JywgbmFtZSwgZGVmKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHR5cGU6IGFueSA9IHtcclxuICAgICAgICAgICAgZGVmLFxyXG4gICAgICAgICAgICBkb2M6IGRlZi5fZG9jIHx8ICcnLFxyXG4gICAgICAgICAgICBfOiBkZWYuXyB8fCB7fSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIGNvbnN0IHNjYWxhclR5cGUgPSBzY2FsYXJUeXBlcy5maW5kKHQgPT4gdCBpbiBkZWYpO1xyXG4gICAgICAgIGlmIChzY2FsYXJUeXBlKSB7XHJcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odHlwZSwgZGVmKTtcclxuICAgICAgICAgICAgdHlwZVtzY2FsYXJUeXBlLnN1YnN0cigxKV0gPSBkZWZbc2NhbGFyVHlwZV07XHJcbiAgICAgICAgfSBlbHNlIGlmIChkZWYuX3JlZikge1xyXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHR5cGUsIHRoaXMudHlwZVJlZigoZGVmOiBhbnkpKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChkZWYuX2FycmF5KSB7XHJcbiAgICAgICAgICAgIHR5cGUuYXJyYXkgPSB0aGlzLnBhcnNlVHlwZURlZihkZWYuX2FycmF5LCBjb21iaW5lTmFtZShuYW1lLCAnaXRlbScpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGRlZi5fc3RydWN0KSB7XHJcbiAgICAgICAgICAgIHR5cGUuc3RydWN0ID0gdGhpcy50eXBlZE5hbWVkTWVtYmVycyhkZWYuX3N0cnVjdCwgbmFtZSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChkZWYuX3VuaW9uKSB7XHJcbiAgICAgICAgICAgIHR5cGUudW5pb24gPSB0aGlzLm5hbWVkTWVtYmVycyhkZWYuX3VuaW9uLCAobWVtYmVyTmFtZSwgbWVtYmVyRGVmKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbWVtYmVyRGVmLl92YWx1ZVxyXG4gICAgICAgICAgICAgICAgICAgID8gbWVtYmVyRGVmXHJcbiAgICAgICAgICAgICAgICAgICAgOiB0aGlzLnBhcnNlVHlwZURlZihtZW1iZXJEZWYsIGNvbWJpbmVOYW1lKG5hbWUsIG1lbWJlck5hbWUpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChkZWYuX2NsYXNzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNsYXNzRGVmID0gZGVmLl9jbGFzcztcclxuICAgICAgICAgICAgdHlwZS5jbGFzcyA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGVzOiBjbGFzc0RlZi50eXBlcyA/IHRoaXMudHlwZWROYW1lZE1lbWJlcnMoY2xhc3NEZWYudHlwZXMsIG5hbWUpIDogW10sXHJcbiAgICAgICAgICAgICAgICBmaWVsZHM6IGNsYXNzRGVmLmZpZWxkcyA/IHRoaXMudHlwZWROYW1lZE1lbWJlcnMoY2xhc3NEZWYuZmllbGRzLCBuYW1lKSA6IFtdLFxyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb25zOiBjbGFzc0RlZi5mdW5jdGlvbnMgPyB0aGlzLm5hbWVkTWVtYmVycyhjbGFzc0RlZi5mdW5jdGlvbnMsIChmdW5jdGlvbk5hbWUsIGZ1bmN0aW9uRGVmOiBGdW5jdGlvbkRlZikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZjogZnVuY3Rpb25EZWYsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvYzogZnVuY3Rpb25EZWYuX2RvYyB8fCAnJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogZnVuY3Rpb25EZWYuYXJnc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyB0aGlzLnR5cGVkTmFtZWRPcmRlcmVkTWVtYmVycyhmdW5jdGlvbkRlZi5hcmdzLCBjb21iaW5lTmFtZShuYW1lLCBmdW5jdGlvbk5hbWUpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBmdW5jdGlvbkRlZi5yZXN1bHRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gdGhpcy5wYXJzZVR5cGVEZWYoZnVuY3Rpb25EZWYucmVzdWx0LCBjb21iaW5lTmFtZShuYW1lLCAnUmVzdWx0JykpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHsgZG9jOiAnJywgdm9pZDoge30gfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pIDogW10sXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGVmKSkge1xyXG4gICAgICAgICAgICB0eXBlLnN0cnVjdCA9IHRoaXMudHlwZWROYW1lZE1lbWJlcnMoKGRlZjogYW55KSwgbmFtZSk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICBjb25zdCBmaWx0ZXJlZERlZiA9IHt9O1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhkZWYpLmZvckVhY2goKGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFpc1Jlc2VydmVkS2V5KGtleSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJlZERlZltrZXldID0gZGVmW2tleV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0eXBlLnN0cnVjdCA9IHRoaXMudHlwZWROYW1lZE1lbWJlcnMoKGZpbHRlcmVkRGVmOiBhbnkpLCBuYW1lKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnPj4+JywgbmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucmVzb2x2ZVR5cGUobmFtZSwgdHlwZSk7XHJcbiAgICAgICAgcmV0dXJuIHR5cGU7XHJcbiAgICB9XHJcbn1cclxuXHJcbiJdfQ==