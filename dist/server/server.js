"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _apolloServerExpress = require("apollo-server-express");

var _subscriptionsTransportWs = require("subscriptions-transport-ws");

var _tonClientNodeJs = require("ton-client-node-js");

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _config = require("./config");

var _qRpcServer = require("./q-rpc-server");

var _resolversGenerated = require("./resolvers-generated");

var _resolversCustom = require("./resolvers-custom");

var _resolversMam = require("./resolvers-mam");

var _logs = _interopRequireDefault(require("./logs"));

var _tracer = require("./tracer");

var _opentracing = require("opentracing");

var _auth = require("./auth");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const v8 = require('v8');

class MemStats {
  constructor(stats) {
    this.stats = stats;
  }

  report() {
    v8.getHeapSpaceStatistics().forEach(space => {
      const spaceName = space.space_name.replace('space_', '').replace('_space', '');

      const gauge = (metric, value) => {
        this.stats.gauge(`heap.space.${spaceName}.${metric}`, value);
      };

      gauge('physical_size', space.physical_space_size);
      gauge('available_size', space.space_available_size);
      gauge('size', space.space_size);
      gauge('used_size', space.space_used_size);
    });
  }

  start() {//TODO: this.checkMemReport();
    //TODO: this.checkGc();
  }

  checkMemReport() {
    setTimeout(() => {
      this.report();
      this.checkMemReport();
    }, 5000);
  }

  checkGc() {
    setTimeout(() => {
      global.gc();
      this.checkGc();
    }, 60000);
  }

}

class TONQServer {
  constructor(options) {
    this.config = options.config;
    this.logs = options.logs;
    this.log = this.logs.create('server');
    this.shared = new Map();
    this.tracer = _tracer.QTracer.create(options.config);
    this.stats = _tracer.QStats.create(options.config.statsd.server, options.config.statsd.tags);
    this.auth = new _auth.Auth(options.config);
    this.endPoints = [];
    this.app = (0, _express.default)();
    this.server = _http.default.createServer(this.app);
    this.db = new _arango.default(this.config, this.logs, this.auth, this.tracer, this.stats);
    this.memStats = new MemStats(this.stats);
    this.memStats.start();
    this.rpcServer = new _qRpcServer.QRpcServer({
      auth: this.auth,
      db: this.db,
      port: options.config.server.rpcPort
    });
    this.addEndPoint({
      path: '/graphql/mam',
      resolvers: _resolversMam.resolversMam,
      typeDefFileNames: ['type-defs-mam.graphql'],
      supportSubscriptions: false
    });
    this.addEndPoint({
      path: '/graphql',
      resolvers: (0, _resolversCustom.attachCustomResolvers)(this.db, (0, _resolversGenerated.createResolvers)(this.db)),
      typeDefFileNames: ['type-defs-generated.graphql', 'type-defs-custom.graphql'],
      supportSubscriptions: true
    });
  }

  async start() {
    this.client = await _tonClientNodeJs.TONClient.create({
      servers: ['']
    });
    await this.db.start();
    const {
      host,
      port
    } = this.config.server;
    this.server.listen({
      host,
      port
    }, () => {
      this.endPoints.forEach(endPoint => {
        this.log.debug('GRAPHQL', `http://${host}:${port}${endPoint.path}`);
      });
    });
    this.server.setTimeout(2147483647);
    const version = (0, _utils.packageJson)().version;
    const startCounter = new _tracer.StatsCounter(this.stats, _config.STATS.start, [`version:${version}`]);
    startCounter.increment();

    if (this.rpcServer.port) {
      this.rpcServer.start();
    }
  }

  async stop() {
    await new Promise(resolve => this.server.close(() => resolve()));
    this.logs.stop();
  }

  addEndPoint(endPoint) {
    const typeDefs = endPoint.typeDefFileNames.map(x => _fs.default.readFileSync(x, 'utf-8')).join('\n');
    const config = {
      debug: false,
      typeDefs,
      resolvers: endPoint.resolvers,
      subscriptions: {
        keepAlive: this.config.server.keepAlive,

        onDisconnect(_webSocket, context) {
          if (context.activeRequests) {
            context.activeRequests.forEach(x => x.emitClose());
            context.activeRequests = [];
          }
        },

        onConnect(connectionParams, _webSocket, context) {
          const activeRequests = [];
          context.activeRequests = activeRequests;
          return {
            activeRequests,
            accessKey: connectionParams.accessKey || connectionParams.accesskey
          };
        }

      },
      context: ({
        req,
        connection
      }) => {
        const request = new _arangoCollection.RequestController();

        if (req && req.on) {
          req.on('close', () => {
            request.emitClose();
          });
        }

        if (connection && connection.context) {
          if (!connection.context.activeRequests) {
            connection.context.activeRequests = [];
          }

          const activeRequests = connection.context.activeRequests;
          activeRequests.push(request);
          request.events.on(_arangoCollection.RequestEvent.FINISH, () => {
            const index = activeRequests.indexOf(request);

            if (index >= 0) {
              activeRequests.splice(index, 1);
            }
          });
        }

        return {
          db: this.db,
          tracer: this.tracer,
          stats: this.stats,
          auth: this.auth,
          client: this.client,
          config: this.config,
          shared: this.shared,
          remoteAddress: req && req.socket && req.socket.remoteAddress || '',
          accessKey: _auth.Auth.extractAccessKey(req, connection),
          parentSpan: _tracer.QTracer.extractParentSpan(this.tracer, connection ? connection : req),
          req,
          connection,
          request
        };
      },
      plugins: [{
        requestDidStart(_requestContext) {
          return {
            willSendResponse(ctx) {
              const context = ctx.context;

              if (context.multipleAccessKeysDetected) {
                throw _utils.QError.multipleAccessKeys();
              }
            }

          };
        }

      }]
    };
    const apollo = new _apolloServerExpress.ApolloServer(config);
    apollo.applyMiddleware({
      app: this.app,
      path: endPoint.path
    });

    if (endPoint.supportSubscriptions) {
      apollo.installSubscriptionHandlers(this.server);
    }

    this.endPoints.push(endPoint);
  }

}

exports.default = TONQServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9zZXJ2ZXIuanMiXSwibmFtZXMiOlsidjgiLCJyZXF1aXJlIiwiTWVtU3RhdHMiLCJjb25zdHJ1Y3RvciIsInN0YXRzIiwicmVwb3J0IiwiZ2V0SGVhcFNwYWNlU3RhdGlzdGljcyIsImZvckVhY2giLCJzcGFjZSIsInNwYWNlTmFtZSIsInNwYWNlX25hbWUiLCJyZXBsYWNlIiwiZ2F1Z2UiLCJtZXRyaWMiLCJ2YWx1ZSIsInBoeXNpY2FsX3NwYWNlX3NpemUiLCJzcGFjZV9hdmFpbGFibGVfc2l6ZSIsInNwYWNlX3NpemUiLCJzcGFjZV91c2VkX3NpemUiLCJzdGFydCIsImNoZWNrTWVtUmVwb3J0Iiwic2V0VGltZW91dCIsImNoZWNrR2MiLCJnbG9iYWwiLCJnYyIsIlRPTlFTZXJ2ZXIiLCJvcHRpb25zIiwiY29uZmlnIiwibG9ncyIsImxvZyIsImNyZWF0ZSIsInNoYXJlZCIsIk1hcCIsInRyYWNlciIsIlFUcmFjZXIiLCJRU3RhdHMiLCJzdGF0c2QiLCJzZXJ2ZXIiLCJ0YWdzIiwiYXV0aCIsIkF1dGgiLCJlbmRQb2ludHMiLCJhcHAiLCJodHRwIiwiY3JlYXRlU2VydmVyIiwiZGIiLCJBcmFuZ28iLCJtZW1TdGF0cyIsInJwY1NlcnZlciIsIlFScGNTZXJ2ZXIiLCJwb3J0IiwicnBjUG9ydCIsImFkZEVuZFBvaW50IiwicGF0aCIsInJlc29sdmVycyIsInJlc29sdmVyc01hbSIsInR5cGVEZWZGaWxlTmFtZXMiLCJzdXBwb3J0U3Vic2NyaXB0aW9ucyIsImNsaWVudCIsIlRPTkNsaWVudE5vZGVKcyIsInNlcnZlcnMiLCJob3N0IiwibGlzdGVuIiwiZW5kUG9pbnQiLCJkZWJ1ZyIsInZlcnNpb24iLCJzdGFydENvdW50ZXIiLCJTdGF0c0NvdW50ZXIiLCJTVEFUUyIsImluY3JlbWVudCIsInN0b3AiLCJQcm9taXNlIiwicmVzb2x2ZSIsImNsb3NlIiwidHlwZURlZnMiLCJtYXAiLCJ4IiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJqb2luIiwic3Vic2NyaXB0aW9ucyIsImtlZXBBbGl2ZSIsIm9uRGlzY29ubmVjdCIsIl93ZWJTb2NrZXQiLCJjb250ZXh0IiwiYWN0aXZlUmVxdWVzdHMiLCJlbWl0Q2xvc2UiLCJvbkNvbm5lY3QiLCJjb25uZWN0aW9uUGFyYW1zIiwiYWNjZXNzS2V5IiwiYWNjZXNza2V5IiwicmVxIiwiY29ubmVjdGlvbiIsInJlcXVlc3QiLCJSZXF1ZXN0Q29udHJvbGxlciIsIm9uIiwicHVzaCIsImV2ZW50cyIsIlJlcXVlc3RFdmVudCIsIkZJTklTSCIsImluZGV4IiwiaW5kZXhPZiIsInNwbGljZSIsInJlbW90ZUFkZHJlc3MiLCJzb2NrZXQiLCJleHRyYWN0QWNjZXNzS2V5IiwicGFyZW50U3BhbiIsImV4dHJhY3RQYXJlbnRTcGFuIiwicGx1Z2lucyIsInJlcXVlc3REaWRTdGFydCIsIl9yZXF1ZXN0Q29udGV4dCIsIndpbGxTZW5kUmVzcG9uc2UiLCJjdHgiLCJtdWx0aXBsZUFjY2Vzc0tleXNEZXRlY3RlZCIsIlFFcnJvciIsIm11bHRpcGxlQWNjZXNzS2V5cyIsImFwb2xsbyIsIkFwb2xsb1NlcnZlciIsImFwcGx5TWlkZGxld2FyZSIsImluc3RhbGxTdWJzY3JpcHRpb25IYW5kbGVycyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQTFDQTs7Ozs7Ozs7Ozs7Ozs7O0FBd0RBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBRUEsTUFBTUMsUUFBTixDQUFlO0FBR1hDLEVBQUFBLFdBQVcsQ0FBQ0MsS0FBRCxFQUFnQjtBQUN2QixTQUFLQSxLQUFMLEdBQWFBLEtBQWI7QUFDSDs7QUFFREMsRUFBQUEsTUFBTSxHQUFHO0FBQ0xMLElBQUFBLEVBQUUsQ0FBQ00sc0JBQUgsR0FBNEJDLE9B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QUM1QixPQUEzQzs7QUFDQSxrQkFBSUEsT0FBTyxDQUFDNkIsMEJBQVosRUFBd0M7QUFDcEMsc0JBQU1DLGNBQU9DLGtCQUFQLEVBQU47QUFDSDtBQUNKOztBQU5FLFdBQVA7QUFRSDs7QUFWTCxPQURLO0FBekQ2QixLQUExQztBQXdFQSxVQUFNQyxNQUFNLEdBQUcsSUFBSUMsaUNBQUosQ0FBaUIxRixNQUFqQixDQUFmO0FBQ0F5RixJQUFBQSxNQUFNLENBQUNFLGVBQVAsQ0FBdUI7QUFDbkI1RSxNQUFBQSxHQUFHLEVBQUUsS0FBS0EsR0FEUztBQUVuQlcsTUFBQUEsSUFBSSxFQUFFVSxRQUFRLENBQUNWO0FBRkksS0FBdkI7O0FBSUEsUUFBSVUsUUFBUSxDQUFDTixvQkFBYixFQUFtQztBQUMvQjJELE1BQUFBLE1BQU0sQ0FBQ0csMkJBQVAsQ0FBbUMsS0FBS2xGLE1BQXhDO0FBQ0g7O0FBQ0QsU0FBS0ksU0FBTCxDQUFldUQsSUFBZixDQUFvQmpDLFFBQXBCO0FBQ0g7O0FBcksyQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxyXG4gKlxyXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcclxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXHJcbiAqIExpY2Vuc2UgYXQ6XHJcbiAqXHJcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xyXG4gKlxyXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cclxuICovXHJcblxyXG4vLyBAZmxvd1xyXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcclxuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XHJcblxyXG5pbXBvcnQgeyBBcG9sbG9TZXJ2ZXIsIEFwb2xsb1NlcnZlckV4cHJlc3NDb25maWcgfSBmcm9tICdhcG9sbG8tc2VydmVyLWV4cHJlc3MnO1xyXG5pbXBvcnQgeyBDb25uZWN0aW9uQ29udGV4dCB9IGZyb20gJ3N1YnNjcmlwdGlvbnMtdHJhbnNwb3J0LXdzJztcclxuaW1wb3J0IHR5cGUgeyBUT05DbGllbnQgfSBmcm9tICd0b24tY2xpZW50LWpzL3R5cGVzJztcclxuaW1wb3J0IHsgVE9OQ2xpZW50IGFzIFRPTkNsaWVudE5vZGVKcyB9IGZyb20gJ3Rvbi1jbGllbnQtbm9kZS1qcyc7XHJcbmltcG9ydCBBcmFuZ28gZnJvbSAnLi9hcmFuZ28nO1xyXG5pbXBvcnQgeyBSZXF1ZXN0Q29udHJvbGxlciwgUmVxdWVzdEV2ZW50IH0gZnJvbSAnLi9hcmFuZ28tY29sbGVjdGlvbic7XHJcbmltcG9ydCB0eXBlIHsgR3JhcGhRTFJlcXVlc3RDb250ZXh0IH0gZnJvbSAnLi9hcmFuZ28tY29sbGVjdGlvbic7XHJcbmltcG9ydCB7IFNUQVRTIH0gZnJvbSAnLi9jb25maWcnO1xyXG5pbXBvcnQgeyBRUnBjU2VydmVyIH0gZnJvbSAnLi9xLXJwYy1zZXJ2ZXInO1xyXG5cclxuaW1wb3J0IHsgY3JlYXRlUmVzb2x2ZXJzIH0gZnJvbSAnLi9yZXNvbHZlcnMtZ2VuZXJhdGVkJztcclxuaW1wb3J0IHsgYXR0YWNoQ3VzdG9tUmVzb2x2ZXJzIH0gZnJvbSAnLi9yZXNvbHZlcnMtY3VzdG9tJztcclxuaW1wb3J0IHsgcmVzb2x2ZXJzTWFtIH0gZnJvbSAnLi9yZXNvbHZlcnMtbWFtJztcclxuXHJcbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcclxuaW1wb3J0IFFMb2dzIGZyb20gJy4vbG9ncyc7XHJcbmltcG9ydCB0eXBlIHsgUUxvZyB9IGZyb20gJy4vbG9ncyc7XHJcbmltcG9ydCB0eXBlIHsgSVN0YXRzIH0gZnJvbSAnLi90cmFjZXInO1xyXG5pbXBvcnQgeyBRU3RhdHMsIFFUcmFjZXIsIFN0YXRzQ291bnRlciB9IGZyb20gJy4vdHJhY2VyJztcclxuaW1wb3J0IHsgVHJhY2VyIH0gZnJvbSAnb3BlbnRyYWNpbmcnO1xyXG5pbXBvcnQgeyBBdXRoIH0gZnJvbSAnLi9hdXRoJztcclxuaW1wb3J0IHsgcGFja2FnZUpzb24sIFFFcnJvciB9IGZyb20gJy4vdXRpbHMnO1xyXG5cclxudHlwZSBRT3B0aW9ucyA9IHtcclxuICAgIGNvbmZpZzogUUNvbmZpZyxcclxuICAgIGxvZ3M6IFFMb2dzLFxyXG59XHJcblxyXG50eXBlIEVuZFBvaW50ID0ge1xyXG4gICAgcGF0aDogc3RyaW5nLFxyXG4gICAgcmVzb2x2ZXJzOiBhbnksXHJcbiAgICB0eXBlRGVmRmlsZU5hbWVzOiBzdHJpbmdbXSxcclxuICAgIHN1cHBvcnRTdWJzY3JpcHRpb25zOiBib29sZWFuLFxyXG59XHJcblxyXG5jb25zdCB2OCA9IHJlcXVpcmUoJ3Y4Jyk7XHJcblxyXG5jbGFzcyBNZW1TdGF0cyB7XHJcbiAgICBzdGF0czogSVN0YXRzO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHN0YXRzOiBJU3RhdHMpIHtcclxuICAgICAgICB0aGlzLnN0YXRzID0gc3RhdHM7XHJcbiAgICB9XHJcblxyXG4gICAgcmVwb3J0KCkge1xyXG4gICAgICAgIHY4LmdldEhlYXBTcGFjZVN0YXRpc3RpY3MoKS5mb3JFYWNoKChzcGFjZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBzcGFjZU5hbWUgPSBzcGFjZS5zcGFjZV9uYW1lXHJcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgnc3BhY2VfJywgJycpXHJcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgnX3NwYWNlJywgJycpO1xyXG4gICAgICAgICAgICBjb25zdCBnYXVnZSA9IChtZXRyaWM6IHN0cmluZywgdmFsdWU6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5nYXVnZShgaGVhcC5zcGFjZS4ke3NwYWNlTmFtZX0uJHttZXRyaWN9YCwgdmFsdWUpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBnYXVnZSgncGh5c2ljYWxfc2l6ZScsIHNwYWNlLnBoeXNpY2FsX3NwYWNlX3NpemUpO1xyXG4gICAgICAgICAgICBnYXVnZSgnYXZhaWxhYmxlX3NpemUnLCBzcGFjZS5zcGFjZV9hdmFpbGFibGVfc2l6ZSk7XHJcbiAgICAgICAgICAgIGdhdWdlKCdzaXplJywgc3BhY2Uuc3BhY2Vfc2l6ZSk7XHJcbiAgICAgICAgICAgIGdhdWdlKCd1c2VkX3NpemUnLCBzcGFjZS5zcGFjZV91c2VkX3NpemUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXJ0KCkge1xyXG4gICAgICAgIC8vVE9ETzogdGhpcy5jaGVja01lbVJlcG9ydCgpO1xyXG4gICAgICAgIC8vVE9ETzogdGhpcy5jaGVja0djKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2tNZW1SZXBvcnQoKSB7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMucmVwb3J0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuY2hlY2tNZW1SZXBvcnQoKTtcclxuICAgICAgICB9LCA1MDAwKTtcclxuICAgIH1cclxuXHJcbiAgICBjaGVja0djKCkge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBnbG9iYWwuZ2MoKTtcclxuICAgICAgICAgICAgdGhpcy5jaGVja0djKCk7XHJcbiAgICAgICAgfSwgNjAwMDApO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUT05RU2VydmVyIHtcclxuICAgIGNvbmZpZzogUUNvbmZpZztcclxuICAgIGxvZ3M6IFFMb2dzO1xyXG4gICAgbG9nOiBRTG9nO1xyXG4gICAgYXBwOiBleHByZXNzLkFwcGxpY2F0aW9uO1xyXG4gICAgc2VydmVyOiBhbnk7XHJcbiAgICBlbmRQb2ludHM6IEVuZFBvaW50W107XHJcbiAgICBkYjogQXJhbmdvO1xyXG4gICAgdHJhY2VyOiBUcmFjZXI7XHJcbiAgICBzdGF0czogSVN0YXRzO1xyXG4gICAgY2xpZW50OiBUT05DbGllbnQ7XHJcbiAgICBhdXRoOiBBdXRoO1xyXG4gICAgbWVtU3RhdHM6IE1lbVN0YXRzO1xyXG4gICAgc2hhcmVkOiBNYXA8c3RyaW5nLCBhbnk+O1xyXG4gICAgcnBjU2VydmVyOiBRUnBjU2VydmVyO1xyXG5cclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBRT3B0aW9ucykge1xyXG4gICAgICAgIHRoaXMuY29uZmlnID0gb3B0aW9ucy5jb25maWc7XHJcbiAgICAgICAgdGhpcy5sb2dzID0gb3B0aW9ucy5sb2dzO1xyXG4gICAgICAgIHRoaXMubG9nID0gdGhpcy5sb2dzLmNyZWF0ZSgnc2VydmVyJyk7XHJcbiAgICAgICAgdGhpcy5zaGFyZWQgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgdGhpcy50cmFjZXIgPSBRVHJhY2VyLmNyZWF0ZShvcHRpb25zLmNvbmZpZyk7XHJcbiAgICAgICAgdGhpcy5zdGF0cyA9IFFTdGF0cy5jcmVhdGUob3B0aW9ucy5jb25maWcuc3RhdHNkLnNlcnZlciwgb3B0aW9ucy5jb25maWcuc3RhdHNkLnRhZ3MpO1xyXG4gICAgICAgIHRoaXMuYXV0aCA9IG5ldyBBdXRoKG9wdGlvbnMuY29uZmlnKTtcclxuICAgICAgICB0aGlzLmVuZFBvaW50cyA9IFtdO1xyXG4gICAgICAgIHRoaXMuYXBwID0gZXhwcmVzcygpO1xyXG4gICAgICAgIHRoaXMuc2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIodGhpcy5hcHApO1xyXG4gICAgICAgIHRoaXMuZGIgPSBuZXcgQXJhbmdvKHRoaXMuY29uZmlnLCB0aGlzLmxvZ3MsIHRoaXMuYXV0aCwgdGhpcy50cmFjZXIsIHRoaXMuc3RhdHMpO1xyXG4gICAgICAgIHRoaXMubWVtU3RhdHMgPSBuZXcgTWVtU3RhdHModGhpcy5zdGF0cyk7XHJcbiAgICAgICAgdGhpcy5tZW1TdGF0cy5zdGFydCgpO1xyXG4gICAgICAgIHRoaXMucnBjU2VydmVyID0gbmV3IFFScGNTZXJ2ZXIoe1xyXG4gICAgICAgICAgICBhdXRoOiB0aGlzLmF1dGgsXHJcbiAgICAgICAgICAgIGRiOiB0aGlzLmRiLFxyXG4gICAgICAgICAgICBwb3J0OiBvcHRpb25zLmNvbmZpZy5zZXJ2ZXIucnBjUG9ydCxcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmFkZEVuZFBvaW50KHtcclxuICAgICAgICAgICAgcGF0aDogJy9ncmFwaHFsL21hbScsXHJcbiAgICAgICAgICAgIHJlc29sdmVyczogcmVzb2x2ZXJzTWFtLFxyXG4gICAgICAgICAgICB0eXBlRGVmRmlsZU5hbWVzOiBbJ3R5cGUtZGVmcy1tYW0uZ3JhcGhxbCddLFxyXG4gICAgICAgICAgICBzdXBwb3J0U3Vic2NyaXB0aW9uczogZmFsc2UsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5hZGRFbmRQb2ludCh7XHJcbiAgICAgICAgICAgIHBhdGg6ICcvZ3JhcGhxbCcsXHJcbiAgICAgICAgICAgIHJlc29sdmVyczogYXR0YWNoQ3VzdG9tUmVzb2x2ZXJzKHRoaXMuZGIsIGNyZWF0ZVJlc29sdmVycyh0aGlzLmRiKSksXHJcbiAgICAgICAgICAgIHR5cGVEZWZGaWxlTmFtZXM6IFsndHlwZS1kZWZzLWdlbmVyYXRlZC5ncmFwaHFsJywgJ3R5cGUtZGVmcy1jdXN0b20uZ3JhcGhxbCddLFxyXG4gICAgICAgICAgICBzdXBwb3J0U3Vic2NyaXB0aW9uczogdHJ1ZSxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgYXN5bmMgc3RhcnQoKSB7XHJcbiAgICAgICAgdGhpcy5jbGllbnQgPSBhd2FpdCBUT05DbGllbnROb2RlSnMuY3JlYXRlKHsgc2VydmVyczogWycnXSB9KTtcclxuICAgICAgICBhd2FpdCB0aGlzLmRiLnN0YXJ0KCk7XHJcbiAgICAgICAgY29uc3QgeyBob3N0LCBwb3J0IH0gPSB0aGlzLmNvbmZpZy5zZXJ2ZXI7XHJcbiAgICAgICAgdGhpcy5zZXJ2ZXIubGlzdGVuKHtcclxuICAgICAgICAgICAgaG9zdCxcclxuICAgICAgICAgICAgcG9ydCxcclxuICAgICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZW5kUG9pbnRzLmZvckVhY2goKGVuZFBvaW50OiBFbmRQb2ludCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ0dSQVBIUUwnLCBgaHR0cDovLyR7aG9zdH06JHtwb3J0fSR7ZW5kUG9pbnQucGF0aH1gKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zZXJ2ZXIuc2V0VGltZW91dCgyMTQ3NDgzNjQ3KTtcclxuXHJcbiAgICAgICAgY29uc3QgdmVyc2lvbiA9IHBhY2thZ2VKc29uKCkudmVyc2lvbjtcclxuICAgICAgICBjb25zdCBzdGFydENvdW50ZXIgPSBuZXcgU3RhdHNDb3VudGVyKHRoaXMuc3RhdHMsIFNUQVRTLnN0YXJ0LCBbYHZlcnNpb246JHt2ZXJzaW9ufWBdKTtcclxuICAgICAgICBzdGFydENvdW50ZXIuaW5jcmVtZW50KClcclxuXHJcbiAgICAgICAgaWYgKHRoaXMucnBjU2VydmVyLnBvcnQpIHtcclxuICAgICAgICAgICAgdGhpcy5ycGNTZXJ2ZXIuc3RhcnQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGFzeW5jIHN0b3AoKSB7XHJcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHRoaXMuc2VydmVyLmNsb3NlKCgpID0+IHJlc29sdmUoKSkpO1xyXG4gICAgICAgIHRoaXMubG9ncy5zdG9wKCk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkRW5kUG9pbnQoZW5kUG9pbnQ6IEVuZFBvaW50KSB7XHJcbiAgICAgICAgY29uc3QgdHlwZURlZnMgPSBlbmRQb2ludC50eXBlRGVmRmlsZU5hbWVzXHJcbiAgICAgICAgICAgIC5tYXAoeCA9PiBmcy5yZWFkRmlsZVN5bmMoeCwgJ3V0Zi04JykpXHJcbiAgICAgICAgICAgIC5qb2luKCdcXG4nKTtcclxuICAgICAgICBjb25zdCBjb25maWc6IEFwb2xsb1NlcnZlckV4cHJlc3NDb25maWcgPSB7XHJcbiAgICAgICAgICAgIGRlYnVnOiBmYWxzZSxcclxuICAgICAgICAgICAgdHlwZURlZnMsXHJcbiAgICAgICAgICAgIHJlc29sdmVyczogZW5kUG9pbnQucmVzb2x2ZXJzLFxyXG4gICAgICAgICAgICBzdWJzY3JpcHRpb25zOiB7XHJcbiAgICAgICAgICAgICAgICBrZWVwQWxpdmU6IHRoaXMuY29uZmlnLnNlcnZlci5rZWVwQWxpdmUsXHJcbiAgICAgICAgICAgICAgICBvbkRpc2Nvbm5lY3QoX3dlYlNvY2tldDogV2ViU29ja2V0LCBjb250ZXh0OiBDb25uZWN0aW9uQ29udGV4dCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LmFjdGl2ZVJlcXVlc3RzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuYWN0aXZlUmVxdWVzdHMuZm9yRWFjaCh4ID0+IHguZW1pdENsb3NlKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmFjdGl2ZVJlcXVlc3RzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIG9uQ29ubmVjdChjb25uZWN0aW9uUGFyYW1zOiBPYmplY3QsIF93ZWJTb2NrZXQ6IFdlYlNvY2tldCwgY29udGV4dDogQ29ubmVjdGlvbkNvbnRleHQpOiBhbnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZVJlcXVlc3RzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5hY3RpdmVSZXF1ZXN0cyA9IGFjdGl2ZVJlcXVlc3RzO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVJlcXVlc3RzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3NLZXk6IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNzS2V5IHx8IGNvbm5lY3Rpb25QYXJhbXMuYWNjZXNza2V5LFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGNvbnRleHQ6ICh7IHJlcSwgY29ubmVjdGlvbiB9KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFJlcXVlc3RDb250cm9sbGVyKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVxICYmIHJlcS5vbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcS5vbignY2xvc2UnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuZW1pdENsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoY29ubmVjdGlvbiAmJiBjb25uZWN0aW9uLmNvbnRleHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3Rpb24uY29udGV4dC5hY3RpdmVSZXF1ZXN0cykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbnRleHQuYWN0aXZlUmVxdWVzdHMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aXZlUmVxdWVzdHMgPSBjb25uZWN0aW9uLmNvbnRleHQuYWN0aXZlUmVxdWVzdHM7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlUmVxdWVzdHMucHVzaChyZXF1ZXN0KTtcclxuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LmV2ZW50cy5vbihSZXF1ZXN0RXZlbnQuRklOSVNILCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gYWN0aXZlUmVxdWVzdHMuaW5kZXhPZihyZXF1ZXN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID49IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVJlcXVlc3RzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGI6IHRoaXMuZGIsXHJcbiAgICAgICAgICAgICAgICAgICAgdHJhY2VyOiB0aGlzLnRyYWNlcixcclxuICAgICAgICAgICAgICAgICAgICBzdGF0czogdGhpcy5zdGF0cyxcclxuICAgICAgICAgICAgICAgICAgICBhdXRoOiB0aGlzLmF1dGgsXHJcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50OiB0aGlzLmNsaWVudCxcclxuICAgICAgICAgICAgICAgICAgICBjb25maWc6IHRoaXMuY29uZmlnLFxyXG4gICAgICAgICAgICAgICAgICAgIHNoYXJlZDogdGhpcy5zaGFyZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVtb3RlQWRkcmVzczogKHJlcSAmJiByZXEuc29ja2V0ICYmIHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcykgfHwgJycsXHJcbiAgICAgICAgICAgICAgICAgICAgYWNjZXNzS2V5OiBBdXRoLmV4dHJhY3RBY2Nlc3NLZXkocmVxLCBjb25uZWN0aW9uKSxcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRTcGFuOiBRVHJhY2VyLmV4dHJhY3RQYXJlbnRTcGFuKHRoaXMudHJhY2VyLCBjb25uZWN0aW9uID8gY29ubmVjdGlvbiA6IHJlcSksXHJcbiAgICAgICAgICAgICAgICAgICAgcmVxLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24sXHJcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdCxcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHBsdWdpbnM6IFtcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0RGlkU3RhcnQoX3JlcXVlc3RDb250ZXh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsU2VuZFJlc3BvbnNlKGN0eCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRleHQ6IEdyYXBoUUxSZXF1ZXN0Q29udGV4dCA9IGN0eC5jb250ZXh0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0Lm11bHRpcGxlQWNjZXNzS2V5c0RldGVjdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IFFFcnJvci5tdWx0aXBsZUFjY2Vzc0tleXMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIF0sXHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCBhcG9sbG8gPSBuZXcgQXBvbGxvU2VydmVyKGNvbmZpZyk7XHJcbiAgICAgICAgYXBvbGxvLmFwcGx5TWlkZGxld2FyZSh7XHJcbiAgICAgICAgICAgIGFwcDogdGhpcy5hcHAsXHJcbiAgICAgICAgICAgIHBhdGg6IGVuZFBvaW50LnBhdGgsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGVuZFBvaW50LnN1cHBvcnRTdWJzY3JpcHRpb25zKSB7XHJcbiAgICAgICAgICAgIGFwb2xsby5pbnN0YWxsU3Vic2NyaXB0aW9uSGFuZGxlcnModGhpcy5zZXJ2ZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmVuZFBvaW50cy5wdXNoKGVuZFBvaW50KTtcclxuICAgIH1cclxuXHJcblxyXG59XHJcblxyXG4iXX0=