"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ArangoProvider = void 0;

var _arangochair = _interopRequireDefault(require("arangochair"));

var _arangojs = require("arangojs");

var _events = _interopRequireDefault(require("events"));

var _config = require("../config");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ArangoProvider {
  constructor(log, config) {
    this.log = log;
    this.config = config;
    this.isHotUpdate = false;
    this.started = false;
    this.arango = new _arangojs.Database({
      url: `${(0, _config.ensureProtocol)(config.server, 'http')}`,
      agentOptions: {
        maxSockets: config.maxSockets
      }
    });
    this.arango.useDatabase(config.name);

    if (config.auth) {
      const authParts = config.auth.split(':');
      this.arango.useBasicAuth(authParts[0], authParts.slice(1).join(':'));
    }

    this.collectionsForSubscribe = [];
    this.listener = null;
    this.listenerSubscribers = new _events.default();
    this.listenerSubscribers.setMaxListeners(0);
    this.listenerSubscribersCount = 0;
  }

  start(collectionsForSubscribe) {
    this.started = true;
    this.collectionsForSubscribe = collectionsForSubscribe;
    this.checkStartListener();
  }

  getCollectionIndexes(collection) {
    return this.arango.collection(collection).indexes();
  }

  getCollectionsForSubscribe() {
    return this.collectionsForSubscribe;
  }

  async loadFingerprint(collections) {
    /**
     * Returns object with collections in keys and collection size in values.
     * Because query returns array of values, used reduce to sum it all.
     */
    const results = await Promise.all(collections.map(col => this.query(`RETURN LENGTH(${col})`, {})));
    const lengths = results.map(res => res.reduce((acc, cur) => acc + cur, 0));
    return Object.fromEntries(collections.map((_, i) => [collections[i], lengths[i]]));
  }

  hotUpdate(obj) {}

  async query(text, vars) {
    const cursor = await this.arango.query(text, vars);
    return cursor.all();
  }

  async subscribe(collection, listener) {
    var _this$listenerSubscri;

    (_this$listenerSubscri = this.listenerSubscribers) === null || _this$listenerSubscri === void 0 ? void 0 : _this$listenerSubscri.on(collection, listener);
    this.listenerSubscribersCount += 1;
    this.checkStartListener();
    return {
      collection,
      listener
    };
  }

  unsubscribe(subscription) {
    var _this$listenerSubscri2;

    (_this$listenerSubscri2 = this.listenerSubscribers) === null || _this$listenerSubscri2 === void 0 ? void 0 : _this$listenerSubscri2.removeListener(subscription.collection, subscription.listener);
    this.listenerSubscribersCount = Math.max(this.listenerSubscribersCount - 1, 0);
  } // Internals


  checkStartListener() {
    if (!this.started) {
      return;
    }

    if (this.listener) {
      return;
    }

    if (this.collectionsForSubscribe.length === 0) {
      return;
    }

    if (this.listenerSubscribersCount === 0) {
      return;
    }

    this.listener = this.createAndStartListener();
  }

  createAndStartListener() {
    const {
      server,
      name,
      auth
    } = this.config;
    const listenerUrl = `${(0, _config.ensureProtocol)(server, 'http')}/${name}`;
    const listener = new _arangochair.default(listenerUrl);

    if (this.config.auth) {
      const userPassword = Buffer.from(auth).toString('base64');
      listener.req.opts.headers['Authorization'] = `Basic ${userPassword}`;
    }

    this.collectionsForSubscribe.forEach(collectionName => {
      listener.subscribe({
        collection: collectionName
      });
      listener.on(collectionName, (docJson, type) => {
        if (type === 'insert/update' || type === 'insert' || type === 'update') {
          this.onDataEvent(type, collectionName, docJson);
        }
      });
    });
    listener.on('error', (err, status, headers, body) => {
      let error = err;

      try {
        error = JSON.parse(body);
      } catch {}

      this.log.error('FAILED', 'LISTEN', `${err}`, error);
      setTimeout(() => listener.start(), this.config.listenerRestartTimeout || 1000);
    });
    listener.start();
    return listener;
  }

  onDataEvent(event, collection, doc) {
    var _this$listenerSubscri3;

    (_this$listenerSubscri3 = this.listenerSubscribers) === null || _this$listenerSubscri3 === void 0 ? void 0 : _this$listenerSubscri3.emit(collection, doc, event);
  }

}

exports.ArangoProvider = ArangoProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9hcmFuZ28tcHJvdmlkZXIuanMiXSwibmFtZXMiOlsiQXJhbmdvUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImxvZyIsImNvbmZpZyIsImlzSG90VXBkYXRlIiwic3RhcnRlZCIsImFyYW5nbyIsIkRhdGFiYXNlIiwidXJsIiwic2VydmVyIiwiYWdlbnRPcHRpb25zIiwibWF4U29ja2V0cyIsInVzZURhdGFiYXNlIiwibmFtZSIsImF1dGgiLCJhdXRoUGFydHMiLCJzcGxpdCIsInVzZUJhc2ljQXV0aCIsInNsaWNlIiwiam9pbiIsImNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlIiwibGlzdGVuZXIiLCJsaXN0ZW5lclN1YnNjcmliZXJzIiwiRXZlbnRFbWl0dGVyIiwic2V0TWF4TGlzdGVuZXJzIiwibGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50Iiwic3RhcnQiLCJjaGVja1N0YXJ0TGlzdGVuZXIiLCJnZXRDb2xsZWN0aW9uSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJpbmRleGVzIiwiZ2V0Q29sbGVjdGlvbnNGb3JTdWJzY3JpYmUiLCJsb2FkRmluZ2VycHJpbnQiLCJjb2xsZWN0aW9ucyIsInJlc3VsdHMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiY29sIiwicXVlcnkiLCJsZW5ndGhzIiwicmVzIiwicmVkdWNlIiwiYWNjIiwiY3VyIiwiT2JqZWN0IiwiZnJvbUVudHJpZXMiLCJfIiwiaSIsImhvdFVwZGF0ZSIsIm9iaiIsInRleHQiLCJ2YXJzIiwiY3Vyc29yIiwic3Vic2NyaWJlIiwib24iLCJ1bnN1YnNjcmliZSIsInN1YnNjcmlwdGlvbiIsInJlbW92ZUxpc3RlbmVyIiwiTWF0aCIsIm1heCIsImxlbmd0aCIsImNyZWF0ZUFuZFN0YXJ0TGlzdGVuZXIiLCJsaXN0ZW5lclVybCIsImFyYW5nb2NoYWlyIiwidXNlclBhc3N3b3JkIiwiQnVmZmVyIiwiZnJvbSIsInRvU3RyaW5nIiwicmVxIiwib3B0cyIsImhlYWRlcnMiLCJmb3JFYWNoIiwiY29sbGVjdGlvbk5hbWUiLCJkb2NKc29uIiwidHlwZSIsIm9uRGF0YUV2ZW50IiwiZXJyIiwic3RhdHVzIiwiYm9keSIsImVycm9yIiwiSlNPTiIsInBhcnNlIiwic2V0VGltZW91dCIsImxpc3RlbmVyUmVzdGFydFRpbWVvdXQiLCJldmVudCIsImRvYyIsImVtaXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQXFCTyxNQUFNQSxjQUFOLENBQThDO0FBY2pEQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBWUMsTUFBWixFQUFtQztBQUMxQyxTQUFLRCxHQUFMLEdBQVdBLEdBQVg7QUFDQSxTQUFLQyxNQUFMLEdBQWNBLE1BQWQ7QUFFQSxTQUFLQyxXQUFMLEdBQW1CLEtBQW5CO0FBRUEsU0FBS0MsT0FBTCxHQUFlLEtBQWY7QUFDQSxTQUFLQyxNQUFMLEdBQWMsSUFBSUMsa0JBQUosQ0FBYTtBQUN2QkMsTUFBQUEsR0FBRyxFQUFHLEdBQUUsNEJBQWVMLE1BQU0sQ0FBQ00sTUFBdEIsRUFBOEIsTUFBOUIsQ0FBc0MsRUFEdkI7QUFFdkJDLE1BQUFBLFlBQVksRUFBRTtBQUNWQyxRQUFBQSxVQUFVLEVBQUVSLE1BQU0sQ0FBQ1E7QUFEVDtBQUZTLEtBQWIsQ0FBZDtBQU1BLFNBQUtMLE1BQUwsQ0FBWU0sV0FBWixDQUF3QlQsTUFBTSxDQUFDVSxJQUEvQjs7QUFDQSxRQUFJVixNQUFNLENBQUNXLElBQVgsRUFBaUI7QUFDYixZQUFNQyxTQUFTLEdBQUdaLE1BQU0sQ0FBQ1csSUFBUCxDQUFZRSxLQUFaLENBQWtCLEdBQWxCLENBQWxCO0FBQ0EsV0FBS1YsTUFBTCxDQUFZVyxZQUFaLENBQXlCRixTQUFTLENBQUMsQ0FBRCxDQUFsQyxFQUF1Q0EsU0FBUyxDQUFDRyxLQUFWLENBQWdCLENBQWhCLEVBQW1CQyxJQUFuQixDQUF3QixHQUF4QixDQUF2QztBQUNIOztBQUNELFNBQUtDLHVCQUFMLEdBQStCLEVBQS9CO0FBQ0EsU0FBS0Ms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LEVBQXFCLENBQUNzQixHQUFELEVBQU1DLE1BQU4sRUFBY1AsT0FBZCxFQUF1QlEsSUFBdkIsS0FBZ0M7QUFDakQsVUFBSUMsS0FBSyxHQUFHSCxHQUFaOztBQUNBLFVBQUk7QUFDQUcsUUFBQUEsS0FBSyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0gsSUFBWCxDQUFSO0FBQ0gsT0FGRCxDQUVFLE1BQU0sQ0FDUDs7QUFDRCxXQUFLN0UsR0FBTCxDQUFTOEUsS0FBVCxDQUFlLFFBQWYsRUFBeUIsUUFBekIsRUFBb0MsR0FBRUgsR0FBSSxFQUExQyxFQUE2Q0csS0FBN0M7QUFDQUcsTUFBQUEsVUFBVSxDQUFDLE1BQU05RCxRQUFRLENBQUNLLEtBQVQsRUFBUCxFQUF5QixLQUFLdkIsTUFBTCxDQUFZaUYsc0JBQVosSUFBc0MsSUFBL0QsQ0FBVjtBQUNILEtBUkQ7QUFTQS9ELElBQUFBLFFBQVEsQ0FBQ0ssS0FBVDtBQUNBLFdBQU9MLFFBQVA7QUFDSDs7QUFFRHVELEVBQUFBLFdBQVcsQ0FBQ1MsS0FBRCxFQUFvQnhELFVBQXBCLEVBQXdDeUQsR0FBeEMsRUFBbUQ7QUFBQTs7QUFDMUQsbUNBQUtoRSxtQkFBTCxrRkFBMEJpRSxJQUExQixDQUErQjFELFVBQS9CLEVBQTJDeUQsR0FBM0MsRUFBZ0RELEtBQWhEO0FBQ0g7O0FBNUlnRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5pbXBvcnQgYXJhbmdvY2hhaXIgZnJvbSAnYXJhbmdvY2hhaXInO1xuaW1wb3J0IHsgRGF0YWJhc2UgfSBmcm9tICdhcmFuZ29qcyc7XG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBlbnN1cmVQcm90b2NvbCB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgdHlwZSB7IFFBcmFuZ29Db25maWcgfSBmcm9tICcuLi9jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi4vbG9ncyc7XG5pbXBvcnQgdHlwZSB7IFFEYXRhRXZlbnQsIFFEYXRhUHJvdmlkZXIsIFFEb2MsIFFJbmRleEluZm8gfSBmcm9tICcuL2RhdGEtcHJvdmlkZXInO1xuXG50eXBlIEFyYW5nb0V2ZW50SGFuZGxlciA9IChlcnI6IGFueSwgc3RhdHVzOiBzdHJpbmcsIGhlYWRlcnM6IHsgW3N0cmluZ106IGFueSB9LCBib2R5OiBzdHJpbmcpID0+IHZvaWQ7XG5cbmludGVyZmFjZSBBcmFuZ29MaXN0ZW5lciB7XG4gICAgcmVxOiB7XG4gICAgICAgIG9wdHM6IHtcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgW3N0cmluZ106IGFueSB9LFxuICAgICAgICB9XG4gICAgfTtcblxuICAgIG9uKGV2ZW50OiBzdHJpbmcsIGhhbmRsZXI6IEFyYW5nb0V2ZW50SGFuZGxlcik6IHZvaWQ7XG5cbiAgICBzdWJzY3JpYmUocGFyYW1zOiB7IGNvbGxlY3Rpb246IHN0cmluZyB9KTogdm9pZDtcblxuICAgIHN0YXJ0KCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBBcmFuZ29Qcm92aWRlciBpbXBsZW1lbnRzIFFEYXRhUHJvdmlkZXIge1xuICAgIGxvZzogUUxvZztcbiAgICBjb25maWc6IFFBcmFuZ29Db25maWc7XG5cbiAgICBpc0hvdFVwZGF0ZTogYm9vbGVhbjtcblxuICAgIHN0YXJ0ZWQ6IGJvb2xlYW47XG4gICAgYXJhbmdvOiBEYXRhYmFzZTtcbiAgICBjb2xsZWN0aW9uc0ZvclN1YnNjcmliZTogc3RyaW5nW107XG4gICAgbGlzdGVuZXI6ID9BcmFuZ29MaXN0ZW5lcjtcbiAgICBsaXN0ZW5lclN1YnNjcmliZXJzOiBFdmVudEVtaXR0ZXI7XG4gICAgbGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50OiBudW1iZXI7XG5cblxuICAgIGNvbnN0cnVjdG9yKGxvZzogUUxvZywgY29uZmlnOiBRQXJhbmdvQ29uZmlnKSB7XG4gICAgICAgIHRoaXMubG9nID0gbG9nO1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLmlzSG90VXBkYXRlID0gZmFsc2U7XG5cbiAgICAgICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuYXJhbmdvID0gbmV3IERhdGFiYXNlKHtcbiAgICAgICAgICAgIHVybDogYCR7ZW5zdXJlUHJvdG9jb2woY29uZmlnLnNlcnZlciwgJ2h0dHAnKX1gLFxuICAgICAgICAgICAgYWdlbnRPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgbWF4U29ja2V0czogY29uZmlnLm1heFNvY2tldHMsXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5hcmFuZ28udXNlRGF0YWJhc2UoY29uZmlnLm5hbWUpO1xuICAgICAgICBpZiAoY29uZmlnLmF1dGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGF1dGhQYXJ0cyA9IGNvbmZpZy5hdXRoLnNwbGl0KCc6Jyk7XG4gICAgICAgICAgICB0aGlzLmFyYW5nby51c2VCYXNpY0F1dGgoYXV0aFBhcnRzWzBdLCBhdXRoUGFydHMuc2xpY2UoMSkuam9pbignOicpKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlID0gW107XG4gICAgICAgIHRoaXMubGlzdGVuZXIgPSBudWxsO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnMgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVycy5zZXRNYXhMaXN0ZW5lcnMoMCk7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50ID0gMDtcbiAgICB9XG5cbiAgICBzdGFydChjb2xsZWN0aW9uc0ZvclN1YnNjcmliZTogc3RyaW5nW10pIHtcbiAgICAgICAgdGhpcy5zdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uc0ZvclN1YnNjcmliZSA9IGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlO1xuICAgICAgICB0aGlzLmNoZWNrU3RhcnRMaXN0ZW5lcigpO1xuICAgIH1cblxuICAgIGdldENvbGxlY3Rpb25JbmRleGVzKGNvbGxlY3Rpb246IHN0cmluZyk6IFByb21pc2U8UUluZGV4SW5mb1tdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFyYW5nby5jb2xsZWN0aW9uKGNvbGxlY3Rpb24pLmluZGV4ZXMoKTtcbiAgICB9XG5cbiAgICBnZXRDb2xsZWN0aW9uc0ZvclN1YnNjcmliZSgpOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlO1xuICAgIH1cblxuICAgIGFzeW5jIGxvYWRGaW5nZXJwcmludChjb2xsZWN0aW9uczogc3RyaW5nW10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICAvKipcbiAgICAgICAgICogUmV0dXJucyBvYmplY3Qgd2l0aCBjb2xsZWN0aW9ucyBpbiBrZXlzIGFuZCBjb2xsZWN0aW9uIHNpemUgaW4gdmFsdWVzLlxuICAgICAgICAgKiBCZWNhdXNlIHF1ZXJ5IHJldHVybnMgYXJyYXkgb2YgdmFsdWVzLCB1c2VkIHJlZHVjZSB0byBzdW0gaXQgYWxsLlxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKGNvbGxlY3Rpb25zLm1hcChjb2wgPT4gdGhpcy5xdWVyeShgUkVUVVJOIExFTkdUSCgke2NvbH0pYCwge30pKSlcbiAgICAgICAgY29uc3QgbGVuZ3RocyA9IHJlc3VsdHMubWFwKHJlcyA9PiByZXMucmVkdWNlKChhY2MsIGN1cikgPT4gYWNjICsgY3VyLCAwKSk7XG4gICAgICAgIHJldHVybiBPYmplY3QuZnJvbUVudHJpZXMoY29sbGVjdGlvbnMubWFwKChfLCBpKSA9PiBbY29sbGVjdGlvbnNbaV0sIGxlbmd0aHNbaV1dKSk7XG4gICAgfVxuXG4gICAgaG90VXBkYXRlKG9iajogYW55KTogdm9pZCB7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGN1cnNvciA9IGF3YWl0IHRoaXMuYXJhbmdvLnF1ZXJ5KHRleHQsIHZhcnMpO1xuICAgICAgICByZXR1cm4gY3Vyc29yLmFsbCgpO1xuICAgIH1cblxuICAgIGFzeW5jIHN1YnNjcmliZShjb2xsZWN0aW9uOiBzdHJpbmcsIGxpc3RlbmVyOiAoZG9jOiBhbnksIGV2ZW50OiBRRGF0YUV2ZW50KSA9PiB2b2lkKTogYW55IHtcbiAgICAgICAgdGhpcy5saXN0ZW5lclN1YnNjcmliZXJzPy5vbihjb2xsZWN0aW9uLCBsaXN0ZW5lcik7XG4gICAgICAgIHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50ICs9IDE7XG4gICAgICAgIHRoaXMuY2hlY2tTdGFydExpc3RlbmVyKCk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb2xsZWN0aW9uLFxuICAgICAgICAgICAgbGlzdGVuZXIsXG4gICAgICAgIH07XG4gICAgfVxuXG5cbiAgICB1bnN1YnNjcmliZShzdWJzY3JpcHRpb246IGFueSkge1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnM/LnJlbW92ZUxpc3RlbmVyKHN1YnNjcmlwdGlvbi5jb2xsZWN0aW9uLCBzdWJzY3JpcHRpb24ubGlzdGVuZXIpO1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnNDb3VudCA9IE1hdGgubWF4KHRoaXMubGlzdGVuZXJTdWJzY3JpYmVyc0NvdW50IC0gMSwgMCk7XG4gICAgfVxuXG4gICAgLy8gSW50ZXJuYWxzXG5cbiAgICBjaGVja1N0YXJ0TGlzdGVuZXIoKSB7XG4gICAgICAgIGlmICghdGhpcy5zdGFydGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXIpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5jb2xsZWN0aW9uc0ZvclN1YnNjcmliZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5saXN0ZW5lclN1YnNjcmliZXJzQ291bnQgPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxpc3RlbmVyID0gdGhpcy5jcmVhdGVBbmRTdGFydExpc3RlbmVyKCk7XG4gICAgfVxuXG4gICAgY3JlYXRlQW5kU3RhcnRMaXN0ZW5lcigpOiBBcmFuZ29MaXN0ZW5lciB7XG4gICAgICAgIGNvbnN0IHsgc2VydmVyLCBuYW1lLCBhdXRoIH0gPSB0aGlzLmNvbmZpZztcbiAgICAgICAgY29uc3QgbGlzdGVuZXJVcmwgPSBgJHtlbnN1cmVQcm90b2NvbChzZXJ2ZXIsICdodHRwJyl9LyR7bmFtZX1gO1xuXG4gICAgICAgIGNvbnN0IGxpc3RlbmVyID0gbmV3IGFyYW5nb2NoYWlyKGxpc3RlbmVyVXJsKTtcblxuICAgICAgICBpZiAodGhpcy5jb25maWcuYXV0aCkge1xuICAgICAgICAgICAgY29uc3QgdXNlclBhc3N3b3JkID0gQnVmZmVyLmZyb20oYXV0aCkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgICAgICAgICAgbGlzdGVuZXIucmVxLm9wdHMuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gYEJhc2ljICR7dXNlclBhc3N3b3JkfWA7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlLmZvckVhY2goKGNvbGxlY3Rpb25OYW1lKSA9PiB7XG4gICAgICAgICAgICBsaXN0ZW5lci5zdWJzY3JpYmUoeyBjb2xsZWN0aW9uOiBjb2xsZWN0aW9uTmFtZSB9KTtcbiAgICAgICAgICAgIGxpc3RlbmVyLm9uKGNvbGxlY3Rpb25OYW1lLCAoZG9jSnNvbiwgdHlwZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnaW5zZXJ0L3VwZGF0ZScgfHwgdHlwZSA9PT0gJ2luc2VydCcgfHwgdHlwZSA9PT0gJ3VwZGF0ZScpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkRhdGFFdmVudCh0eXBlLCBjb2xsZWN0aW9uTmFtZSwgZG9jSnNvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG5cbiAgICAgICAgbGlzdGVuZXIub24oJ2Vycm9yJywgKGVyciwgc3RhdHVzLCBoZWFkZXJzLCBib2R5KSA9PiB7XG4gICAgICAgICAgICBsZXQgZXJyb3IgPSBlcnI7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGVycm9yID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ0ZBSUxFRCcsICdMSVNURU4nLCBgJHtlcnJ9YCwgZXJyb3IpO1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBsaXN0ZW5lci5zdGFydCgpLCB0aGlzLmNvbmZpZy5saXN0ZW5lclJlc3RhcnRUaW1lb3V0IHx8IDEwMDApO1xuICAgICAgICB9KTtcbiAgICAgICAgbGlzdGVuZXIuc3RhcnQoKTtcbiAgICAgICAgcmV0dXJuIGxpc3RlbmVyO1xuICAgIH1cblxuICAgIG9uRGF0YUV2ZW50KGV2ZW50OiBRRGF0YUV2ZW50LCBjb2xsZWN0aW9uOiBzdHJpbmcsIGRvYzogUURvYykge1xuICAgICAgICB0aGlzLmxpc3RlbmVyU3Vic2NyaWJlcnM/LmVtaXQoY29sbGVjdGlvbiwgZG9jLCBldmVudCk7XG4gICAgfVxuXG59XG4iXX0=