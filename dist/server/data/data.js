"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _collection = require("./collection");

var _auth = require("../auth");

var _config = require("../config");

var _logs = _interopRequireDefault(require("../logs"));

var _opentracing = require("opentracing");

var _tracer = require("../tracer");

var _utils = require("../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
class QData {
  // Dependencies
  // Own
  constructor(options) {
    this.providers = options.providers;
    this.slowQueriesProviders = options.slowQueriesProviders || options.providers;
    this.logs = options.logs;
    this.stats = options.stats;
    this.auth = options.auth;
    this.tracer = options.tracer;
    this.isTests = options.isTests;
    this.log = this.logs.create('data');
    this.statPostCount = new _tracer.StatsCounter(this.stats, _config.STATS.post.count, []);
    this.statPostFailed = new _tracer.StatsCounter(this.stats, _config.STATS.post.failed, []);
    this.collections = [];
    this.collectionsByName = new Map();
  }

  addCollection(name, docType, mutable, indexes) {
    const collection = new _collection.QDataCollection({
      name,
      docType,
      mutable,
      indexes,
      provider: mutable ? this.providers.mutable : this.providers.immutable,
      slowQueriesProvider: mutable ? this.providers.mutable : this.slowQueriesProviders.immutable,
      logs: this.logs,
      auth: this.auth,
      tracer: this.tracer,
      stats: this.stats,
      isTests: this.isTests
    });
    this.collections.push(collection);
    this.collectionsByName.set(name, collection);
    return collection;
  }

  async start() {
    const mutable = [];
    const immutable = [];
    this.collections.forEach(x => (x.mutable ? mutable : immutable).push(x.name));
    await this.providers.mutable.start(mutable);
    await this.providers.immutable.start(immutable);
    await this.slowQueriesProviders.mutable.start([]);
    await this.slowQueriesProviders.immutable.start([]);
    await this.providers.immutable.hotUpdate();
  }

  async dropCachedDbInfo() {
    this.collections.forEach(x => x.dropCachedDbInfo());
    await this.providers.immutable.hotUpdate();
  }

  async query(provider, text, vars, orderBy) {
    return (0, _utils.wrap)(this.log, 'QUERY', {
      text,
      vars
    }, async () => {
      return provider.query(text, vars, orderBy);
    });
  }

  async finishOperations(operationIds) {
    let count = 0;
    this.collections.forEach(x => count += x.finishOperations(operationIds));
    return count;
  }

}

exports.default = QData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9kYXRhLmpzIl0sIm5hbWVzIjpbIlFEYXRhIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwicHJvdmlkZXJzIiwic2xvd1F1ZXJpZXNQcm92aWRlcnMiLCJsb2dzIiwic3RhdHMiLCJhdXRoIiwidHJhY2VyIiwiaXNUZXN0cyIsImxvZyIsImNyZWF0ZSIsInN0YXRQb3N0Q291bnQiLCJTdGF0c0NvdW50ZXIiLCJTVEFUUyIsInBvc3QiLCJjb3VudCIsInN0YXRQb3N0RmFpbGVkIiwiZmFpbGVkIiwiY29sbGVjdGlvbnMiLCJjb2xsZWN0aW9uc0J5TmFtZSIsIk1hcCIsImFkZENvbGxlY3Rpb24iLCJuYW1lIiwiZG9jVHlwZSIsIm11dGFibGUiLCJpbmRleGVzIiwiY29sbGVjdGlvbiIsIlFEYXRhQ29sbGVjdGlvbiIsInByb3ZpZGVyIiwiaW1tdXRhYmxlIiwic2xvd1F1ZXJpZXNQcm92aWRlciIsInB1c2giLCJzZXQiLCJzdGFydCIsImZvckVhY2giLCJ4IiwiaG90VXBkYXRlIiwiZHJvcENhY2hlZERiSW5mbyIsInF1ZXJ5IiwidGV4dCIsInZhcnMiLCJvcmRlckJ5IiwiZmluaXNoT3BlcmF0aW9ucyIsIm9wZXJhdGlvbklkcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUFFQTs7OztBQTNCQTs7Ozs7Ozs7Ozs7Ozs7O0FBOENlLE1BQU1BLEtBQU4sQ0FBWTtBQUN2QjtBQVNBO0FBUUFDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FBRCxFQUF3QjtBQUMvQixTQUFLQyxTQUFMLEdBQWlCRCxPQUFPLENBQUNDLFNBQXpCO0FBQ0EsU0FBS0Msb0JBQUwsR0FBNEJGLE9BQU8sQ0FBQ0Usb0JBQVIsSUFBZ0NGLE9BQU8sQ0FBQ0MsU0FBcEU7QUFDQSxTQUFLRSxJQUFMLEdBQVlILE9BQU8sQ0FBQ0csSUFBcEI7QUFDQSxTQUFLQyxLQUFMLEdBQWFKLE9BQU8sQ0FB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QWYsQ0FBeUJPLFNBQXpCLEVBQU47QUFDSDs7QUFFRCxRQUFNRSxLQUFOLENBQVlWLFFBQVosRUFBcUNXLElBQXJDLEVBQW1EQyxJQUFuRCxFQUE0RUMsT0FBNUUsRUFBZ0c7QUFDNUYsV0FBTyxpQkFBSyxLQUFLaEMsR0FBVixFQUFlLE9BQWYsRUFBd0I7QUFBRThCLE1BQUFBLElBQUY7QUFBUUMsTUFBQUE7QUFBUixLQUF4QixFQUF3QyxZQUFZO0FBQ3ZELGFBQU9aLFFBQVEsQ0FBQ1UsS0FBVCxDQUFlQyxJQUFmLEVBQXFCQyxJQUFyQixFQUEyQkMsT0FBM0IsQ0FBUDtBQUNILEtBRk0sQ0FBUDtBQUdIOztBQUVELFFBQU1DLGdCQUFOLENBQXVCQyxZQUF2QixFQUFtRTtBQUMvRCxRQUFJNUIsS0FBSyxHQUFHLENBQVo7QUFDQSxTQUFLRyxXQUFMLENBQWlCZ0IsT0FBakIsQ0FBeUJDLENBQUMsSUFBS3BCLEtBQUssSUFBSW9CLENBQUMsQ0FBQ08sZ0JBQUYsQ0FBbUJDLFlBQW5CLENBQXhDO0FBQ0EsV0FBTzVCLEtBQVA7QUFDSDs7QUFqRnNCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBTT0ZUV0FSRSBFVkFMVUFUSU9OIExpY2Vuc2UgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXkgbm90IHVzZVxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXG4gKiBMaWNlbnNlIGF0OlxuICpcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgVE9OIERFViBzb2Z0d2FyZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBAZmxvd1xuXG5pbXBvcnQgeyBRRGF0YUNvbGxlY3Rpb24gfSBmcm9tICcuL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHsgQXV0aCB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0IHsgU1RBVFMgfSBmcm9tICcuLi9jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi4vbG9ncyc7XG5pbXBvcnQgUUxvZ3MgZnJvbSAnLi4vbG9ncydcbmltcG9ydCB0eXBlIHsgT3JkZXJCeSwgUVR5cGUgfSBmcm9tICcuLi9maWx0ZXIvZmlsdGVycyc7XG5pbXBvcnQgeyBUcmFjZXIgfSBmcm9tICdvcGVudHJhY2luZyc7XG5pbXBvcnQgeyBTdGF0c0NvdW50ZXIgfSBmcm9tICcuLi90cmFjZXInO1xuaW1wb3J0IHR5cGUgeyBJU3RhdHMgfSBmcm9tICcuLi90cmFjZXInO1xuaW1wb3J0IHsgd3JhcCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB0eXBlIHsgUURhdGFQcm92aWRlciwgUUluZGV4SW5mbyB9IGZyb20gJy4vZGF0YS1wcm92aWRlcic7XG5cbmV4cG9ydCB0eXBlIFFEYXRhUHJvdmlkZXJzID0ge1xuICAgIG11dGFibGU6IFFEYXRhUHJvdmlkZXIsXG4gICAgaW1tdXRhYmxlOiBRRGF0YVByb3ZpZGVyLFxufVxuXG5leHBvcnQgdHlwZSBRRGF0YU9wdGlvbnMgPSB7XG4gICAgcHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVycyxcbiAgICBzbG93UXVlcmllc1Byb3ZpZGVycz86IFFEYXRhUHJvdmlkZXJzLFxuXG4gICAgbG9nczogUUxvZ3MsXG4gICAgYXV0aDogQXV0aCxcbiAgICB0cmFjZXI6IFRyYWNlcixcbiAgICBzdGF0czogSVN0YXRzLFxuICAgIGlzVGVzdHM6IGJvb2xlYW4sXG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFFEYXRhIHtcbiAgICAvLyBEZXBlbmRlbmNpZXNcbiAgICBwcm92aWRlcnM6IFFEYXRhUHJvdmlkZXJzO1xuICAgIHNsb3dRdWVyaWVzUHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVycztcbiAgICBsb2dzOiBRTG9ncztcbiAgICBzdGF0czogSVN0YXRzO1xuICAgIGF1dGg6IEF1dGg7XG4gICAgdHJhY2VyOiBUcmFjZXI7XG4gICAgaXNUZXN0czogYm9vbGVhbjtcblxuICAgIC8vIE93blxuICAgIGxvZzogUUxvZztcbiAgICBzdGF0UG9zdENvdW50OiBTdGF0c0NvdW50ZXI7XG4gICAgc3RhdFBvc3RGYWlsZWQ6IFN0YXRzQ291bnRlcjtcblxuICAgIGNvbGxlY3Rpb25zOiBRRGF0YUNvbGxlY3Rpb25bXTtcbiAgICBjb2xsZWN0aW9uc0J5TmFtZTogTWFwPHN0cmluZywgUURhdGFDb2xsZWN0aW9uPjtcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFFEYXRhT3B0aW9ucykge1xuICAgICAgICB0aGlzLnByb3ZpZGVycyA9IG9wdGlvbnMucHJvdmlkZXJzO1xuICAgICAgICB0aGlzLnNsb3dRdWVyaWVzUHJvdmlkZXJzID0gb3B0aW9ucy5zbG93UXVlcmllc1Byb3ZpZGVycyB8fCBvcHRpb25zLnByb3ZpZGVycztcbiAgICAgICAgdGhpcy5sb2dzID0gb3B0aW9ucy5sb2dzO1xuICAgICAgICB0aGlzLnN0YXRzID0gb3B0aW9ucy5zdGF0cztcbiAgICAgICAgdGhpcy5hdXRoID0gb3B0aW9ucy5hdXRoO1xuICAgICAgICB0aGlzLnRyYWNlciA9IG9wdGlvbnMudHJhY2VyO1xuICAgICAgICB0aGlzLmlzVGVzdHMgPSBvcHRpb25zLmlzVGVzdHM7XG5cbiAgICAgICAgdGhpcy5sb2cgPSB0aGlzLmxvZ3MuY3JlYXRlKCdkYXRhJyk7XG5cbiAgICAgICAgdGhpcy5zdGF0UG9zdENvdW50ID0gbmV3IFN0YXRzQ291bnRlcih0aGlzLnN0YXRzLCBTVEFUUy5wb3N0LmNvdW50LCBbXSk7XG4gICAgICAgIHRoaXMuc3RhdFBvc3RGYWlsZWQgPSBuZXcgU3RhdHNDb3VudGVyKHRoaXMuc3RhdHMsIFNUQVRTLnBvc3QuZmFpbGVkLCBbXSk7XG5cbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucyA9IFtdO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zQnlOYW1lID0gbmV3IE1hcCgpO1xuICAgIH1cblxuICAgIGFkZENvbGxlY3Rpb24obmFtZTogc3RyaW5nLCBkb2NUeXBlOiBRVHlwZSwgbXV0YWJsZTogYm9vbGVhbiwgaW5kZXhlczogUUluZGV4SW5mb1tdKSB7XG4gICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBuZXcgUURhdGFDb2xsZWN0aW9uKHtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICBkb2NUeXBlLFxuICAgICAgICAgICAgbXV0YWJsZSxcbiAgICAgICAgICAgIGluZGV4ZXMsXG4gICAgICAgICAgICBwcm92aWRlcjogbXV0YWJsZSA/IHRoaXMucHJvdmlkZXJzLm11dGFibGUgOiB0aGlzLnByb3ZpZGVycy5pbW11dGFibGUsXG4gICAgICAgICAgICBzbG93UXVlcmllc1Byb3ZpZGVyOiBtdXRhYmxlID8gdGhpcy5wcm92aWRlcnMubXV0YWJsZSA6IHRoaXMuc2xvd1F1ZXJpZXNQcm92aWRlcnMuaW1tdXRhYmxlLFxuICAgICAgICAgICAgbG9nczogdGhpcy5sb2dzLFxuICAgICAgICAgICAgYXV0aDogdGhpcy5hdXRoLFxuICAgICAgICAgICAgdHJhY2VyOiB0aGlzLnRyYWNlcixcbiAgICAgICAgICAgIHN0YXRzOiB0aGlzLnN0YXRzLFxuICAgICAgICAgICAgaXNUZXN0czogdGhpcy5pc1Rlc3RzLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucy5wdXNoKGNvbGxlY3Rpb24pO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25zQnlOYW1lLnNldChuYW1lLCBjb2xsZWN0aW9uKTtcbiAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb247XG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnQoKSB7XG4gICAgICAgIGNvbnN0IG11dGFibGUgPSBbXTtcbiAgICAgICAgY29uc3QgaW1tdXRhYmxlID0gW107XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMuZm9yRWFjaCh4ID0+ICh4Lm11dGFibGUgPyBtdXRhYmxlIDogaW1tdXRhYmxlKS5wdXNoKHgubmFtZSkpO1xuICAgICAgICBhd2FpdCB0aGlzLnByb3ZpZGVycy5tdXRhYmxlLnN0YXJ0KG11dGFibGUpO1xuICAgICAgICBhd2FpdCB0aGlzLnByb3ZpZGVycy5pbW11dGFibGUuc3RhcnQoaW1tdXRhYmxlKTtcbiAgICAgICAgYXdhaXQgdGhpcy5zbG93UXVlcmllc1Byb3ZpZGVycy5tdXRhYmxlLnN0YXJ0KFtdKTtcbiAgICAgICAgYXdhaXQgdGhpcy5zbG93UXVlcmllc1Byb3ZpZGVycy5pbW11dGFibGUuc3RhcnQoW10pO1xuICAgICAgICBhd2FpdCB0aGlzLnByb3ZpZGVycy5pbW11dGFibGUuaG90VXBkYXRlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgZHJvcENhY2hlZERiSW5mbygpIHtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9ucy5mb3JFYWNoKCh4OiBRRGF0YUNvbGxlY3Rpb24pID0+IHguZHJvcENhY2hlZERiSW5mbygpKTtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm92aWRlcnMuaW1tdXRhYmxlLmhvdFVwZGF0ZSgpO1xuICAgIH1cblxuICAgIGFzeW5jIHF1ZXJ5KHByb3ZpZGVyOiBRRGF0YVByb3ZpZGVyLCB0ZXh0OiBzdHJpbmcsIHZhcnM6IHsgW3N0cmluZ106IGFueSB9LCBvcmRlckJ5OiBPcmRlckJ5W10pIHtcbiAgICAgICAgcmV0dXJuIHdyYXAodGhpcy5sb2csICdRVUVSWScsIHsgdGV4dCwgdmFycyB9LCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gcHJvdmlkZXIucXVlcnkodGV4dCwgdmFycywgb3JkZXJCeSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzOiBTZXQ8c3RyaW5nPik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbnMuZm9yRWFjaCh4ID0+IChjb3VudCArPSB4LmZpbmlzaE9wZXJhdGlvbnMob3BlcmF0aW9uSWRzKSkpO1xuICAgICAgICByZXR1cm4gY291bnQ7XG4gICAgfVxufVxuIl19