"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sortedIndex = sortedIndex;
exports.missingDataCache = exports.QDataPrecachedCombiner = exports.QDataCombiner = exports.dataEvent = void 0;

var _utils = require("../utils");

const dataEvent = {
  UPSERT: 'insert/update',
  INSERT: 'insert',
  UPDATE: 'update'
};
exports.dataEvent = dataEvent;

class QDataCombiner {
  constructor(providers) {
    this.providers = providers;
  }

  async start(collectionsForSubscribe) {
    await Promise.all(this.providers.map((x, i) => x.start(i === 0 ? collectionsForSubscribe : [])));
  }

  getCollectionIndexes(collection) {
    return this.providers[0].getCollectionIndexes(collection);
  }

  async loadFingerprint() {
    /** TODO: remove
     * Do not build fingerprint from a `hot` database (index=0).
     * We make fingerprints about the size of collections only on `cold` storages (index>0).
     * The updated fingerprint will change the cache key and the old keys will be removed using by DataCache itself.
     */
    return await Promise.all(this.providers.map(provider => provider.loadFingerprint()));
  }

  async hotUpdate() {
    await Promise.all(this.providers.map(provider => provider.hotUpdate()));
  }

  async query(text, vars, orderBy) {
    const results = await Promise.all(this.providers.map(x => x.query(text, vars, orderBy)));
    return combineResults(results, orderBy);
  }

  subscribe(collection, listener) {
    return this.providers[0].subscribe(collection, listener);
  }

  unsubscribe(subscription) {
    this.providers[0].unsubscribe(subscription);
  }

}

exports.QDataCombiner = QDataCombiner;

class QDataPrecachedCombiner extends QDataCombiner {
  constructor(log, cache, providers, networkName, cacheKeyPrefix) {
    super(providers);
    this.log = log;
    this.cache = cache;
    this.networkName = networkName;
    this.cacheKeyPrefix = cacheKeyPrefix;
    this.configHash = '';
  }

  async hotUpdate() {
    const fingerprint = JSON.stringify(await this.loadFingerprint());
    this.log.debug('FINGERPRINT', fingerprint);
    this.configHash = (0, _utils.hash)(this.networkName, fingerprint);
    await super.hotUpdate();
  }

  cacheKey(aql) {
    return this.cacheKeyPrefix + (0, _utils.hash)(this.configHash, aql);
  }

  async query(text, vars, orderBy) {
    const aql = JSON.stringify({
      text,
      vars,
      orderBy
    });
    const key = this.cacheKey(aql);
    let docs = await this.cache.get(key);

    if (isNullOrUndefined(docs)) {
      docs = await super.query(text, vars, orderBy);
      await this.cache.set(key, docs);
    }

    return docs;
  }

}

exports.QDataPrecachedCombiner = QDataPrecachedCombiner;

function combineResults(results, orderBy) {
  const docs = collectDistinctDocs(results);

  if (orderBy.length > 0) {
    docs.sort((a, b) => compareDocs(a, b, orderBy));
  }

  return docs;
}

function collectDistinctDocs(source) {
  const distinctDocs = [];
  const distinctKeys = new Set();
  source.forEach(docs => {
    docs.forEach(doc => {
      if (!doc._key) {
        distinctDocs.push(doc);
      } else if (!distinctKeys.has(doc._key)) {
        distinctDocs.push(doc);
        distinctKeys.add(doc._key);
      }
    });
  });
  return distinctDocs;
}

function compareDocs(a, b, orderBy) {
  for (let i = 0; i < orderBy.length; i += 1) {
    const field = orderBy[i];
    const path = field.path.split('.');
    const aValue = getValue(a, path, 0);
    const bValue = getValue(b, path, 0);
    let comparison = compareValues(aValue, bValue);

    if (comparison !== 0) {
      return field.direction === 'DESC' ? -comparison : comparison;
    }
  }

  return 0;
}

function getValue(value, path, pathIndex) {
  if (isNullOrUndefined(value) || pathIndex >= path.length) {
    return value;
  }

  const name = path[pathIndex] === 'id' ? '_key' : path[pathIndex];
  return getValue(value[name], path, pathIndex + 1);
}

function compareValues(a, b) {
  const aHasValue = !isNullOrUndefined(a);
  const bHasValue = !isNullOrUndefined(b);

  if (!aHasValue) {
    return bHasValue ? -1 : 0;
  }

  if (!bHasValue) {
    return 1;
  }

  return a === b ? 0 : a < b ? -1 : 0;
}

function isNullOrUndefined(v) {
  return v === null || typeof v === 'undefined';
}

function sortedIndex(fields) {
  return {
    type: 'persistent',
    fields
  };
}

const missingDataCache = {
  get(_key) {
    return Promise.resolve(null);
  },

  set(_key, _value) {
    return Promise.resolve();
  }

};
exports.missingDataCache = missingDataCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9kYXRhLXByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbImRhdGFFdmVudCIsIlVQU0VSVCIsIklOU0VSVCIsIlVQREFURSIsIlFEYXRhQ29tYmluZXIiLCJjb25zdHJ1Y3RvciIsInByb3ZpZGVycyIsInN0YXJ0IiwiY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwieCIsImkiLCJnZXRDb2xsZWN0aW9uSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJsb2FkRmluZ2VycHJpbnQiLCJwcm92aWRlciIsImhvdFVwZGF0ZSIsInF1ZXJ5IiwidGV4dCIsInZhcnMiLCJvcmRlckJ5IiwicmVzdWx0cyIsImNvbWJpbmVSZXN1bHRzIiwic3Vic2NyaWJlIiwibGlzdGVuZXIiLCJ1bnN1YnNjcmliZSIsInN1YnNjcmlwdGlvbiIsIlFEYXRhUHJlY2FjaGVkQ29tYmluZXIiLCJsb2ciLCJjYWNoZSIsIm5ldHdvcmtOYW1lIiwiY2FjaGVLZXlQcmVmaXgiLCJjb25maWdIYXNoIiwiZmluZ2VycHJpbnQiLCJKU09OIiwic3RyaW5naWZ5IiwiZGVidWciLCJjYWNoZUtleSIsImFxbCIsImtleSIsImRvY3MiLCJnZXQiLCJpc051bGxPclVuZGVmaW5lZCIsInNldCIsImNvbGxlY3REaXN0aW5jdERvY3MiLCJsZW5ndGgiLCJzb3J0IiwiYSIsImIiLCJjb21wYXJlRG9jcyIsInNvdXJjZSIsImRpc3RpbmN0RG9jcyIsImRpc3RpbmN0S2V5cyIsIlNldCIsImZvckVhY2giLCJkb2MiLCJfa2V5IiwicHVzaCIsImhhcyIsImFkZCIsImZpZWxkIiwicGF0aCIsInNwbGl0IiwiYVZhbHVlIiwiZ2V0VmFsdWUiLCJiVmFsdWUiLCJjb21wYXJpc29uIiwiY29tcGFyZVZhbHVlcyIsImRpcmVjdGlvbiIsInZhbHVlIiwicGF0aEluZGV4IiwibmFtZSIsImFIYXNWYWx1ZSIsImJIYXNWYWx1ZSIsInYiLCJzb3J0ZWRJ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TCxFQUFnQjtBQUNaLFdBQU8sQ0FBUDtBQUNIOztBQUNELFNBQU8xQixDQUFDLEtBQUtDLENBQU4sR0FBVSxDQUFWLEdBQWVELENBQUMsR0FBR0MsQ0FBSixHQUFRLENBQUMsQ0FBVCxHQUFhLENBQW5DO0FBQ0g7O0FBR0QsU0FBU04saUJBQVQsQ0FBMkJnQyxDQUEzQixFQUE0QztBQUN4QyxTQUFPQSxDQUFDLEtBQUssSUFBTixJQUFjLE9BQU9BLENBQVAsS0FBYSxXQUFsQztBQUNIOztBQUVNLFNBQVNDLFdBQVQsQ0FBcUJDLE1BQXJCLEVBQW1EO0FBQ3RELFNBQU87QUFBRUMsSUFBQUEsSUFBSSxFQUFFLFlBQVI7QUFBc0JELElBQUFBO0FBQXRCLEdBQVA7QUFDSDs7QUFFTSxNQUFNRSxnQkFBNEIsR0FBRztBQUN4Q3JDLEVBQUFBLEdBQUcsQ0FBQ2UsSUFBRCxFQUE2QjtBQUM1QixXQUFPakQsT0FBTyxDQUFDd0UsT0FBUixDQUFnQixJQUFoQixDQUFQO0FBQ0gsR0FIdUM7O0FBS3hDcEMsRUFBQUEsR0FBRyxDQUFDYSxJQUFELEVBQWV3QixNQUFmLEVBQTJDO0FBQzFDLFdBQU96RSxPQUFPLENBQUN3RSxPQUFSLEVBQVA7QUFDSDs7QUFQdUMsQ0FBckMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSB7IE9yZGVyQnkgfSBmcm9tICcuLi9maWx0ZXIvZmlsdGVycyc7XG5pbXBvcnQgeyBoYXNoIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHR5cGUgeyBRTG9nIH0gZnJvbSAnLi4vbG9ncyc7XG5cbmV4cG9ydCB0eXBlIFFJbmRleEluZm8gPSB7XG4gICAgZmllbGRzOiBzdHJpbmdbXSxcbiAgICB0eXBlPzogc3RyaW5nLFxufVxuXG5cbmV4cG9ydCB0eXBlIFFEb2MgPSB7XG4gICAgX2tleTogc3RyaW5nO1xuICAgIFtzdHJpbmddOiBhbnk7XG59O1xuXG5cbmV4cG9ydCB0eXBlIFFEYXRhRXZlbnQgPSAnaW5zZXJ0L3VwZGF0ZScgfCAnaW5zZXJ0JyB8ICd1cGRhdGUnO1xuZXhwb3J0IGNvbnN0IGRhdGFFdmVudCA9IHtcbiAgICBVUFNFUlQ6ICdpbnNlcnQvdXBkYXRlJyxcbiAgICBJTlNFUlQ6ICdpbnNlcnQnLFxuICAgIFVQREFURTogJ3VwZGF0ZScsXG59O1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgUURhdGFQcm92aWRlciB7XG4gICAgc3RhcnQoY29sbGVjdGlvbnNGb3JTdWJzY3JpYmU6IHN0cmluZ1tdKTogUHJvbWlzZTxhbnk+O1xuXG4gICAgZ2V0Q29sbGVjdGlvbkluZGV4ZXMoY29sbGVjdGlvbjogc3RyaW5nKTogUHJvbWlzZTxRSW5kZXhJbmZvW10+O1xuXG4gICAgbG9hZEZpbmdlcnByaW50KCk6IFByb21pc2U8YW55PjtcblxuICAgIGhvdFVwZGF0ZSgpOiBQcm9taXNlPGFueT47XG5cbiAgICBxdWVyeSh0ZXh0OiBzdHJpbmcsIHZhcnM6IHsgW3N0cmluZ106IGFueSB9LCBvcmRlckJ5OiBPcmRlckJ5W10pOiBQcm9taXNlPGFueT47XG5cbiAgICBzdWJzY3JpYmUoY29sbGVjdGlvbjogc3RyaW5nLCBsaXN0ZW5lcjogKGRvYzogYW55LCBldmVudDogUURhdGFFdmVudCkgPT4gdm9pZCk6IGFueTtcblxuICAgIHVuc3Vic2NyaWJlKHN1YnNjcmlwdGlvbjogYW55KTogdm9pZDtcbn1cblxuXG5leHBvcnQgaW50ZXJmYWNlIFFEYXRhQ2FjaGUge1xuICAgIGdldChrZXk6IHN0cmluZyk6IFByb21pc2U8YW55PjtcblxuICAgIHNldChrZXk6IHN0cmluZywgdmFsdWU6IGFueSk6IFByb21pc2U8dm9pZD47XG59XG5cbmV4cG9ydCBjbGFzcyBRRGF0YUNvbWJpbmVyIGltcGxlbWVudHMgUURhdGFQcm92aWRlciB7XG4gICAgcHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVyW107XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm92aWRlcnM6IFFEYXRhUHJvdmlkZXJbXSkge1xuICAgICAgICB0aGlzLnByb3ZpZGVycyA9IHByb3ZpZGVycztcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydChjb2xsZWN0aW9uc0ZvclN1YnNjcmliZTogc3RyaW5nW10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLnByb3ZpZGVycy5tYXAoKHgsIGkpID0+IHguc3RhcnQoaSA9PT0gMCA/IGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlIDogW10pKSk7XG4gICAgfVxuXG4gICAgZ2V0Q29sbGVjdGlvbkluZGV4ZXMoY29sbGVjdGlvbjogc3RyaW5nKTogUHJvbWlzZTxRSW5kZXhJbmZvW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvdmlkZXJzWzBdLmdldENvbGxlY3Rpb25JbmRleGVzKGNvbGxlY3Rpb24pO1xuICAgIH1cblxuICAgIGFzeW5jIGxvYWRGaW5nZXJwcmludCgpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICAvKiogVE9ETzogcmVtb3ZlXG4gICAgICAgICAqIERvIG5vdCBidWlsZCBmaW5nZXJwcmludCBmcm9tIGEgYGhvdGAgZGF0YWJhc2UgKGluZGV4PTApLlxuICAgICAgICAgKiBXZSBtYWtlIGZpbmdlcnByaW50cyBhYm91dCB0aGUgc2l6ZSBvZiBjb2xsZWN0aW9ucyBvbmx5IG9uIGBjb2xkYCBzdG9yYWdlcyAoaW5kZXg+MCkuXG4gICAgICAgICAqIFRoZSB1cGRhdGVkIGZpbmdlcnByaW50IHdpbGwgY2hhbmdlIHRoZSBjYWNoZSBrZXkgYW5kIHRoZSBvbGQga2V5cyB3aWxsIGJlIHJlbW92ZWQgdXNpbmcgYnkgRGF0YUNhY2hlIGl0c2VsZi5cbiAgICAgICAgICovXG4gICAgICAgIHJldHVybiBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLnByb3ZpZGVycy5tYXAocHJvdmlkZXIgPT4gcHJvdmlkZXIubG9hZEZpbmdlcnByaW50KCkpKTtcbiAgICB9XG5cbiAgICBhc3luYyBob3RVcGRhdGUoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5wcm92aWRlcnMubWFwKHByb3ZpZGVyID0+IHByb3ZpZGVyLmhvdFVwZGF0ZSgpKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSwgb3JkZXJCeTogT3JkZXJCeVtdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKHRoaXMucHJvdmlkZXJzLm1hcCh4ID0+IHgucXVlcnkodGV4dCwgdmFycywgb3JkZXJCeSkpKTtcbiAgICAgICAgcmV0dXJuIGNvbWJpbmVSZXN1bHRzKHJlc3VsdHMsIG9yZGVyQnkpO1xuICAgIH1cblxuICAgIHN1YnNjcmliZShjb2xsZWN0aW9uOiBzdHJpbmcsIGxpc3RlbmVyOiAoZG9jOiBhbnksIGV2ZW50OiBRRGF0YUV2ZW50KSA9PiB2b2lkKTogYW55IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvdmlkZXJzWzBdLnN1YnNjcmliZShjb2xsZWN0aW9uLCBsaXN0ZW5lcik7XG4gICAgfVxuXG4gICAgdW5zdWJzY3JpYmUoc3Vic2NyaXB0aW9uOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wcm92aWRlcnNbMF0udW5zdWJzY3JpYmUoc3Vic2NyaXB0aW9uKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBRRGF0YVByZWNhY2hlZENvbWJpbmVyIGV4dGVuZHMgUURhdGFDb21iaW5lciB7XG4gICAgbG9nOiBRTG9nO1xuICAgIGNhY2hlOiBRRGF0YUNhY2hlO1xuICAgIG5ldHdvcmtOYW1lOiBzdHJpbmc7XG4gICAgY2FjaGVLZXlQcmVmaXg6IHN0cmluZztcbiAgICBjb25maWdIYXNoOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3Rvcihsb2c6IFFMb2csIGNhY2hlOiBRRGF0YUNhY2hlLCBwcm92aWRlcnM6IFFEYXRhUHJvdmlkZXJbXSwgbmV0d29ya05hbWU6IHN0cmluZywgY2FjaGVLZXlQcmVmaXg6IHN0cmluZykge1xuICAgICAgICBzdXBlcihwcm92aWRlcnMpO1xuICAgICAgICB0aGlzLmxvZyA9IGxvZztcbiAgICAgICAgdGhpcy5jYWNoZSA9IGNhY2hlO1xuICAgICAgICB0aGlzLm5ldHdvcmtOYW1lID0gbmV0d29ya05hbWU7XG4gICAgICAgIHRoaXMuY2FjaGVLZXlQcmVmaXggPSBjYWNoZUtleVByZWZpeDtcbiAgICAgICAgdGhpcy5jb25maWdIYXNoID0gJyc7XG4gICAgfVxuXG4gICAgYXN5bmMgaG90VXBkYXRlKCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGZpbmdlcnByaW50ID0gSlNPTi5zdHJpbmdpZnkoYXdhaXQgdGhpcy5sb2FkRmluZ2VycHJpbnQoKSk7XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCdGSU5HRVJQUklOVCcsIGZpbmdlcnByaW50KTtcbiAgICAgICAgdGhpcy5jb25maWdIYXNoID0gaGFzaCh0aGlzLm5ldHdvcmtOYW1lLCBmaW5nZXJwcmludCk7XG4gICAgICAgIGF3YWl0IHN1cGVyLmhvdFVwZGF0ZSgpO1xuICAgIH1cblxuICAgIGNhY2hlS2V5KGFxbDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVLZXlQcmVmaXggKyBoYXNoKHRoaXMuY29uZmlnSGFzaCwgYXFsKTtcbiAgICB9XG5cbiAgICBhc3luYyBxdWVyeSh0ZXh0OiBzdHJpbmcsIHZhcnM6IHsgW3N0cmluZ106IGFueSB9LCBvcmRlckJ5OiBPcmRlckJ5W10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBhcWwgPSBKU09OLnN0cmluZ2lmeSh7IHRleHQsIHZhcnMsIG9yZGVyQnkgfSk7XG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMuY2FjaGVLZXkoYXFsKTtcbiAgICAgICAgbGV0IGRvY3MgPSBhd2FpdCB0aGlzLmNhY2hlLmdldChrZXkpO1xuICAgICAgICBpZiAoaXNOdWxsT3JVbmRlZmluZWQoZG9jcykpIHtcbiAgICAgICAgICAgIGRvY3MgPSBhd2FpdCBzdXBlci5xdWVyeSh0ZXh0LCB2YXJzLCBvcmRlckJ5KTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2FjaGUuc2V0KGtleSwgZG9jcyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRvY3M7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjb21iaW5lUmVzdWx0cyhyZXN1bHRzOiBhbnlbXVtdLCBvcmRlckJ5OiBPcmRlckJ5W10pOiBhbnlbXSB7XG4gICAgY29uc3QgZG9jcyA9IGNvbGxlY3REaXN0aW5jdERvY3MocmVzdWx0cyk7XG4gICAgaWYgKG9yZGVyQnkubGVuZ3RoID4gMCkge1xuICAgICAgICBkb2NzLnNvcnQoKGE6IFFEb2MsIGI6IFFEb2MpID0+IGNvbXBhcmVEb2NzKGEsIGIsIG9yZGVyQnkpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRvY3M7XG59XG5cblxuZnVuY3Rpb24gY29sbGVjdERpc3RpbmN0RG9jcyhzb3VyY2U6IFFEb2NbXVtdKTogUURvY1tdIHtcbiAgICBjb25zdCBkaXN0aW5jdERvY3MgPSAoW106IFFEb2NbXSk7XG4gICAgY29uc3QgZGlzdGluY3RLZXlzID0gbmV3IFNldCgpO1xuICAgIHNvdXJjZS5mb3JFYWNoKChkb2NzKSA9PiB7XG4gICAgICAgIGRvY3MuZm9yRWFjaCgoZG9jKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWRvYy5fa2V5KSB7XG4gICAgICAgICAgICAgICAgZGlzdGluY3REb2NzLnB1c2goZG9jKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRpc3RpbmN0S2V5cy5oYXMoZG9jLl9rZXkpKSB7XG4gICAgICAgICAgICAgICAgZGlzdGluY3REb2NzLnB1c2goZG9jKTtcbiAgICAgICAgICAgICAgICBkaXN0aW5jdEtleXMuYWRkKGRvYy5fa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGRpc3RpbmN0RG9jcztcbn1cblxuXG5mdW5jdGlvbiBjb21wYXJlRG9jcyhhOiBRRG9jLCBiOiBRRG9jLCBvcmRlckJ5OiBPcmRlckJ5W10pIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9yZGVyQnkubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgY29uc3QgZmllbGQgPSBvcmRlckJ5W2ldO1xuICAgICAgICBjb25zdCBwYXRoID0gZmllbGQucGF0aC5zcGxpdCgnLicpO1xuICAgICAgICBjb25zdCBhVmFsdWUgPSBnZXRWYWx1ZShhLCBwYXRoLCAwKTtcbiAgICAgICAgY29uc3QgYlZhbHVlID0gZ2V0VmFsdWUoYiwgcGF0aCwgMCk7XG4gICAgICAgIGxldCBjb21wYXJpc29uID0gY29tcGFyZVZhbHVlcyhhVmFsdWUsIGJWYWx1ZSk7XG4gICAgICAgIGlmIChjb21wYXJpc29uICE9PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZmllbGQuZGlyZWN0aW9uID09PSAnREVTQycgPyAtY29tcGFyaXNvbiA6IGNvbXBhcmlzb247XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIDA7XG59XG5cblxuZnVuY3Rpb24gZ2V0VmFsdWUodmFsdWU6IGFueSwgcGF0aDogc3RyaW5nW10sIHBhdGhJbmRleDogbnVtYmVyKTogYW55IHtcbiAgICBpZiAoaXNOdWxsT3JVbmRlZmluZWQodmFsdWUpIHx8IHBhdGhJbmRleCA+PSBwYXRoLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGNvbnN0IG5hbWUgPSBwYXRoW3BhdGhJbmRleF0gPT09ICdpZCcgPyAnX2tleScgOiBwYXRoW3BhdGhJbmRleF07XG4gICAgcmV0dXJuIGdldFZhbHVlKHZhbHVlW25hbWVdLCBwYXRoLCBwYXRoSW5kZXggKyAxKTtcbn1cblxuXG5mdW5jdGlvbiBjb21wYXJlVmFsdWVzKGE6IGFueSwgYjogYW55KTogbnVtYmVyIHtcbiAgICBjb25zdCBhSGFzVmFsdWUgPSAhaXNOdWxsT3JVbmRlZmluZWQoYSk7XG4gICAgY29uc3QgYkhhc1ZhbHVlID0gIWlzTnVsbE9yVW5kZWZpbmVkKGIpO1xuICAgIGlmICghYUhhc1ZhbHVlKSB7XG4gICAgICAgIHJldHVybiBiSGFzVmFsdWUgPyAtMSA6IDA7XG4gICAgfVxuICAgIGlmICghYkhhc1ZhbHVlKSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICByZXR1cm4gYSA9PT0gYiA/IDAgOiAoYSA8IGIgPyAtMSA6IDApO1xufVxuXG5cbmZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKHY6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB2ID09PSBudWxsIHx8IHR5cGVvZiB2ID09PSAndW5kZWZpbmVkJztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNvcnRlZEluZGV4KGZpZWxkczogc3RyaW5nW10pOiBRSW5kZXhJbmZvIHtcbiAgICByZXR1cm4geyB0eXBlOiAncGVyc2lzdGVudCcsIGZpZWxkcyB9O1xufVxuXG5leHBvcnQgY29uc3QgbWlzc2luZ0RhdGFDYWNoZTogUURhdGFDYWNoZSA9IHtcbiAgICBnZXQoX2tleTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICB9LFxuXG4gICAgc2V0KF9rZXk6IHN0cmluZywgX3ZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH0sXG59XG4iXX0=