"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sortedIndex = sortedIndex;
exports.missingDataCache = exports.QDataPrecachedCombiner = exports.QDataCombiner = exports.dataEvent = void 0;

var _utils = require("../utils");

const dataEvent = {
  UPSERT: 'insert/update',
  INSERT: 'insert',
  UPDATE: 'update'
};
exports.dataEvent = dataEvent;

class QDataCombiner {
  constructor(providers) {
    this.providers = providers;
    this.isHotUpdate = false;
  }

  start(collectionsForSubscribe) {
    this.providers.forEach((x, i) => x.start(i === 0 ? collectionsForSubscribe : []));
  }

  getCollectionIndexes(collection) {
    return this.providers[0].getCollectionIndexes(collection);
  }

  getCollectionsForSubscribe() {
    return this.providers[0].getCollectionsForSubscribe();
  }

  async loadFingerprint(collections) {
    /**
     * Do not build fingerprint from a `hot` database (index=0), because it is a mutated storage.
     * We make fingerprints about the size of collections only on immutable storages like `cold` (index>0).
     * The updated fingerprint will change the cache key and the old keys will be removed using by DataCache itself.
     */
    return await Promise.all(this.providers.filter((_, i) => i !== 0).map(provider => provider.loadFingerprint(collections)));
  }

  hotUpdate(obj) {
    this.providers.forEach(provider => provider.hotUpdate(obj));
  }

  async query(text, vars, orderBy) {
    const results = await Promise.all(this.providers.map(x => x.query(text, vars, orderBy)));
    return combineResults(results, orderBy);
  }

  subscribe(collection, listener) {
    return this.providers[0].subscribe(collection, listener);
  }

  unsubscribe(subscription) {
    this.providers[0].unsubscribe(subscription);
  }

}

exports.QDataCombiner = QDataCombiner;

class QDataPrecachedCombiner extends QDataCombiner {
  constructor(cache, providers, networkName, cacheKeyPrefix) {
    super(providers);
    this.cache = cache;
    this.networkName = networkName;
    this.cacheKeyPrefix = cacheKeyPrefix;
    this.configHash = '';
  }

  hotUpdate(obj) {
    if (obj && 'fingerprint' in obj) {
      this.configHash = (0, _utils.hash)(this.networkName, JSON.stringify(obj.fingerprint));
    }

    this.providers.forEach(provider => provider.hotUpdate(obj));
  }

  cacheKey(aql) {
    return this.cacheKeyPrefix + (0, _utils.hash)(this.configHash, aql);
  }

  async loadFingerprint(collections) {
    return await Promise.all(this.providers.map(x => x.loadFingerprint(collections)));
  }

  async query(text, vars, orderBy) {
    const aql = JSON.stringify({
      text,
      vars,
      orderBy
    });
    const key = this.cacheKey(aql);
    let docs = await this.cache.get(key);

    if (isNullOrUndefined(docs)) {
      docs = await super.query(text, vars, orderBy);
      await this.cache.set(key, docs);
    }

    return docs;
  }

}

exports.QDataPrecachedCombiner = QDataPrecachedCombiner;

function combineResults(results, orderBy) {
  const docs = collectDistinctDocs(results);

  if (orderBy.length > 0) {
    docs.sort((a, b) => compareDocs(a, b, orderBy));
  }

  return docs;
}

function collectDistinctDocs(source) {
  const distinctDocs = [];
  const distinctKeys = new Set();
  source.forEach(docs => {
    docs.forEach(doc => {
      if (!doc._key) {
        distinctDocs.push(doc);
      } else if (!distinctKeys.has(doc._key)) {
        distinctDocs.push(doc);
        distinctKeys.add(doc._key);
      }
    });
  });
  return distinctDocs;
}

function compareDocs(a, b, orderBy) {
  for (let i = 0; i < orderBy.length; i += 1) {
    const field = orderBy[i];
    const path = field.path.split('.');
    const aValue = getValue(a, path, 0);
    const bValue = getValue(b, path, 0);
    let comparison = compareValues(aValue, bValue);

    if (comparison !== 0) {
      return field.direction === 'DESC' ? -comparison : comparison;
    }
  }

  return 0;
}

function getValue(value, path, pathIndex) {
  if (isNullOrUndefined(value) || pathIndex >= path.length) {
    return value;
  }

  const name = path[pathIndex] === 'id' ? '_key' : path[pathIndex];
  return getValue(value[name], path, pathIndex + 1);
}

function compareValues(a, b) {
  const aHasValue = !isNullOrUndefined(a);
  const bHasValue = !isNullOrUndefined(b);

  if (!aHasValue) {
    return bHasValue ? -1 : 0;
  }

  if (!bHasValue) {
    return 1;
  }

  return a === b ? 0 : a < b ? -1 : 0;
}

function isNullOrUndefined(v) {
  return v === null || typeof v === 'undefined';
}

function sortedIndex(fields) {
  return {
    type: 'persistent',
    fields
  };
}

const missingDataCache = {
  get(_key) {
    return Promise.resolve(null);
  },

  set(_key, _value) {
    return Promise.resolve();
  }

};
exports.missingDataCache = missingDataCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvZGF0YS9kYXRhLXByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbImRhdGFFdmVudCIsIlVQU0VSVCIsIklOU0VSVCIsIlVQREFURSIsIlFEYXRhQ29tYmluZXIiLCJjb25zdHJ1Y3RvciIsInByb3ZpZGVycyIsImlzSG90VXBkYXRlIiwic3RhcnQiLCJjb2xsZWN0aW9uc0ZvclN1YnNjcmliZSIsImZvckVhY2giLCJ4IiwiaSIsImdldENvbGxlY3Rpb25JbmRleGVzIiwiY29sbGVjdGlvbiIsImdldENvbGxlY3Rpb25zRm9yU3Vic2NyaWJlIiwibG9hZEZpbmdlcnByaW50IiwiY29sbGVjdGlvbnMiLCJQcm9taXNlIiwiYWxsIiwiZmlsdGVyIiwiXyIsIm1hcCIsInByb3ZpZGVyIiwiaG90VXBkYXRlIiwib2JqIiwicXVlcnkiLCJ0ZXh0IiwidmFycyIsIm9yZGVyQnkiLCJyZXN1bHRzIiwiY29tYmluZVJlc3VsdHMiLCJzdWJzY3JpYmUiLCJsaXN0ZW5lciIsInVuc3Vic2NyaWJlIiwic3Vic2NyaXB0aW9uIiwiUURhdGFQcmVjYWNoZWRDb21iaW5lciIsImNhY2hlIiwibmV0d29ya05hbWUiLCJjYWNoZUtleVByZWZpeCIsImNvbmZpZ0hhc2giLCJKU09OIiwic3RyaW5naWZ5IiwiZmluZ2VycHJpbnQiLCJjYWNoZUtleSIsImFxbCIsImtleSIsImRvY3MiLCJnZXQiLCJpc051bGxPclVuZGVmaW5lZCIsInNldCIsImNvbGxlY3REaXN0aW5jdERvY3MiLCJsZW5ndGgiLCJzb3J0IiwiYSIsImIiLCJjb21wYXJlRG9jcyIsInNvdXJjZSIsImRpc3RpbmN0RG9jcyIsImRpc3RpbmN0S2V5cyIsIlNldCIsImRvYyIsIl9rZXkiLCJwdXNoIiwiaGFzIiwiYWRkIiwiZmllbGQiLCJwYXRoIiwic3BsaXQiLCJhVmFsdWUiLCJnZXRWYWx1ZSIsImJWYWx1ZSIsImNvbXBhcmlzb24iLCJjb21wYXJlVmFsdWVzIiwiZGlyZWN0aW9uIiwidmFsdWUiLCJwYXRoSW5kZXgiLCJuYW1lIiwiYUhhc1ZhbHVlIiwiYkhhc1ZhbHVlIiwidiIsInNvcnRlZEluZGV4IiwiZmllbGRzIiwidHlwZSIsIm1pc3NpbmdEYXRhQ2FjaGUiLCJyZXNvbHZlIiwiX3ZhbHVlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUdBOztBQWVPLE1BQU1BLFNBQVMsR0FBRztBQUNyQkMsRUFBQUEsTUFBTSxFQUFFLGVBRGE7QUFFckJDLEVBQUFBLE1BQU0sRUFBRSxRQUZhO0FBR3JCQyxFQUFBQSxNQUFNLEVBQUU7QUFIYSxDQUFsQjs7O0FBa0NBLE1BQU1DLGFBQU4sQ0FBNkM7QUFJaERDLEVBQUFBLFdBQVcsQ0FBQ0MsU0FBRCxFQUE2QjtBQUNwQyxTQUFLQSxTQUFMLEdBQWlCQSxTQUFqQjtBQUNBLFNBQUtDLFdBQUwsR0FBbUIsS0FBbkI7QUFDSDs7QUFFREMsRUFBQUEsS0FBSyxDQUFDQyx1QkFBRCxFQUEwQztBQUMzQyxTQUFLSCxTQUFMLENBQWVJLE9BQWYsQ0FBdUIsQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLEtBQVVELENBQUMsQ0FBQ0gsS0FBRixDQUFRSSxDQUFDLEtBQUssQ0FBTixHQUFVSCx1QkFBVixHQUFvQyxFQUE1QyxDQUFqQztBQUNIOztBQUVESSxFQUFBQSxvQkFBb0IsQ0FBQ0MsVUFBRCxFQUE0QztBQUM1RCxXQUFPLEtBQUtSLFNBQUwsQ0FBZSxDQUFmLEVBQWtCTyxvQkFBbEIsQ0FBdUNDLFVBQXZDLENBQVA7QUFDSDs7QUFFREMsRUFBQUEsMEJBQTBCLEdBQWE7QUFDbkMsV0FBTyxLQUFLVCxTQUFMLENBQWUsQ0FBZixFQUFrQlMsMEJBQWxCLEVBQVA7QUFDSDs7QUFFRCxRQUFNQyxlQUFOLENBQXNCQyxXQUF0QixFQUEyRDtBQUN2RDs7Ozs7QUFLQSxXQUFPLE1BQU1DLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLEtBQUtiLFNBQUwsQ0FBZWMsTUFBZixDQUFzQixDQUFDQyxDQUFELEVBQUlULENBQUosS0FBVUEsQ0FBQyxLQUFLLENBQXRDLEVBQ2VV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QUFDSDs7QUFQdUMsQ0FBckMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSB7IE9yZGVyQnkgfSBmcm9tICcuLi9maWx0ZXIvZmlsdGVycyc7XG5pbXBvcnQgeyBoYXNoIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5leHBvcnQgdHlwZSBRSW5kZXhJbmZvID0ge1xuICAgIGZpZWxkczogc3RyaW5nW10sXG4gICAgdHlwZT86IHN0cmluZyxcbn1cblxuXG5leHBvcnQgdHlwZSBRRG9jID0ge1xuICAgIF9rZXk6IHN0cmluZztcbiAgICBbc3RyaW5nXTogYW55O1xufTtcblxuXG5leHBvcnQgdHlwZSBRRGF0YUV2ZW50ID0gJ2luc2VydC91cGRhdGUnIHwgJ2luc2VydCcgfCAndXBkYXRlJztcbmV4cG9ydCBjb25zdCBkYXRhRXZlbnQgPSB7XG4gICAgVVBTRVJUOiAnaW5zZXJ0L3VwZGF0ZScsXG4gICAgSU5TRVJUOiAnaW5zZXJ0JyxcbiAgICBVUERBVEU6ICd1cGRhdGUnLFxufTtcblxuXG5leHBvcnQgaW50ZXJmYWNlIFFEYXRhUHJvdmlkZXIge1xuICAgIHN0YXJ0KGNvbGxlY3Rpb25zRm9yU3Vic2NyaWJlOiBzdHJpbmdbXSk6IHZvaWQ7XG5cbiAgICBnZXRDb2xsZWN0aW9uSW5kZXhlcyhjb2xsZWN0aW9uOiBzdHJpbmcpOiBQcm9taXNlPFFJbmRleEluZm9bXT47XG5cbiAgICBnZXRDb2xsZWN0aW9uc0ZvclN1YnNjcmliZSgpOiBzdHJpbmdbXTtcblxuICAgIGxvYWRGaW5nZXJwcmludChjb2xsZWN0aW9uczogc3RyaW5nW10pOiBQcm9taXNlPGFueT47XG5cbiAgICBpc0hvdFVwZGF0ZTogYm9vbGVhbjtcblxuICAgIGhvdFVwZGF0ZShhbnkpOiB2b2lkO1xuXG4gICAgcXVlcnkodGV4dDogc3RyaW5nLCB2YXJzOiB7IFtzdHJpbmddOiBhbnkgfSwgb3JkZXJCeTogT3JkZXJCeVtdKTogUHJvbWlzZTxhbnk+O1xuXG4gICAgc3Vic2NyaWJlKGNvbGxlY3Rpb246IHN0cmluZywgbGlzdGVuZXI6IChkb2M6IGFueSwgZXZlbnQ6IFFEYXRhRXZlbnQpID0+IHZvaWQpOiBhbnk7XG5cbiAgICB1bnN1YnNjcmliZShzdWJzY3JpcHRpb246IGFueSk6IHZvaWQ7XG59XG5cblxuZXhwb3J0IGludGVyZmFjZSBRRGF0YUNhY2hlIHtcbiAgICBnZXQoa2V5OiBzdHJpbmcpOiBQcm9taXNlPGFueT47XG5cbiAgICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+O1xufVxuXG5leHBvcnQgY2xhc3MgUURhdGFDb21iaW5lciBpbXBsZW1lbnRzIFFEYXRhUHJvdmlkZXIge1xuICAgIHByb3ZpZGVyczogUURhdGFQcm92aWRlcltdO1xuICAgIGlzSG90VXBkYXRlOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3IocHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVyW10pIHtcbiAgICAgICAgdGhpcy5wcm92aWRlcnMgPSBwcm92aWRlcnM7XG4gICAgICAgIHRoaXMuaXNIb3RVcGRhdGUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBzdGFydChjb2xsZWN0aW9uc0ZvclN1YnNjcmliZTogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wcm92aWRlcnMuZm9yRWFjaCgoeCwgaSkgPT4geC5zdGFydChpID09PSAwID8gY29sbGVjdGlvbnNGb3JTdWJzY3JpYmUgOiBbXSkpO1xuICAgIH1cblxuICAgIGdldENvbGxlY3Rpb25JbmRleGVzKGNvbGxlY3Rpb246IHN0cmluZyk6IFByb21pc2U8UUluZGV4SW5mb1tdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyc1swXS5nZXRDb2xsZWN0aW9uSW5kZXhlcyhjb2xsZWN0aW9uKTtcbiAgICB9XG5cbiAgICBnZXRDb2xsZWN0aW9uc0ZvclN1YnNjcmliZSgpOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyc1swXS5nZXRDb2xsZWN0aW9uc0ZvclN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIGFzeW5jIGxvYWRGaW5nZXJwcmludChjb2xsZWN0aW9uczogc3RyaW5nW10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICAvKipcbiAgICAgICAgICogRG8gbm90IGJ1aWxkIGZpbmdlcnByaW50IGZyb20gYSBgaG90YCBkYXRhYmFzZSAoaW5kZXg9MCksIGJlY2F1c2UgaXQgaXMgYSBtdXRhdGVkIHN0b3JhZ2UuXG4gICAgICAgICAqIFdlIG1ha2UgZmluZ2VycHJpbnRzIGFib3V0IHRoZSBzaXplIG9mIGNvbGxlY3Rpb25zIG9ubHkgb24gaW1tdXRhYmxlIHN0b3JhZ2VzIGxpa2UgYGNvbGRgIChpbmRleD4wKS5cbiAgICAgICAgICogVGhlIHVwZGF0ZWQgZmluZ2VycHJpbnQgd2lsbCBjaGFuZ2UgdGhlIGNhY2hlIGtleSBhbmQgdGhlIG9sZCBrZXlzIHdpbGwgYmUgcmVtb3ZlZCB1c2luZyBieSBEYXRhQ2FjaGUgaXRzZWxmLlxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHRoaXMucHJvdmlkZXJzLmZpbHRlcigoXywgaSkgPT4gaSAhPT0gMClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChwcm92aWRlciA9PiBwcm92aWRlci5sb2FkRmluZ2VycHJpbnQoY29sbGVjdGlvbnMpKSk7XG4gICAgfVxuXG4gICAgaG90VXBkYXRlKG9iajogYW55KTogdm9pZCB7XG4gICAgICAgIHRoaXMucHJvdmlkZXJzLmZvckVhY2gocHJvdmlkZXIgPT4gcHJvdmlkZXIuaG90VXBkYXRlKG9iaikpO1xuICAgIH1cblxuICAgIGFzeW5jIHF1ZXJ5KHRleHQ6IHN0cmluZywgdmFyczogeyBbc3RyaW5nXTogYW55IH0sIG9yZGVyQnk6IE9yZGVyQnlbXSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLnByb3ZpZGVycy5tYXAoeCA9PiB4LnF1ZXJ5KHRleHQsIHZhcnMsIG9yZGVyQnkpKSk7XG4gICAgICAgIHJldHVybiBjb21iaW5lUmVzdWx0cyhyZXN1bHRzLCBvcmRlckJ5KTtcbiAgICB9XG5cbiAgICBzdWJzY3JpYmUoY29sbGVjdGlvbjogc3RyaW5nLCBsaXN0ZW5lcjogKGRvYzogYW55LCBldmVudDogUURhdGFFdmVudCkgPT4gdm9pZCk6IGFueSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyc1swXS5zdWJzY3JpYmUoY29sbGVjdGlvbiwgbGlzdGVuZXIpO1xuICAgIH1cblxuICAgIHVuc3Vic2NyaWJlKHN1YnNjcmlwdGlvbjogYW55KTogdm9pZCB7XG4gICAgICAgIHRoaXMucHJvdmlkZXJzWzBdLnVuc3Vic2NyaWJlKHN1YnNjcmlwdGlvbik7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgUURhdGFQcmVjYWNoZWRDb21iaW5lciBleHRlbmRzIFFEYXRhQ29tYmluZXIge1xuICAgIGNhY2hlOiBRRGF0YUNhY2hlO1xuICAgIG5ldHdvcmtOYW1lOiBzdHJpbmc7XG4gICAgY2FjaGVLZXlQcmVmaXg6IHN0cmluZztcbiAgICBjb25maWdIYXNoOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihjYWNoZTogUURhdGFDYWNoZSwgcHJvdmlkZXJzOiBRRGF0YVByb3ZpZGVyW10sIG5ldHdvcmtOYW1lOiBzdHJpbmcsIGNhY2hlS2V5UHJlZml4OiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIocHJvdmlkZXJzKTtcbiAgICAgICAgdGhpcy5jYWNoZSA9IGNhY2hlO1xuICAgICAgICB0aGlzLm5ldHdvcmtOYW1lID0gbmV0d29ya05hbWU7XG4gICAgICAgIHRoaXMuY2FjaGVLZXlQcmVmaXggPSBjYWNoZUtleVByZWZpeDtcbiAgICAgICAgdGhpcy5jb25maWdIYXNoID0gJyc7XG4gICAgfVxuXG4gICAgaG90VXBkYXRlKG9iajogYW55KTogdm9pZCB7XG4gICAgICAgIGlmIChvYmogJiYgJ2ZpbmdlcnByaW50JyBpbiBvYmopIHtcbiAgICAgICAgICAgIHRoaXMuY29uZmlnSGFzaCA9IGhhc2godGhpcy5uZXR3b3JrTmFtZSwgSlNPTi5zdHJpbmdpZnkob2JqLmZpbmdlcnByaW50KSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wcm92aWRlcnMuZm9yRWFjaChwcm92aWRlciA9PiBwcm92aWRlci5ob3RVcGRhdGUob2JqKSk7XG4gICAgfVxuXG4gICAgY2FjaGVLZXkoYXFsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWNoZUtleVByZWZpeCArIGhhc2godGhpcy5jb25maWdIYXNoLCBhcWwpO1xuICAgIH1cblxuICAgIGFzeW5jIGxvYWRGaW5nZXJwcmludChjb2xsZWN0aW9uczogc3RyaW5nW10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5wcm92aWRlcnMubWFwKHggPT4geC5sb2FkRmluZ2VycHJpbnQoY29sbGVjdGlvbnMpKSlcbiAgICB9XG5cbiAgICBhc3luYyBxdWVyeSh0ZXh0OiBzdHJpbmcsIHZhcnM6IHsgW3N0cmluZ106IGFueSB9LCBvcmRlckJ5OiBPcmRlckJ5W10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBhcWwgPSBKU09OLnN0cmluZ2lmeSh7IHRleHQsIHZhcnMsIG9yZGVyQnkgfSk7XG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMuY2FjaGVLZXkoYXFsKTtcbiAgICAgICAgbGV0IGRvY3MgPSBhd2FpdCB0aGlzLmNhY2hlLmdldChrZXkpO1xuICAgICAgICBpZiAoaXNOdWxsT3JVbmRlZmluZWQoZG9jcykpIHtcbiAgICAgICAgICAgIGRvY3MgPSBhd2FpdCBzdXBlci5xdWVyeSh0ZXh0LCB2YXJzLCBvcmRlckJ5KTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2FjaGUuc2V0KGtleSwgZG9jcyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRvY3M7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjb21iaW5lUmVzdWx0cyhyZXN1bHRzOiBhbnlbXVtdLCBvcmRlckJ5OiBPcmRlckJ5W10pOiBhbnlbXSB7XG4gICAgY29uc3QgZG9jcyA9IGNvbGxlY3REaXN0aW5jdERvY3MocmVzdWx0cyk7XG4gICAgaWYgKG9yZGVyQnkubGVuZ3RoID4gMCkge1xuICAgICAgICBkb2NzLnNvcnQoKGE6IFFEb2MsIGI6IFFEb2MpID0+IGNvbXBhcmVEb2NzKGEsIGIsIG9yZGVyQnkpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRvY3M7XG59XG5cblxuZnVuY3Rpb24gY29sbGVjdERpc3RpbmN0RG9jcyhzb3VyY2U6IFFEb2NbXVtdKTogUURvY1tdIHtcbiAgICBjb25zdCBkaXN0aW5jdERvY3MgPSAoW106IFFEb2NbXSk7XG4gICAgY29uc3QgZGlzdGluY3RLZXlzID0gbmV3IFNldCgpO1xuICAgIHNvdXJjZS5mb3JFYWNoKChkb2NzKSA9PiB7XG4gICAgICAgIGRvY3MuZm9yRWFjaCgoZG9jKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWRvYy5fa2V5KSB7XG4gICAgICAgICAgICAgICAgZGlzdGluY3REb2NzLnB1c2goZG9jKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRpc3RpbmN0S2V5cy5oYXMoZG9jLl9rZXkpKSB7XG4gICAgICAgICAgICAgICAgZGlzdGluY3REb2NzLnB1c2goZG9jKTtcbiAgICAgICAgICAgICAgICBkaXN0aW5jdEtleXMuYWRkKGRvYy5fa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGRpc3RpbmN0RG9jcztcbn1cblxuXG5mdW5jdGlvbiBjb21wYXJlRG9jcyhhOiBRRG9jLCBiOiBRRG9jLCBvcmRlckJ5OiBPcmRlckJ5W10pIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9yZGVyQnkubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgY29uc3QgZmllbGQgPSBvcmRlckJ5W2ldO1xuICAgICAgICBjb25zdCBwYXRoID0gZmllbGQucGF0aC5zcGxpdCgnLicpO1xuICAgICAgICBjb25zdCBhVmFsdWUgPSBnZXRWYWx1ZShhLCBwYXRoLCAwKTtcbiAgICAgICAgY29uc3QgYlZhbHVlID0gZ2V0VmFsdWUoYiwgcGF0aCwgMCk7XG4gICAgICAgIGxldCBjb21wYXJpc29uID0gY29tcGFyZVZhbHVlcyhhVmFsdWUsIGJWYWx1ZSk7XG4gICAgICAgIGlmIChjb21wYXJpc29uICE9PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gZmllbGQuZGlyZWN0aW9uID09PSAnREVTQycgPyAtY29tcGFyaXNvbiA6IGNvbXBhcmlzb247XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIDA7XG59XG5cblxuZnVuY3Rpb24gZ2V0VmFsdWUodmFsdWU6IGFueSwgcGF0aDogc3RyaW5nW10sIHBhdGhJbmRleDogbnVtYmVyKTogYW55IHtcbiAgICBpZiAoaXNOdWxsT3JVbmRlZmluZWQodmFsdWUpIHx8IHBhdGhJbmRleCA+PSBwYXRoLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGNvbnN0IG5hbWUgPSBwYXRoW3BhdGhJbmRleF0gPT09ICdpZCcgPyAnX2tleScgOiBwYXRoW3BhdGhJbmRleF07XG4gICAgcmV0dXJuIGdldFZhbHVlKHZhbHVlW25hbWVdLCBwYXRoLCBwYXRoSW5kZXggKyAxKTtcbn1cblxuXG5mdW5jdGlvbiBjb21wYXJlVmFsdWVzKGE6IGFueSwgYjogYW55KTogbnVtYmVyIHtcbiAgICBjb25zdCBhSGFzVmFsdWUgPSAhaXNOdWxsT3JVbmRlZmluZWQoYSk7XG4gICAgY29uc3QgYkhhc1ZhbHVlID0gIWlzTnVsbE9yVW5kZWZpbmVkKGIpO1xuICAgIGlmICghYUhhc1ZhbHVlKSB7XG4gICAgICAgIHJldHVybiBiSGFzVmFsdWUgPyAtMSA6IDA7XG4gICAgfVxuICAgIGlmICghYkhhc1ZhbHVlKSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICByZXR1cm4gYSA9PT0gYiA/IDAgOiAoYSA8IGIgPyAtMSA6IDApO1xufVxuXG5cbmZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKHY6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB2ID09PSBudWxsIHx8IHR5cGVvZiB2ID09PSAndW5kZWZpbmVkJztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNvcnRlZEluZGV4KGZpZWxkczogc3RyaW5nW10pOiBRSW5kZXhJbmZvIHtcbiAgICByZXR1cm4geyB0eXBlOiAncGVyc2lzdGVudCcsIGZpZWxkcyB9O1xufVxuXG5leHBvcnQgY29uc3QgbWlzc2luZ0RhdGFDYWNoZTogUURhdGFDYWNoZSA9IHtcbiAgICBnZXQoX2tleTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICB9LFxuXG4gICAgc2V0KF9rZXk6IHN0cmluZywgX3ZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH0sXG59XG4iXX0=