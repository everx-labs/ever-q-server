"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isFastQuery = isFastQuery;

var _dbTypes = require("./db-types");

function setIs1(s, a) {
  return s.size === 1 && s.has(a);
}

function setIs2(s, a, b) {
  return s.size === 2 && s.has(a) && s.has(b);
}

function canUseIndexedRange(ops) {
  return setIs1(ops, '==') || setIs1(ops, '!=') || setIs1(ops, '>') || setIs2(ops, '>', '<') || setIs2(ops, '>', '<=') || setIs1(ops, '>=') || setIs2(ops, '>=', '<') || setIs2(ops, '>=', '<=') || setIs1(ops, '<') || setIs1(ops, '<=');
}

function canUseConditionsForIndexedRange(fields) {
  for (const explanation of fields.values()) {
    if (!canUseIndexedRange(explanation.operations)) {
      return false;
    }
  }

  return true;
}

function fieldsCanUseIndex(fields, index) {
  if (fields.size > index.fields.length) {
    return false;
  }

  for (let i = 0; i < fields.size; i += 1) {
    if (!fields.has(index.fields[i])) {
      return false;
    }
  }

  return true;
}

function getUsedIndexes(fields, collection) {
  const indexes = collection.indexes.filter(x => fieldsCanUseIndex(fields, x));
  return indexes.length > 0 ? indexes : null;
}

function orderByCanUseIndex(orderBy, fields, index) {
  if (orderBy.length === 0) {
    return true;
  }

  let iOrderBy = 0;

  for (let iIndex = 0; iIndex < index.fields.length; iIndex += 1) {
    const indexField = index.fields[iIndex];

    if (indexField === orderBy[iOrderBy].path) {
      iOrderBy += 1;

      if (iOrderBy >= orderBy.length) {
        return true;
      }
    } else {
      if (iOrderBy > 0) {
        return false;
      }

      const field = fields.get(indexField);

      if (!field) {
        return false;
      }

      if (!setIs1(field.operations, '==')) {
        return false;
      }
    }
  }

  return true;
}

function orderByCanUseAllIndexes(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (!orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return false;
    }
  }

  return indexes.length > 0;
}

function orderByCanUseAnyIndex(orderBy, fields, indexes) {
  for (let i = 0; i < indexes.length; i += 1) {
    if (orderByCanUseIndex(orderBy, fields, indexes[i])) {
      return true;
    }
  }

  return false;
}

function hasKeyEq(fields) {
  const key = fields.get('_key');
  return !!(key && setIs1(key.operations, '=='));
}

function logSlowReason(message, log, filter, orderBy, fields, collection, selectedIndexes) {
  const logFields = [];

  for (const [name, explanation] of fields.entries()) {
    logFields.push(`${name} ${Array.from(explanation.operations).join(' AND ')}`);
  }

  log.debug(message, {
    collection: collection.name,
    filter,
    orderBy: (0, _dbTypes.orderByToString)(orderBy),
    fields: logFields,
    ...(selectedIndexes ? {
      selectedIndexes: selectedIndexes.map(_dbTypes.indexToString)
    } : {}),
    availableIndexes: collection.indexes.map(_dbTypes.indexToString)
  });
}

function isFastQueryOrOperand(collection, type, filter, orderBy, log) {
  const params = new _dbTypes.QParams({
    explain: true
  });
  type.filterCondition(params, '', filter);

  if (!params.explanation) {
    return false;
  }

  const fields = new Map();

  for (const [field, explanation] of params.explanation.fields) {
    if (field !== 'status') {
      fields.set(field, explanation);
    }
  }

  if (hasKeyEq(fields)) {
    return true;
  }

  if (!canUseConditionsForIndexedRange(fields)) {
    if (log) {
      logSlowReason('Filter operations can\'t be used in ranged queries', log, filter, orderBy, fields, collection);
    }

    return false;
  }

  const indexes = getUsedIndexes(fields, collection);

  if (!indexes) {
    if (log) {
      logSlowReason('Available indexes can\'t be used for filter fields', log, filter, orderBy, fields, collection);
    }

    return false;
  }

  if (orderBy.length > 0) {
    if (!orderByCanUseAnyIndex(orderBy, fields, indexes)) {
      if (log) {
        logSlowReason('Order by can\'t use any selected index', log, filter, orderBy, fields, collection, indexes);
      }

      return false;
    }
  }

  return true;
}

function isFastQuery(collection, type, filter, orderBy, log) {
  const orOperands = (0, _dbTypes.splitOr)(filter);

  for (let i = 0; i < orOperands.length; i += 1) {
    if (!isFastQueryOrOperand(collection, type, orOperands[i], orderBy, log)) {
      return false;
    }
  }

  return true;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9zbG93LWRldGVjdG9yLmpzIl0sIm5hbWVzIjpbInNldElzMSIsInMiLCJhIiwic2l6ZSIsImhhcyIsInNldElzMiIsImIiLCJjYW5Vc2VJbmRleGVkUmFuZ2UiLCJvcHMiLCJjYW5Vc2VDb25kaXRpb25zRm9ySW5kZXhlZFJhbmdlIiwiZmllbGRzIiwiZXhwbGFuYXRpb24iLCJ2YWx1ZXMiLCJvcGVyYXRpb25zIiwiZmllbGRzQ2FuVXNlSW5kZXgiLCJpbmRleCIsImxlbmd0aCIsImkiLCJnZXRVc2VkSW5kZXhlcyIsImNvbGxlY3Rpb24iLCJpbmRleGVzIiwiZmlsdGVyIiwieCIsIm9yZGVyQnlDYW5Vc2VJbmRleCIsIm9yZGVyQnkiLCJpT3JkZXJCeSIsImlJbmRleCIsImluZGV4RmllbGQiLCJwYXRoIiwiZmllbGQiLCJnZXQiLCJvcmRlckJ5Q2FuVXNlQWxsSW5kZXhlcyIsIm9yZGVyQnlDYW5Vc2VBbnlJbmRleCIsImhhc0tleUVxIiwia2V5IiwibG9nU2xvd1JlYXNvbiIsIm1lc3NhZ2UiLCJsb2ciLCJzZWxlY3RlZEluZGV4ZXMiLCJsb2dGaWVsZHMiLCJuYW1lIiwiZW50cmllcyIsInB1c2giLCJBcnJheSIsImZyb20iLCJqb2luIiwiZGVidWciLCJtYXAiLCJpbmRleFRvU3RyaW5nIiwiYXZhaWxhYmxlSW5kZXhlcyIsImlzRmFzdFF1ZXJ5T3JPcGVyYW5kIiwidHlwZSIsInBhcmFtcyIsIlFQYXJhbXMiLCJleHBsYWluIiwiZmlsdGVyQ29uZGl0aW9uIiwiTWFwIiwic2V0IiwiaXNGYXN0UXVlcnkiLCJvck9wZXJhbmRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBSUE7O0FBSUEsU0FBU0EsTUFBVCxDQUFnQkMsQ0FBaEIsRUFBZ0NDLENBQWhDLEVBQW9EO0FBQ2hELFNBQU9ELENBQUMsQ0FBQ0UsSUFBRixLQUFXLENBQVgsSUFBZ0JGLENBQUMsQ0FBQ0csR0FBRixDQUFNRixDQUFOLENBQXZCO0FBQ0g7O0FBRUQsU0FB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Y3Rpb25JbmZvLCBJbmRleEluZm99IGZyb20gXCIuL2NvbmZpZ1wiO1xyXG5pbXBvcnQge2luZGV4VG9TdHJpbmcsIG9yZGVyQnlUb1N0cmluZywgUVBhcmFtcywgc3BsaXRPcn0gZnJvbSBcIi4vZGItdHlwZXNcIjtcclxuaW1wb3J0IHR5cGUge09yZGVyQnksIFFGaWVsZEV4cGxhbmF0aW9uLCBRVHlwZX0gZnJvbSBcIi4vZGItdHlwZXNcIjtcclxuaW1wb3J0IHR5cGUge1FMb2d9IGZyb20gJy4vbG9ncyc7XHJcblxyXG5mdW5jdGlvbiBzZXRJczEoczogU2V0PHN0cmluZz4sIGE6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHMuc2l6ZSA9PT0gMSAmJiBzLmhhcyhhKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2V0SXMyKHM6IFNldDxzdHJpbmc+LCBhOiBzdHJpbmcsIGI6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHMuc2l6ZSA9PT0gMiAmJiBzLmhhcyhhKSAmJiBzLmhhcyhiKTtcclxufVxyXG5cclxuZnVuY3Rpb24gY2FuVXNlSW5kZXhlZFJhbmdlKG9wczogU2V0PHN0cmluZz4pOiBib29sZWFuIHtcclxuICAgIHJldHVybiBzZXRJczEob3BzLCAnPT0nKVxyXG4gICAgICAgIHx8IHNldElzMShvcHMsICchPScpXHJcbiAgICAgICAgfHwgc2V0SXMxKG9wcywgJz4nKVxyXG4gICAgICAgIHx8IHNldElzMihvcHMsICc+JywgJzwnKVxyXG4gICAgICAgIHx8IHNldElzMihvcHMsICc+JywgJzw9JylcclxuICAgICAgICB8fCBzZXRJczEob3BzLCAnPj0nKVxyXG4gICAgICAgIHx8IHNldElzMihvcHMsICc+PScsICc8JylcclxuICAgICAgICB8fCBzZXRJczIob3BzLCAnPj0nLCAnPD0nKVxyXG4gICAgICAgIHx8IHNldElzMShvcHMsICc8JylcclxuICAgICAgICB8fCBzZXRJczEob3BzLCAnPD0nKTtcclxufVxyXG5cclxuZnVuY3Rpb24gY2FuVXNlQ29uZGl0aW9uc0ZvckluZGV4ZWRSYW5nZShmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPik6IGJvb2xlYW4ge1xyXG4gICAgZm9yIChjb25zdCBleHBsYW5hdGlvbiBvZiBmaWVsZHMudmFsdWVzKCkpIHtcclxuICAgICAgICBpZiAoIWNhblVzZUluZGV4ZWRSYW5nZShleHBsYW5hdGlvbi5vcGVyYXRpb25zKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpZWxkc0NhblVzZUluZGV4KGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+LCBpbmRleDogSW5kZXhJbmZvKTogYm9vbGVhbiB7XHJcbiAgICBpZiAoZmllbGRzLnNpemUgPiBpbmRleC5maWVsZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWVsZHMuc2l6ZTsgaSArPSAxKSB7XHJcbiAgICAgICAgaWYgKCFmaWVsZHMuaGFzKGluZGV4LmZpZWxkc1tpXSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRVc2VkSW5kZXhlcyhmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPiwgY29sbGVjdGlvbjogQ29sbGVjdGlvbkluZm8pOiA/KEluZGV4SW5mb1tdKSB7XHJcbiAgICBjb25zdCBpbmRleGVzID0gY29sbGVjdGlvbi5pbmRleGVzLmZpbHRlcih4ID0+IGZpZWxkc0NhblVzZUluZGV4KGZpZWxkcywgeCkpO1xyXG4gICAgcmV0dXJuIGluZGV4ZXMubGVuZ3RoID4gMCA/IGluZGV4ZXMgOiBudWxsO1xyXG59XHJcblxyXG5mdW5jdGlvbiBvcmRlckJ5Q2FuVXNlSW5kZXgoXHJcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXHJcbiAgICBmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPixcclxuICAgIGluZGV4OiBJbmRleEluZm8sXHJcbik6IGJvb2xlYW4ge1xyXG4gICAgaWYgKG9yZGVyQnkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICBsZXQgaU9yZGVyQnkgPSAwO1xyXG4gICAgZm9yIChsZXQgaUluZGV4ID0gMDsgaUluZGV4IDwgaW5kZXguZmllbGRzLmxlbmd0aDsgaUluZGV4ICs9IDEpIHtcclxuICAgICAgICBjb25zdCBpbmRleEZpZWxkID0gaW5kZXguZmllbGRzW2lJbmRleF07XHJcbiAgICAgICAgaWYgKGluZGV4RmllbGQgPT09IG9yZGVyQnlbaU9yZGVyQnldLnBhdGgpIHtcclxuICAgICAgICAgICAgaU9yZGVyQnkgKz0gMTtcclxuICAgICAgICAgICAgaWYgKGlPcmRlckJ5ID49IG9yZGVyQnkubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChpT3JkZXJCeSA+IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBmaWVsZCA9IGZpZWxkcy5nZXQoaW5kZXhGaWVsZCk7XHJcbiAgICAgICAgICAgIGlmICghZmllbGQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIXNldElzMShmaWVsZC5vcGVyYXRpb25zLCAnPT0nKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG9yZGVyQnlDYW5Vc2VBbGxJbmRleGVzKFxyXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxyXG4gICAgZmllbGRzOiBNYXA8c3RyaW5nLCBRRmllbGRFeHBsYW5hdGlvbj4sXHJcbiAgICBpbmRleGVzOiBJbmRleEluZm9bXSxcclxuKTogYm9vbGVhbiB7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4ZXMubGVuZ3RoOyBpICs9IDEpIHtcclxuICAgICAgICBpZiAoIW9yZGVyQnlDYW5Vc2VJbmRleChvcmRlckJ5LCBmaWVsZHMsIGluZGV4ZXNbaV0pKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaW5kZXhlcy5sZW5ndGggPiAwO1xyXG59XHJcblxyXG5mdW5jdGlvbiBvcmRlckJ5Q2FuVXNlQW55SW5kZXgoXHJcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXHJcbiAgICBmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPixcclxuICAgIGluZGV4ZXM6IEluZGV4SW5mb1tdLFxyXG4pOiBib29sZWFuIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhlcy5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgIGlmIChvcmRlckJ5Q2FuVXNlSW5kZXgob3JkZXJCeSwgZmllbGRzLCBpbmRleGVzW2ldKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhc0tleUVxKGZpZWxkczogTWFwPHN0cmluZywgUUZpZWxkRXhwbGFuYXRpb24+KTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBrZXkgPSBmaWVsZHMuZ2V0KCdfa2V5Jyk7XHJcbiAgICByZXR1cm4gISEoa2V5ICYmIHNldElzMShrZXkub3BlcmF0aW9ucywgJz09JykpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBsb2dTbG93UmVhc29uKFxyXG4gICAgbWVzc2FnZTogc3RyaW5nLFxyXG4gICAgbG9nOiBRTG9nLFxyXG4gICAgZmlsdGVyOiBhbnksXHJcbiAgICBvcmRlckJ5OiBPcmRlckJ5W10sXHJcbiAgICBmaWVsZHM6IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPixcclxuICAgIGNvbGxlY3Rpb246IENvbGxlY3Rpb25JbmZvLFxyXG4gICAgc2VsZWN0ZWRJbmRleGVzPzogSW5kZXhJbmZvW10sXHJcbikge1xyXG4gICAgY29uc3QgbG9nRmllbGRzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBbbmFtZSwgZXhwbGFuYXRpb25dIG9mIGZpZWxkcy5lbnRyaWVzKCkpIHtcclxuICAgICAgICBsb2dGaWVsZHMucHVzaChgJHtuYW1lfSAke0FycmF5LmZyb20oZXhwbGFuYXRpb24ub3BlcmF0aW9ucykuam9pbignIEFORCAnKX1gKTtcclxuICAgIH1cclxuICAgIGxvZy5kZWJ1ZyhtZXNzYWdlLCB7XHJcbiAgICAgICAgY29sbGVjdGlvbjogY29sbGVjdGlvbi5uYW1lLFxyXG4gICAgICAgIGZpbHRlcixcclxuICAgICAgICBvcmRlckJ5OiBvcmRlckJ5VG9TdHJpbmcob3JkZXJCeSksXHJcbiAgICAgICAgZmllbGRzOiBsb2dGaWVsZHMsXHJcbiAgICAgICAgLi4uKHNlbGVjdGVkSW5kZXhlcyA/IHtzZWxlY3RlZEluZGV4ZXM6IHNlbGVjdGVkSW5kZXhlcy5tYXAoaW5kZXhUb1N0cmluZyl9IDoge30pLFxyXG4gICAgICAgIGF2YWlsYWJsZUluZGV4ZXM6IGNvbGxlY3Rpb24uaW5kZXhlcy5tYXAoaW5kZXhUb1N0cmluZyksXHJcbiAgICB9KTtcclxuXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzRmFzdFF1ZXJ5T3JPcGVyYW5kKFxyXG4gICAgY29sbGVjdGlvbjogQ29sbGVjdGlvbkluZm8sXHJcbiAgICB0eXBlOiBRVHlwZSxcclxuICAgIGZpbHRlcjogYW55LFxyXG4gICAgb3JkZXJCeTogT3JkZXJCeVtdLFxyXG4gICAgbG9nOiA/UUxvZyxcclxuKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBwYXJhbXMgPSBuZXcgUVBhcmFtcyh7XHJcbiAgICAgICAgZXhwbGFpbjogdHJ1ZSxcclxuICAgIH0pO1xyXG4gICAgdHlwZS5maWx0ZXJDb25kaXRpb24ocGFyYW1zLCAnJywgZmlsdGVyKTtcclxuICAgIGlmICghcGFyYW1zLmV4cGxhbmF0aW9uKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZmllbGRzID0gbmV3IE1hcDxzdHJpbmcsIFFGaWVsZEV4cGxhbmF0aW9uPigpO1xyXG4gICAgZm9yIChjb25zdCBbZmllbGQsIGV4cGxhbmF0aW9uXSBvZiBwYXJhbXMuZXhwbGFuYXRpb24uZmllbGRzKSB7XHJcbiAgICAgICAgaWYgKGZpZWxkICE9PSAnc3RhdHVzJykge1xyXG4gICAgICAgICAgICBmaWVsZHMuc2V0KGZpZWxkLCBleHBsYW5hdGlvbik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKGhhc0tleUVxKGZpZWxkcykpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIGlmICghY2FuVXNlQ29uZGl0aW9uc0ZvckluZGV4ZWRSYW5nZShmaWVsZHMpKSB7XHJcbiAgICAgICAgaWYgKGxvZykge1xyXG4gICAgICAgICAgICBsb2dTbG93UmVhc29uKFxyXG4gICAgICAgICAgICAgICAgJ0ZpbHRlciBvcGVyYXRpb25zIGNhblxcJ3QgYmUgdXNlZCBpbiByYW5nZWQgcXVlcmllcycsXHJcbiAgICAgICAgICAgICAgICBsb2csIGZpbHRlciwgb3JkZXJCeSwgZmllbGRzLCBjb2xsZWN0aW9uLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaW5kZXhlcyA9IGdldFVzZWRJbmRleGVzKGZpZWxkcywgY29sbGVjdGlvbik7XHJcbiAgICBpZiAoIWluZGV4ZXMpIHtcclxuICAgICAgICBpZiAobG9nKSB7XHJcbiAgICAgICAgICAgIGxvZ1Nsb3dSZWFzb24oXHJcbiAgICAgICAgICAgICAgICAnQXZhaWxhYmxlIGluZGV4ZXMgY2FuXFwndCBiZSB1c2VkIGZvciBmaWx0ZXIgZmllbGRzJyxcclxuICAgICAgICAgICAgICAgIGxvZywgZmlsdGVyLCBvcmRlckJ5LCBmaWVsZHMsIGNvbGxlY3Rpb24sXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAob3JkZXJCeS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgaWYgKCFvcmRlckJ5Q2FuVXNlQW55SW5kZXgob3JkZXJCeSwgZmllbGRzLCBpbmRleGVzKSkge1xyXG4gICAgICAgICAgICBpZiAobG9nKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dTbG93UmVhc29uKFxyXG4gICAgICAgICAgICAgICAgICAgICdPcmRlciBieSBjYW5cXCd0IHVzZSBhbnkgc2VsZWN0ZWQgaW5kZXgnLFxyXG4gICAgICAgICAgICAgICAgICAgIGxvZywgZmlsdGVyLCBvcmRlckJ5LCBmaWVsZHMsIGNvbGxlY3Rpb24sIGluZGV4ZXMsXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRydWU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0Zhc3RRdWVyeShcclxuICAgIGNvbGxlY3Rpb246IENvbGxlY3Rpb25JbmZvLFxyXG4gICAgdHlwZTogUVR5cGUsXHJcbiAgICBmaWx0ZXI6IGFueSxcclxuICAgIG9yZGVyQnk6IE9yZGVyQnlbXSxcclxuICAgIGxvZzogP1FMb2csXHJcbik6IGJvb2xlYW4ge1xyXG4gICAgY29uc3Qgb3JPcGVyYW5kcyA9IHNwbGl0T3IoZmlsdGVyKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JPcGVyYW5kcy5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgIGlmICghaXNGYXN0UXVlcnlPck9wZXJhbmQoY29sbGVjdGlvbiwgdHlwZSwgb3JPcGVyYW5kc1tpXSwgb3JkZXJCeSwgbG9nKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbn1cclxuIl19