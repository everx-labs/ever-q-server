"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DocSubscription = exports.DocUpsertHandler = void 0;

var _iterall = require("iterall");

var _dbTypes = require("./db-types");

class DocUpsertHandler {
  constructor(collectionName, docType, accessRights, filter) {
    this.docType = docType;
    this.authFilter = DocUpsertHandler.getAuthFilter(collectionName, accessRights);
    this.filter = filter;
  }

  static getAuthFilter(collectionName, accessRights) {
    if (accessRights.restrictToAccounts.length === 0) {
      return null;
    }

    const accounts = new Set(accessRights.restrictToAccounts);

    switch (collectionName) {
      case 'accounts':
        return doc => accounts.has(doc._key);

      case 'transactions':
        return doc => accounts.has(doc.account_addr);

      case 'messages':
        return doc => accounts.has(doc.src) || accounts.has(doc.dst);

      default:
        return _ => false;
    }
  }

  isFiltered(doc) {
    if (this.authFilter && !this.authFilter(doc)) {
      return false;
    }

    return this.docType.test(null, doc, this.filter);
  }

} //$FlowFixMe


exports.DocUpsertHandler = DocUpsertHandler;

class DocSubscription extends DocUpsertHandler {
  constructor(collectionName, docType, accessRights, filter, selection) {
    super(collectionName, docType, accessRights, filter);
    this.collectionName = collectionName;
    this.selection = selection;
    this.pullQueue = [];
    this.pushQueue = [];
    this.running = true;
    this.onClose = null;
  }

  pushDocument(doc) {
    if (this.isFiltered(doc) && !this.isQueueOverflow()) {
      const reduced = (0, _dbTypes.selectFields)(doc, this.selection);
      this.pushValue({
        [this.collectionName]: reduced
      });
    }
  }

  isQueueOverflow() {
    return this.getQueueSize() >= 10;
  }

  getQueueSize() {
    return this.pushQueue.length + this.pullQueue.length;
  }

  pushValue(value) {
    if (this.pullQueue.length !== 0) {
      this.pullQueue.shift()(this.running ? {
        value,
        done: false
      } : {
        value: undefined,
        done: true
      });
    } else {
      this.pushQueue.push(value);
    }
  }

  async next() {
    return new Promise(resolve => {
      if (this.pushQueue.length !== 0) {
        resolve(this.running ? {
          value: this.pushQueue.shift(),
          done: false
        } : {
          value: undefined,
          done: true
        });
      } else {
        this.pullQueue.push(resolve);
      }
    });
  }

  async return() {
    if (this.onClose) {
      this.onClose();
    }

    await this.emptyQueue();
    return {
      value: undefined,
      done: true
    };
  }

  async throw(error) {
    if (this.onClose) {
      this.onClose();
    }

    await this.emptyQueue();
    return Promise.reject(error);
  } //$FlowFixMe


  [_iterall.$$asyncIterator]() {
    return this;
  }

  async emptyQueue() {
    if (this.running) {
      this.running = false;
      this.pullQueue.forEach(resolve => resolve({
        value: undefined,
        done: true
      }));
      this.pullQueue = [];
      this.pushQueue = [];
    }
  }

}

exports.DocSubscription = DocSubscription;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hcmFuZ28tbGlzdGVuZXJzLmpzIl0sIm5hbWVzIjpbIkRvY1Vwc2VydEhhbmRsZXIiLCJjb25zdHJ1Y3RvciIsImNvbGxlY3Rpb25OYW1lIiwiZG9jVHlwZSIsImFjY2Vzc1JpZ2h0cyIsImZpbHRlciIsImF1dGhGaWx0ZXIiLCJnZXRBdXRoRmlsdGVyIiwicmVzdHJpY3RUb0FjY291bnRzIiwibGVuZ3RoIiwiYWNjb3VudHMiLCJTZXQiLCJkb2MiLCJoYXMiLCJfa2V5IiwiYWNjb3VudF9hZGRyIiwic3JjIiwiZHN0IiwiXyIsImlzRmlsdGVyZWQiLCJ0ZXN0IiwiRG9jU3Vic2NyaXB0aW9uIiwic2VsZWN0aW9uIiwicHVsbFF1ZXVlIiwicHVzaFF1ZXVlIiwicnVubmluZyIsIm9uQ2xvc2UiLCJwdXNoRG9jdW1lbnQiLCJpc1F1ZXVlT3ZlcmZsb3ciLCJyZWR1Y2VkIiwicHVzaFZhbHVlIiwiZ2V0UXVldWVTaXplIiwidmFsdWUiLCJzaGlmdCIsImRvbmUiLCJ1bmRlZmluZWQiLCJwdXNoIiwibmV4dCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmV0dXJuIiwiZW1wdHlRdWV1ZSIsInRocm93IiwiZXJyb3IiLCJyZWplY3QiLCIkJGFzeW5jSXRlcmF0b3IiLCJmb3JFYWNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBRUE7O0FBR08sTUFBTUEsZ0JBQU4sQ0FBdUI7QUFLMUJDLEVBQUFBLFdBQVcsQ0FDUEMsY0FETyxFQUVQQyxPQUZPLEVBR1BDLFlBSE8sRUFJUEMsTUFKTyxFQUtUO0FBQ0UsU0FBS0YsT0FBTCxHQUFlQSxPQUFmO0FBQ0EsU0FBS0csVUFBTCxHQUFrQk4sZ0JBQWdCLENBQUNPLGFBQWpCLENBQStCTCxjQUEvQixFQUErQ0UsWUFBL0MsQ0FBbEI7QUFDQSxTQUFLQyxNQUFMLEdBQWNBLE1BQWQ7QUFDSDs7QUFFRCxTQUFPRSxhQUFQLENBQXFCTCxjQUFyQixFQUE2Q0UsWUFBN0MsRUFBbUc7QUFDL0YsUUFB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S0FBSyxFQUFFRyxTQUFUO0FBQW9CRCxRQUFBQSxJQUFJLEVBQUU7QUFBMUIsT0FBRCxDQUF6QztBQUNBLFdBQUtYLFNBQUwsR0FBaUIsRUFBakI7QUFDQSxXQUFLQyxTQUFMLEdBQWlCLEVBQWpCO0FBQ0g7QUFDSjs7QUEzRitFIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCB7ICQkYXN5bmNJdGVyYXRvciB9IGZyb20gXCJpdGVyYWxsXCI7XHJcbmltcG9ydCB0eXBlIHsgQWNjZXNzUmlnaHRzIH0gZnJvbSBcIi4vYXV0aFwiO1xyXG5pbXBvcnQgeyBzZWxlY3RGaWVsZHMgfSBmcm9tIFwiLi9kYi10eXBlc1wiO1xyXG5pbXBvcnQgdHlwZSB7IEZpZWxkU2VsZWN0aW9uLCBRVHlwZSB9IGZyb20gXCIuL2RiLXR5cGVzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRG9jVXBzZXJ0SGFuZGxlciB7XHJcbiAgICBkb2NUeXBlOiBRVHlwZTtcclxuICAgIGZpbHRlcjogYW55O1xyXG4gICAgYXV0aEZpbHRlcjogPygoZG9jOiBhbnkpID0+IGJvb2xlYW4pO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsXHJcbiAgICAgICAgZG9jVHlwZTogUVR5cGUsXHJcbiAgICAgICAgYWNjZXNzUmlnaHRzOiBBY2Nlc3NSaWdodHMsXHJcbiAgICAgICAgZmlsdGVyOiBhbnksXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLmRvY1R5cGUgPSBkb2NUeXBlO1xyXG4gICAgICAgIHRoaXMuYXV0aEZpbHRlciA9IERvY1Vwc2VydEhhbmRsZXIuZ2V0QXV0aEZpbHRlcihjb2xsZWN0aW9uTmFtZSwgYWNjZXNzUmlnaHRzKTtcclxuICAgICAgICB0aGlzLmZpbHRlciA9IGZpbHRlcjtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgZ2V0QXV0aEZpbHRlcihjb2xsZWN0aW9uTmFtZTogc3RyaW5nLCBhY2Nlc3NSaWdodHM6IEFjY2Vzc1JpZ2h0cyk6ID8oKGRvYzogYW55KSA9PiBib29sZWFuKSB7XHJcbiAgICAgICAgaWYgKGFjY2Vzc1JpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBhY2NvdW50cyA9IG5ldyBTZXQoYWNjZXNzUmlnaHRzLnJlc3RyaWN0VG9BY2NvdW50cyk7XHJcbiAgICAgICAgc3dpdGNoIChjb2xsZWN0aW9uTmFtZSkge1xyXG4gICAgICAgIGNhc2UgJ2FjY291bnRzJzpcclxuICAgICAgICAgICAgcmV0dXJuIChkb2MpID0+IGFjY291bnRzLmhhcyhkb2MuX2tleSk7XHJcbiAgICAgICAgY2FzZSAndHJhbnNhY3Rpb25zJzpcclxuICAgICAgICAgICAgcmV0dXJuIChkb2MpID0+IGFjY291bnRzLmhhcyhkb2MuYWNjb3VudF9hZGRyKTtcclxuICAgICAgICBjYXNlICdtZXNzYWdlcyc6XHJcbiAgICAgICAgICAgIHJldHVybiAoZG9jKSA9PiBhY2NvdW50cy5oYXMoZG9jLnNyYykgfHwgYWNjb3VudHMuaGFzKGRvYy5kc3QpO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHJldHVybiAoXykgPT4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlzRmlsdGVyZWQoZG9jOiBhbnkpOiBib29sZWFuIHtcclxuICAgICAgICBpZiAodGhpcy5hdXRoRmlsdGVyICYmICF0aGlzLmF1dGhGaWx0ZXIoZG9jKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmRvY1R5cGUudGVzdChudWxsLCBkb2MsIHRoaXMuZmlsdGVyKTtcclxuICAgIH1cclxufVxyXG5cclxuLy8kRmxvd0ZpeE1lXHJcbmV4cG9ydCBjbGFzcyBEb2NTdWJzY3JpcHRpb24gZXh0ZW5kcyBEb2NVcHNlcnRIYW5kbGVyIGltcGxlbWVudHMgQXN5bmNJdGVyYXRvcjxhbnk+IHtcclxuICAgIGNvbGxlY3Rpb25OYW1lOiBzdHJpbmc7XHJcbiAgICBzZWxlY3Rpb246IEZpZWxkU2VsZWN0aW9uW107XHJcbiAgICBwdWxsUXVldWU6ICgodmFsdWU6IGFueSkgPT4gdm9pZClbXTtcclxuICAgIHB1c2hRdWV1ZTogYW55W107XHJcbiAgICBydW5uaW5nOiBib29sZWFuO1xyXG4gICAgb25DbG9zZTogPygoKSA9PiB2b2lkKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBjb2xsZWN0aW9uTmFtZTogc3RyaW5nLFxyXG4gICAgICAgIGRvY1R5cGU6IFFUeXBlLFxyXG4gICAgICAgIGFjY2Vzc1JpZ2h0czogQWNjZXNzUmlnaHRzLFxyXG4gICAgICAgIGZpbHRlcjogYW55LFxyXG4gICAgICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcclxuICAgICkge1xyXG4gICAgICAgIHN1cGVyKGNvbGxlY3Rpb25OYW1lLCBkb2NUeXBlLCBhY2Nlc3NSaWdodHMsIGZpbHRlcik7XHJcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uTmFtZSA9IGNvbGxlY3Rpb25OYW1lO1xyXG4gICAgICAgIHRoaXMuc2VsZWN0aW9uID0gc2VsZWN0aW9uO1xyXG4gICAgICAgIHRoaXMucHVsbFF1ZXVlID0gW107XHJcbiAgICAgICAgdGhpcy5wdXNoUXVldWUgPSBbXTtcclxuICAgICAgICB0aGlzLnJ1bm5pbmcgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMub25DbG9zZSA9IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcHVzaERvY3VtZW50KGRvYzogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNGaWx0ZXJlZChkb2MpICYmICF0aGlzLmlzUXVldWVPdmVyZmxvdygpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlZHVjZWQgPSBzZWxlY3RGaWVsZHMoZG9jLCB0aGlzLnNlbGVjdGlvbik7XHJcbiAgICAgICAgICAgIHRoaXMucHVzaFZhbHVlKHsgW3RoaXMuY29sbGVjdGlvbk5hbWVdOiByZWR1Y2VkIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpc1F1ZXVlT3ZlcmZsb3coKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UXVldWVTaXplKCkgPj0gMTA7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UXVldWVTaXplKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucHVzaFF1ZXVlLmxlbmd0aCArIHRoaXMucHVsbFF1ZXVlLmxlbmd0aDtcclxuICAgIH1cclxuXHJcbiAgICBwdXNoVmFsdWUodmFsdWU6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLnB1bGxRdWV1ZS5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUuc2hpZnQoKSh0aGlzLnJ1bm5pbmdcclxuICAgICAgICAgICAgICAgID8geyB2YWx1ZSwgZG9uZTogZmFsc2UgfVxyXG4gICAgICAgICAgICAgICAgOiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfSxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnB1c2hRdWV1ZS5wdXNoKHZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgbmV4dCgpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5wdXNoUXVldWUubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMucnVubmluZ1xyXG4gICAgICAgICAgICAgICAgICAgID8geyB2YWx1ZTogdGhpcy5wdXNoUXVldWUuc2hpZnQoKSwgZG9uZTogZmFsc2UgfVxyXG4gICAgICAgICAgICAgICAgICAgIDogeyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0sXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUucHVzaChyZXNvbHZlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHJldHVybigpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgICAgIGlmICh0aGlzLm9uQ2xvc2UpIHtcclxuICAgICAgICAgICAgdGhpcy5vbkNsb3NlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGF3YWl0IHRoaXMuZW1wdHlRdWV1ZSgpO1xyXG4gICAgICAgIHJldHVybiB7IHZhbHVlOiB1bmRlZmluZWQsIGRvbmU6IHRydWUgfTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyB0aHJvdyhlcnJvcj86IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgaWYgKHRoaXMub25DbG9zZSkge1xyXG4gICAgICAgICAgICB0aGlzLm9uQ2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXdhaXQgdGhpcy5lbXB0eVF1ZXVlKCk7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyRGbG93Rml4TWVcclxuICAgIFskJGFzeW5jSXRlcmF0b3JdKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGVtcHR5UXVldWUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucnVubmluZykge1xyXG4gICAgICAgICAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUuZm9yRWFjaChyZXNvbHZlID0+IHJlc29sdmUoeyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0pKTtcclxuICAgICAgICAgICAgdGhpcy5wdWxsUXVldWUgPSBbXTtcclxuICAgICAgICAgICAgdGhpcy5wdXNoUXVldWUgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==