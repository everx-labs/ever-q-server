"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.main = main;

var _config = require("./config");

var _server = _interopRequireDefault(require("./server"));

var _logs = _interopRequireDefault(require("./logs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const program = require('commander');

const commandLineDefaults = (0, _config.resolveOptions)({}, process.env, _config.defaultOptions);
program.option('-h, --host <host>', 'listening address', commandLineDefaults.host).option('-p, --port <port>', 'listening port', commandLineDefaults.port).option('--rpc-port <port>', 'listening rpc port', commandLineDefaults.rpcPort).option('-m, --requests-mode <mode>', 'Requests mode (kafka | rest)', commandLineDefaults.requestsMode).option('-r, --requests-server <url>', 'Requests server url', commandLineDefaults.requestsServer).option('-t, --requests-topic <name>', 'Requests topic name', commandLineDefaults.requestsTopic).option('-d, --db-server <address>', 'database server:port', commandLineDefaults.dbServer).option('-n, --db-name <name>', 'database name', commandLineDefaults.dbName).option('-a, --db-auth <name>', 'database auth in form "user:password', commandLineDefaults.dbAuth).option('--db-max-sockets <number>', 'database max sockets', commandLineDefaults.dbMaxSockets).option('--slow-db-server <address>', 'slow queries database server:port', commandLineDefaults.slowDbServer).option('--slow-db-name <name>', 'slow database name', commandLineDefaults.slowDbName).option('--slow-db-auth <name>', 'slow database auth in form "user:password', commandLineDefaults.slowDbAuth).option('--slow-db-max-sockets <number>', 'slow database max sockets', commandLineDefaults.slowDbMaxSockets).option('--auth-endpoint <url>', 'auth endpoint', commandLineDefaults.authEndpoint).option('--mam-access-keys <keys>', 'Access keys used to authorize mam endpoint access', commandLineDefaults.mamAccessKeys).option('-j, --jaeger-endpoint <url>', 'jaeger endpoint', commandLineDefaults.jaegerEndpoint).option('--trace-service <name>', 'trace service name', commandLineDefaults.traceService).option('--trace-tags <tags>', 'additional trace tags (comma separated name=value pairs)', commandLineDefaults.traceTags).option('-s, --statsd-server <url>', 'statsd server (host:port)', commandLineDefaults.statsdServer).option('--statsd-tags <tags>', 'additional statsd tags (comma separated name=value pairs)', commandLineDefaults.statsdTags).option('--keep-alive <ms>', 'additional statsd tags (comma separated name=value pairs)', commandLineDefaults.keepAlive).parse(process.argv);
const config = (0, _config.createConfig)(program, process.env, _config.defaultOptions);
const logs = new _logs.default();
const configLog = logs.create('config');
configLog.debug('USE', config);
const server = new _server.default({
  config,
  logs
});

function main() {
  (async () => {
    try {
      await server.start();
    } catch (error) {
      server.log.error('FAILED', 'START', error);
      process.exit(1);
    }
  })();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9ncmFtIiwicmVxdWlyZSIsImNvbW1hbmRMaW5lRGVmYXVsdHMiLCJwcm9jZXNzIiwiZW52IiwiZGVmYXVsdE9wdGlvbnMiLCJvcHRpb24iLCJob3N0IiwicG9ydCIsInJwY1BvcnQiLCJyZXF1ZXN0c01vZGUiLCJyZXF1ZXN0c1NlcnZlciIsInJlcXVlc3RzVG9waWMiLCJkYlNlcnZlciIsImRiTmFtZSIsImRiQXV0aCIsImRiTWF4U29ja2V0cyIsInNsb3dEYlNlcnZlciIsInNsb3dEYk5hbWUiLCJzbG93RGJBdXRoIiwic2xvd0RiTWF4U29ja2V0cyIsImF1dGhFbmRwb2ludCIsIm1hbUFjY2Vzc0tleXMiLCJqYWVnZXJFbmRwb2ludCIsInRyYWNlU2VydmljZSIsInRyYWNlVGFncyIsInN0YXRzZFNlcnZlciIsInN0YXRzZFRhZ3MiLCJrZWVwQWxpdmUiLCJwYXJzZSIsImFyZ3YiLCJjb25maWciLCJsb2dzIiwiUUxvZ3MiLCJjb25maWdMb2ciLCJjcmVhdGUiLCJkZWJ1ZyIsInNlcnZlciIsIlRPTlFTZXJ2ZXIiLCJtYWluIiwic3RhcnQiLCJlcnJvciIsImxvZyIsImV4aXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFrQkE7O0FBRUE7O0FBQ0E7Ozs7QUFyQkE7Ozs7Ozs7Ozs7Ozs7OztBQXVCQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQXZCOztBQUNBLE1BQU1DLG1CQUFtQixHQUFHLDRCQUFlLEVBQWYsRUFBbUJDLE9BQU8sQ0FBQ0MsR0FBM0IsRUFBZ0NDLHNCQUFoQyxDQUE1QjtBQUVBTCxPQUFPLENBQ0ZNLE1BREwsQ0FDWSxtQkFEWixFQUNpQyxtQkFEakMsRUFDc0RKLG1CQUFtQixDQUFDSyxJQUQxRSxFQUVLRCxNQUZMLENBRVksbUJBRlosRUFFaUMsZ0JBRmpDLEVBRW1ESixtQkFBbUIsQ0FBQ00sSUFGdkUsRUFHS0YsTUFITCxDQUdZLG1CQUhaLEVB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QTJCLE9BQTNCLEVBQW9DQSxLQUFwQztBQUNBdEMsTUFBQUEsT0FBTyxDQUFDd0MsSUFBUixDQUFhLENBQWI7QUFDSDtBQUNKLEdBUEQ7QUFRSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIENvcHlyaWdodCAyMDE4LTIwMjAgVE9OIERFViBTT0xVVElPTlMgTFRELlxyXG4gKlxyXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcclxuICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlXHJcbiAqIExpY2Vuc2UgYXQ6XHJcbiAqXHJcbiAqIGh0dHA6Ly93d3cudG9uLmRldi9saWNlbnNlc1xyXG4gKlxyXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cclxuICovXHJcblxyXG4vLyBAZmxvd1xyXG5cclxuaW1wb3J0IHtjcmVhdGVDb25maWcsIGRlZmF1bHRPcHRpb25zLCByZXNvbHZlT3B0aW9uc30gZnJvbSAnLi9jb25maWcnO1xyXG5pbXBvcnQgdHlwZSB7IFFDb25maWcgfSBmcm9tIFwiLi9jb25maWdcIjtcclxuaW1wb3J0IFRPTlFTZXJ2ZXIgZnJvbSAnLi9zZXJ2ZXInO1xyXG5pbXBvcnQgUUxvZ3MgZnJvbSAnLi9sb2dzJztcclxuXHJcbmNvbnN0IHByb2dyYW0gPSByZXF1aXJlKCdjb21tYW5kZXInKTtcclxuY29uc3QgY29tbWFuZExpbmVEZWZhdWx0cyA9IHJlc29sdmVPcHRpb25zKHt9LCBwcm9jZXNzLmVudiwgZGVmYXVsdE9wdGlvbnMpO1xyXG5cclxucHJvZ3JhbVxyXG4gICAgLm9wdGlvbignLWgsIC0taG9zdCA8aG9zdD4nLCAnbGlzdGVuaW5nIGFkZHJlc3MnLCBjb21tYW5kTGluZURlZmF1bHRzLmhvc3QpXHJcbiAgICAub3B0aW9uKCctcCwgLS1wb3J0IDxwb3J0PicsICdsaXN0ZW5pbmcgcG9ydCcsIGNvbW1hbmRMaW5lRGVmYXVsdHMucG9ydClcclxuICAgIC5vcHRpb24oJy0tcnBjLXBvcnQgPHBvcnQ+JywgJ2xpc3RlbmluZyBycGMgcG9ydCcsIGNvbW1hbmRMaW5lRGVmYXVsdHMucnBjUG9ydClcclxuXHJcbiAgICAub3B0aW9uKCctbSwgLS1yZXF1ZXN0cy1tb2RlIDxtb2RlPicsICdSZXF1ZXN0cyBtb2RlIChrYWZrYSB8IHJlc3QpJywgY29tbWFuZExpbmVEZWZhdWx0cy5yZXF1ZXN0c01vZGUpXHJcbiAgICAub3B0aW9uKCctciwgLS1yZXF1ZXN0cy1zZXJ2ZXIgPHVybD4nLCAnUmVxdWVzdHMgc2VydmVyIHVybCcsIGNvbW1hbmRMaW5lRGVmYXVsdHMucmVxdWVzdHNTZXJ2ZXIpXHJcbiAgICAub3B0aW9uKCctdCwgLS1yZXF1ZXN0cy10b3BpYyA8bmFtZT4nLCAnUmVxdWVzdHMgdG9waWMgbmFtZScsIGNvbW1hbmRMaW5lRGVmYXVsdHMucmVxdWVzdHNUb3BpYylcclxuXHJcbiAgICAub3B0aW9uKCctZCwgLS1kYi1zZXJ2ZXIgPGFkZHJlc3M+JywgJ2RhdGFiYXNlIHNlcnZlcjpwb3J0JywgY29tbWFuZExpbmVEZWZhdWx0cy5kYlNlcnZlcilcclxuICAgIC5vcHRpb24oJy1uLCAtLWRiLW5hbWUgPG5hbWU+JywgJ2RhdGFiYXNlIG5hbWUnLCBjb21tYW5kTGluZURlZmF1bHRzLmRiTmFtZSlcclxuICAgIC5vcHRpb24oJy1hLCAtLWRiLWF1dGggPG5hbWU+JywgJ2RhdGFiYXNlIGF1dGggaW4gZm9ybSBcInVzZXI6cGFzc3dvcmQnLCBjb21tYW5kTGluZURlZmF1bHRzLmRiQXV0aClcclxuICAgIC5vcHRpb24oJy0tZGItbWF4LXNvY2tldHMgPG51bWJlcj4nLCAnZGF0YWJhc2UgbWF4IHNvY2tldHMnLCBjb21tYW5kTGluZURlZmF1bHRzLmRiTWF4U29ja2V0cylcclxuXHJcbiAgICAub3B0aW9uKCctLXNsb3ctZGItc2VydmVyIDxhZGRyZXNzPicsICdzbG93IHF1ZXJpZXMgZGF0YWJhc2Ugc2VydmVyOnBvcnQnLCBjb21tYW5kTGluZURlZmF1bHRzLnNsb3dEYlNlcnZlcilcclxuICAgIC5vcHRpb24oJy0tc2xvdy1kYi1uYW1lIDxuYW1lPicsICdzbG93IGRhdGFiYXNlIG5hbWUnLCBjb21tYW5kTGluZURlZmF1bHRzLnNsb3dEYk5hbWUpXHJcbiAgICAub3B0aW9uKCctLXNsb3ctZGItYXV0aCA8bmFtZT4nLCAnc2xvdyBkYXRhYmFzZSBhdXRoIGluIGZvcm0gXCJ1c2VyOnBhc3N3b3JkJywgY29tbWFuZExpbmVEZWZhdWx0cy5zbG93RGJBdXRoKVxyXG4gICAgLm9wdGlvbignLS1zbG93LWRiLW1heC1zb2NrZXRzIDxudW1iZXI+JywgJ3Nsb3cgZGF0YWJhc2UgbWF4IHNvY2tldHMnLCBjb21tYW5kTGluZURlZmF1bHRzLnNsb3dEYk1heFNvY2tldHMpXHJcblxyXG4gICAgLm9wdGlvbignLS1hdXRoLWVuZHBvaW50IDx1cmw+JywgJ2F1dGggZW5kcG9pbnQnLCBjb21tYW5kTGluZURlZmF1bHRzLmF1dGhFbmRwb2ludClcclxuICAgIC5vcHRpb24oJy0tbWFtLWFjY2Vzcy1rZXlzIDxrZXlzPicsICdBY2Nlc3Mga2V5cyB1c2VkIHRvIGF1dGhvcml6ZSBtYW0gZW5kcG9pbnQgYWNjZXNzJywgY29tbWFuZExpbmVEZWZhdWx0cy5tYW1BY2Nlc3NLZXlzKVxyXG5cclxuICAgIC5vcHRpb24oJy1qLCAtLWphZWdlci1lbmRwb2ludCA8dXJsPicsICdqYWVnZXIgZW5kcG9pbnQnLCBjb21tYW5kTGluZURlZmF1bHRzLmphZWdlckVuZHBvaW50KVxyXG4gICAgLm9wdGlvbignLS10cmFjZS1zZXJ2aWNlIDxuYW1lPicsICd0cmFjZSBzZXJ2aWNlIG5hbWUnLCBjb21tYW5kTGluZURlZmF1bHRzLnRyYWNlU2VydmljZSlcclxuICAgIC5vcHRpb24oJy0tdHJhY2UtdGFncyA8dGFncz4nLCAnYWRkaXRpb25hbCB0cmFjZSB0YWdzIChjb21tYSBzZXBhcmF0ZWQgbmFtZT12YWx1ZSBwYWlycyknLCBjb21tYW5kTGluZURlZmF1bHRzLnRyYWNlVGFncylcclxuXHJcbiAgICAub3B0aW9uKCctcywgLS1zdGF0c2Qtc2VydmVyIDx1cmw+JywgJ3N0YXRzZCBzZXJ2ZXIgKGhvc3Q6cG9ydCknLCBjb21tYW5kTGluZURlZmF1bHRzLnN0YXRzZFNlcnZlcilcclxuICAgIC5vcHRpb24oJy0tc3RhdHNkLXRhZ3MgPHRhZ3M+JywgJ2FkZGl0aW9uYWwgc3RhdHNkIHRhZ3MgKGNvbW1hIHNlcGFyYXRlZCBuYW1lPXZhbHVlIHBhaXJzKScsIGNvbW1hbmRMaW5lRGVmYXVsdHMuc3RhdHNkVGFncylcclxuXHJcbiAgICAub3B0aW9uKCctLWtlZXAtYWxpdmUgPG1zPicsICdhZGRpdGlvbmFsIHN0YXRzZCB0YWdzIChjb21tYSBzZXBhcmF0ZWQgbmFtZT12YWx1ZSBwYWlycyknLCBjb21tYW5kTGluZURlZmF1bHRzLmtlZXBBbGl2ZSlcclxuXHJcbiAgICAucGFyc2UocHJvY2Vzcy5hcmd2KTtcclxuXHJcblxyXG5jb25zdCBjb25maWc6IFFDb25maWcgPSBjcmVhdGVDb25maWcocHJvZ3JhbSwgcHJvY2Vzcy5lbnYsIGRlZmF1bHRPcHRpb25zKTtcclxuXHJcbmNvbnN0IGxvZ3MgPSBuZXcgUUxvZ3MoKTtcclxuY29uc3QgY29uZmlnTG9nID0gbG9ncy5jcmVhdGUoJ2NvbmZpZycpO1xyXG5jb25maWdMb2cuZGVidWcoJ1VTRScsIGNvbmZpZyk7XHJcblxyXG5jb25zdCBzZXJ2ZXIgPSBuZXcgVE9OUVNlcnZlcih7XHJcbiAgICBjb25maWcsXHJcbiAgICBsb2dzLFxyXG59KTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYWluKCkge1xyXG4gICAgKGFzeW5jICgpID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBhd2FpdCBzZXJ2ZXIuc3RhcnQoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBzZXJ2ZXIubG9nLmVycm9yKCdGQUlMRUQnLCAnU1RBUlQnLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcclxuICAgICAgICB9XHJcbiAgICB9KSgpO1xyXG59XHJcbiJdfQ==