"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AggregationHelperFactory = exports.AggregationFn = void 0;

var _resolversGenerated = require("./resolvers-generated");

const AggregationFn = {
  COUNT: 'COUNT',
  MIN: 'MIN',
  MAX: 'MAX',
  SUM: 'SUM',
  AVERAGE: 'AVERAGE'
};
exports.AggregationFn = AggregationFn;

// Query Builders

/**
 * Returns query parts in form of:
 * { collect: 'a<i> = <exprs0>', result: 'a<i>'} if exprs.length === 1
 * or
 * { collect: 'a<i> = <exprs0>, b<i> = <exprs1>, ..'., result: '{ a: a<i>, b: b<i>, ... }'}
 * if exprs.length > 1
 *
 * @param exprs
 * @param context
 * @return {{result: string, collects: string}}
 */
function queryParts(context, ...exprs) {
  const n = 'abcdef';

  const v = i => `${n[i]}${context.index}`; // 'a0' | 'b0' | ...


  const collectExpr = (x, i) => `${v(i)} = ${x}`; // 'a0 = expr[0]' | 'b0 = expr[1]' | ...


  const returnExpr = (x, i) => `${n[i]}: ${v(i)}`; // 'a: a0' | 'b: b0' | ...


  return {
    collect: exprs.map(collectExpr).join(', '),
    // 'a0 = expr[0], b0 = expr[1], ...'
    result: exprs.length === 1 ? `${v(0)}` // 'a0'
    : `{ ${exprs.map(returnExpr).join(', ')} }` // '{ a: a0, b: b0, ... }'

  };
}

const countField = {
  type: 'string',
  path: ''
};

function count(context) {
  return queryParts(context, 'COUNT(doc)');
}

function simple(context) {
  const fn = context.fn;
  return queryParts(context, context.isArray ? `${fn}(${fn}(${context.field.path}))` : `${fn}(${context.field.path})`);
}

function bigIntToNum(hex) {
  return `TO_NUMBER(CONCAT("0x", ${hex}))`;
}

function bigIntHiPart(path, prefix) {
  return bigIntToNum(`SUBSTRING(${path}, ${prefix}, LENGTH(${path}) - ${prefix + 8})`);
}

function bigIntLoPart(path, prefix) {
  return bigIntToNum(`RIGHT(SUBSTRING(${path}, ${prefix}), 8)`);
}

function bigIntSumExpr(part, context) {
  const path = context.field.path;
  const prefix = context.bigIntPrefix;
  return context.isArray ? `SUM(SUM((${path})[* RETURN ${part('CURRENT', prefix)}]))` : `SUM(${part(path, prefix)})`;
}

function bigIntSum(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context));
}

function bigIntAvg(context) {
  return queryParts(context, bigIntSumExpr(bigIntHiPart, context), bigIntSumExpr(bigIntLoPart, context), context.isArray ? `SUM(COUNT(${context.field.path}))` : `COUNT(doc)`);
} // Result converters


function convertNone(context, value) {
  return value;
}

function bigIntString(context, value) {
  if (typeof value === 'number') {
    return value.toString();
  } //$FlowFixMe


  return BigInt(`0x${value.substr(context.bigIntPrefix)}`).toString();
} //$FlowFixMe


function bigIntFromParts(parts) {
  const h = BigInt(`0x${Math.round(parts.a).toString(16)}00000000`);
  const l = BigInt(Math.round(parts.b));
  return h + l;
}

function bigIntParts(context, value) {
  return bigIntFromParts(value).toString();
}

function bigIntPartsAvg(context, value) {
  const sum = bigIntFromParts(value);
  const count = Number(value.c || 0);
  const avg = count > 0 ? sum / BigInt(Math.round(count)) : sum;
  return avg.toString();
}

class AggregationHelperFactory {
  static create(collection, index, aggregation) {
    const field = _resolversGenerated.scalarFields.get(`${collection}.${aggregation.field || 'id'}`) || countField;
    const fn = aggregation.fn || AggregationFn.COUNT;
    const context = {
      index,
      field,
      fn,
      bigIntPrefix: field.type === 'uint1024' ? 2 : field.type === 'uint64' ? 1 : 0,
      isArray: field.path.includes('[*]')
    };

    if (context.fn === AggregationFn.COUNT) {
      return {
        context,
        buildQuery: count,
        convertResult: convertNone
      };
    }

    if (context.field.path === '') {
      throw new Error(`[${aggregation.field}] can't be aggregated`);
    }

    if (fn === AggregationFn.MIN || fn === AggregationFn.MAX) {
      return {
        context,
        buildQuery: simple,
        convertResult: context.bigIntPrefix > 0 ? bigIntString : convertNone
      };
    }

    if (field.type === 'number') {
      return {
        context,
        buildQuery: simple,
        convertResult: convertNone
      };
    }

    if (context.bigIntPrefix > 0) {
      return context.fn === AggregationFn.AVERAGE ? {
        context,
        buildQuery: bigIntAvg,
        convertResult: bigIntPartsAvg
      } : {
        context,
        buildQuery: bigIntSum,
        convertResult: bigIntParts
      };
    }

    throw new Error(`[${aggregation.field}] can't be used with [${fn}]`);
  }

  static createQuery(collection, filter, fields) {
    const filterSection = filter ? `FILTER ${filter}` : '';
    const helpers = fields.map((aggregation, i) => {
      return AggregationHelperFactory.create(collection, i, aggregation);
    });
    let text;
    const isSingleCount = fields.length === 1 && fields[0].fn === AggregationFn.COUNT;

    if (isSingleCount) {
      if (filterSection !== '') {
        text = `
                    FOR doc IN ${collection}
                    ${filterSection}
                    COLLECT WITH COUNT INTO a0
                    RETURN [a0]`;
      } else {
        text = `RETURN [LENGTH(${collection})]`;
      }
    } else {
      const queries = helpers.map(x => x.buildQuery(x.context));
      text = `
                FOR doc IN ${collection}
                ${filterSection}
                COLLECT AGGREGATE ${queries.map(x => x.collect).join(', ')}
                RETURN [${queries.map(x => x.result).join(', ')}]`;
    }

    return {
      text,
      helpers
    };
  }

  static convertResults(results, helpers) {
    return results.map((x, i) => {
      if (x === undefined || x === null) {
        return x;
      }

      const helper = helpers[i];
      return helper.convertResult(helper.context, x);
    });
  }

}

exports.AggregationHelperFactory = AggregationHelperFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hZ2dyZWdhdGlvbnMuanMiXSwibmFtZXMiOlsiQWdncmVnYXRpb25GbiIsIkNPVU5UIiwiTUlOIiwiTUFYIiwiU1VNIiwiQVZFUkFHRSIsInF1ZXJ5UGFydHMiLCJjb250ZXh0IiwiZXhwcnMiLCJuIiwidiIsImkiLCJpbmRleCIsImNvbGxlY3RFeHByIiwieCIsInJldHVybkV4cHIiLCJjb2xsZWN0IiwibWFwIiwiam9pbiIsInJlc3VsdCIsImxlbmd0aCIsImNvdW50RmllbGQiLCJ0eXBlIiwicGF0aCIsImNvdW50Iiwic2ltcGxlIiwiZm4iLCJpc0FycmF5IiwiZmllbGQiLCJiaWdJbnRUb051bSIsImhleCIsImJpZ0ludEhpUGFydCIsInByZWZpeCIsImJpZ0ludExvUGFydCIsImJpZ0ludFN1bUV4cHIiLCJwYXJ0IiwiYmlnSW50UHJlZml4IiwiYmlnSW50U3VtIiwiYmlnSW50QXZnIiwiY29udmVydE5vbmUiLCJ2YWx1ZSIsImJpZ0ludFN0cmluZyIsInRvU3RyaW5nIiwiQmlnSW50Iiwic3Vic3RyIiwiYmlnSW50RnJvbVBhcnRzIiwicGFydHMiLCJoIiwiTWF0aCIsInJvdW5kIiwiYSIsImwiLCJiIiwiYmlnSW50UGFydHMiLCJiaWdJbnRQYXJ0c0F2ZyIsInN1bSIsIk51bWJlciIsImMiLCJhdmciLCJBZ2dyZWdhdGlvbkhlbHBlckZhY3RvcnkiLCJjcmVhdGUiLCJjb2xsZWN0aW9uIiwiYWdncmVnYXRpb24iLCJzY2FsYXJGaWVsZHMiLCJnZXQiLCJpbmNsdWRlcyIsImJ1aWxkUXVlcnkiLCJjb252ZXJ0UmVzdWx0IiwiRXJyb3IiLCJjcmVhdGVRdWVyeSIsImZpbHRlciIsImZpZWxkcyIsImZpbHRlclNlY3Rpb24iLCJoZWxwZXJzIiwidGV4dCIsImlzU2luZ2xlQ291bnQiLCJxdWVyaWVzIiwiY29udmVydFJlc3VsdHMiLCJyZXN1bHRzIiwidW5kZWZpbmVkIiwiaGVscGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FB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c0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCB0eXBlIHsgU2NhbGFyRmllbGQgfSBmcm9tIFwiLi9kYi10eXBlc1wiO1xyXG5pbXBvcnQgeyBzY2FsYXJGaWVsZHMgfSBmcm9tIFwiLi9yZXNvbHZlcnMtZ2VuZXJhdGVkXCI7XHJcblxyXG5leHBvcnQgY29uc3QgQWdncmVnYXRpb25GbiA9IHtcclxuICAgIENPVU5UOiAnQ09VTlQnLFxyXG4gICAgTUlOOiAnTUlOJyxcclxuICAgIE1BWDogJ01BWCcsXHJcbiAgICBTVU06ICdTVU0nLFxyXG4gICAgQVZFUkFHRTogJ0FWRVJBR0UnLFxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBBZ2dyZWdhdGlvbkZuVHlwZSA9ICRLZXlzPHR5cGVvZiBBZ2dyZWdhdGlvbkZuPjtcclxuXHJcbmV4cG9ydCB0eXBlIEZpZWxkQWdncmVnYXRpb24gPSB7XHJcbiAgICBmaWVsZDogc3RyaW5nLFxyXG4gICAgZm46IEFnZ3JlZ2F0aW9uRm5UeXBlLFxyXG59XHJcblxyXG50eXBlIEFnZ3JlZ2F0aW9uQ29udGV4dCA9IHtcclxuICAgIGluZGV4OiBudW1iZXIsXHJcbiAgICBmaWVsZDogU2NhbGFyRmllbGQsXHJcbiAgICBmbjogQWdncmVnYXRpb25GblR5cGUsXHJcbiAgICBiaWdJbnRQcmVmaXg6IG51bWJlcixcclxuICAgIGlzQXJyYXk6IGJvb2xlYW4sXHJcbn1cclxuXHJcbnR5cGUgQWdncmVnYXRpb25RdWVyeVBhcnRzID0ge1xyXG4gICAgY29sbGVjdDogc3RyaW5nLFxyXG4gICAgcmVzdWx0OiBzdHJpbmcsXHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIEFnZ3JlZ2F0aW9uSGVscGVyID0ge1xyXG4gICAgY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LFxyXG4gICAgYnVpbGRRdWVyeTogKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCkgPT4gQWdncmVnYXRpb25RdWVyeVBhcnRzLFxyXG4gICAgY29udmVydFJlc3VsdDogKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSkgPT4gYW55LFxyXG59XHJcblxyXG4vLyBRdWVyeSBCdWlsZGVyc1xyXG5cclxuLyoqXHJcbiAqIFJldHVybnMgcXVlcnkgcGFydHMgaW4gZm9ybSBvZjpcclxuICogeyBjb2xsZWN0OiAnYTxpPiA9IDxleHByczA+JywgcmVzdWx0OiAnYTxpPid9IGlmIGV4cHJzLmxlbmd0aCA9PT0gMVxyXG4gKiBvclxyXG4gKiB7IGNvbGxlY3Q6ICdhPGk+ID0gPGV4cHJzMD4sIGI8aT4gPSA8ZXhwcnMxPiwgLi4nLiwgcmVzdWx0OiAneyBhOiBhPGk+LCBiOiBiPGk+LCAuLi4gfSd9XHJcbiAqIGlmIGV4cHJzLmxlbmd0aCA+IDFcclxuICpcclxuICogQHBhcmFtIGV4cHJzXHJcbiAqIEBwYXJhbSBjb250ZXh0XHJcbiAqIEByZXR1cm4ge3tyZXN1bHQ6IHN0cmluZywgY29sbGVjdHM6IHN0cmluZ319XHJcbiAqL1xyXG5mdW5jdGlvbiBxdWVyeVBhcnRzKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgLi4uZXhwcnM6IHN0cmluZ1tdKTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcclxuICAgIGNvbnN0IG4gPSAnYWJjZGVmJztcclxuICAgIGNvbnN0IHYgPSAoaSkgPT4gYCR7bltpXX0ke2NvbnRleHQuaW5kZXh9YDsgLy8gJ2EwJyB8ICdiMCcgfCAuLi5cclxuICAgIGNvbnN0IGNvbGxlY3RFeHByID0gKHgsIGkpID0+IGAke3YoaSl9ID0gJHt4fWA7IC8vICdhMCA9IGV4cHJbMF0nIHwgJ2IwID0gZXhwclsxXScgfCAuLi5cclxuICAgIGNvbnN0IHJldHVybkV4cHIgPSAoeCwgaSkgPT4gYCR7bltpXX06ICR7dihpKX1gOyAvLyAnYTogYTAnIHwgJ2I6IGIwJyB8IC4uLlxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBjb2xsZWN0OiBleHBycy5tYXAoY29sbGVjdEV4cHIpLmpvaW4oJywgJyksIC8vICdhMCA9IGV4cHJbMF0sIGIwID0gZXhwclsxXSwgLi4uJ1xyXG4gICAgICAgIHJlc3VsdDogZXhwcnMubGVuZ3RoID09PSAxXHJcbiAgICAgICAgICAgID8gYCR7digwKX1gIC8vICdhMCdcclxuICAgICAgICAgICAgOiBgeyAke2V4cHJzLm1hcChyZXR1cm5FeHByKS5qb2luKCcsICcpfSB9YCwgLy8gJ3sgYTogYTAsIGI6IGIwLCAuLi4gfSdcclxuICAgIH1cclxufVxyXG5cclxuY29uc3QgY291bnRGaWVsZDogU2NhbGFyRmllbGQgPSB7XHJcbiAgICB0eXBlOiAnc3RyaW5nJyxcclxuICAgIHBhdGg6ICcnLFxyXG59O1xyXG5cclxuZnVuY3Rpb24gY291bnQoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcclxuICAgIHJldHVybiBxdWVyeVBhcnRzKGNvbnRleHQsICdDT1VOVChkb2MpJyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNpbXBsZShjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQpOiBBZ2dyZWdhdGlvblF1ZXJ5UGFydHMge1xyXG4gICAgY29uc3QgZm4gPSBjb250ZXh0LmZuO1xyXG4gICAgcmV0dXJuIHF1ZXJ5UGFydHMoY29udGV4dCwgY29udGV4dC5pc0FycmF5XHJcbiAgICAgICAgPyBgJHtmbn0oJHtmbn0oJHtjb250ZXh0LmZpZWxkLnBhdGh9KSlgXHJcbiAgICAgICAgOiBgJHtmbn0oJHtjb250ZXh0LmZpZWxkLnBhdGh9KWBcclxuICAgICk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGJpZ0ludFRvTnVtKGhleDogYW55KTogc3RyaW5nIHtcclxuICAgIHJldHVybiBgVE9fTlVNQkVSKENPTkNBVChcIjB4XCIsICR7KGhleDogYW55KX0pKWBcclxufVxyXG5cclxuZnVuY3Rpb24gYmlnSW50SGlQYXJ0KHBhdGg6IHN0cmluZywgcHJlZml4OiBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGJpZ0ludFRvTnVtKGBTVUJTVFJJTkcoJHtwYXRofSwgJHtwcmVmaXh9LCBMRU5HVEgoJHtwYXRofSkgLSAke3ByZWZpeCArIDh9KWApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBiaWdJbnRMb1BhcnQocGF0aDogc3RyaW5nLCBwcmVmaXg6IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gYmlnSW50VG9OdW0oYFJJR0hUKFNVQlNUUklORygke3BhdGh9LCAke3ByZWZpeH0pLCA4KWApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBiaWdJbnRTdW1FeHByKHBhcnQ6IChwYXRoOiBzdHJpbmcsIHByZWZpeDogbnVtYmVyKSA9PiBzdHJpbmcsIGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCkge1xyXG4gICAgY29uc3QgcGF0aCA9IGNvbnRleHQuZmllbGQucGF0aDtcclxuICAgIGNvbnN0IHByZWZpeCA9IGNvbnRleHQuYmlnSW50UHJlZml4O1xyXG4gICAgcmV0dXJuIGNvbnRleHQuaXNBcnJheVxyXG4gICAgICAgID8gYFNVTShTVU0oKCR7cGF0aH0pWyogUkVUVVJOICR7cGFydCgnQ1VSUkVOVCcsIHByZWZpeCl9XSkpYFxyXG4gICAgICAgIDogYFNVTSgke3BhcnQocGF0aCwgcHJlZml4KX0pYDtcclxufVxyXG5cclxuZnVuY3Rpb24gYmlnSW50U3VtKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCk6IEFnZ3JlZ2F0aW9uUXVlcnlQYXJ0cyB7XHJcbiAgICByZXR1cm4gcXVlcnlQYXJ0cyhcclxuICAgICAgICBjb250ZXh0LFxyXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoYmlnSW50SGlQYXJ0LCBjb250ZXh0KSxcclxuICAgICAgICBiaWdJbnRTdW1FeHByKGJpZ0ludExvUGFydCwgY29udGV4dCksXHJcbiAgICApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBiaWdJbnRBdmcoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0KTogQWdncmVnYXRpb25RdWVyeVBhcnRzIHtcclxuICAgIHJldHVybiBxdWVyeVBhcnRzKFxyXG4gICAgICAgIGNvbnRleHQsXHJcbiAgICAgICAgYmlnSW50U3VtRXhwcihiaWdJbnRIaVBhcnQsIGNvbnRleHQpLFxyXG4gICAgICAgIGJpZ0ludFN1bUV4cHIoYmlnSW50TG9QYXJ0LCBjb250ZXh0KSxcclxuICAgICAgICBjb250ZXh0LmlzQXJyYXlcclxuICAgICAgICAgICAgPyBgU1VNKENPVU5UKCR7Y29udGV4dC5maWVsZC5wYXRofSkpYFxyXG4gICAgICAgICAgICA6IGBDT1VOVChkb2MpYCxcclxuICAgICk7XHJcbn1cclxuXHJcbi8vIFJlc3VsdCBjb252ZXJ0ZXJzXHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0Tm9uZShjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpOiBhbnkge1xyXG4gICAgcmV0dXJuIHZhbHVlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBiaWdJbnRTdHJpbmcoY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0LCB2YWx1ZTogYW55KTogYW55IHtcclxuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlLnRvU3RyaW5nKCk7XHJcbiAgICB9XHJcbiAgICAvLyRGbG93Rml4TWVcclxuICAgIHJldHVybiBCaWdJbnQoYDB4JHt2YWx1ZS5zdWJzdHIoY29udGV4dC5iaWdJbnRQcmVmaXgpfWApLnRvU3RyaW5nKCk7XHJcbn1cclxuXHJcbi8vJEZsb3dGaXhNZVxyXG5mdW5jdGlvbiBiaWdJbnRGcm9tUGFydHMocGFydHM6IHsgYTogbnVtYmVyLCBiOiBudW1iZXIgfSk6IEJpZ0ludCB7XHJcbiAgICBjb25zdCBoID0gQmlnSW50KGAweCR7TWF0aC5yb3VuZChwYXJ0cy5hKS50b1N0cmluZygxNil9MDAwMDAwMDBgKTtcclxuICAgIGNvbnN0IGwgPSBCaWdJbnQoTWF0aC5yb3VuZChwYXJ0cy5iKSk7XHJcbiAgICByZXR1cm4gaCArIGw7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGJpZ0ludFBhcnRzKGNvbnRleHQ6IEFnZ3JlZ2F0aW9uQ29udGV4dCwgdmFsdWU6IGFueSk6IGFueSB7XHJcbiAgICByZXR1cm4gYmlnSW50RnJvbVBhcnRzKHZhbHVlKS50b1N0cmluZygpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBiaWdJbnRQYXJ0c0F2Zyhjb250ZXh0OiBBZ2dyZWdhdGlvbkNvbnRleHQsIHZhbHVlOiBhbnkpOiBhbnkge1xyXG4gICAgY29uc3Qgc3VtID0gYmlnSW50RnJvbVBhcnRzKHZhbHVlKTtcclxuICAgIGNvbnN0IGNvdW50ID0gTnVtYmVyKHZhbHVlLmMgfHwgMCk7XHJcbiAgICBjb25zdCBhdmcgPSBjb3VudCA+IDAgPyAoc3VtIC8gQmlnSW50KE1hdGgucm91bmQoY291bnQpKSkgOiBzdW07XHJcbiAgICByZXR1cm4gYXZnLnRvU3RyaW5nKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBBZ2dyZWdhdGlvbkhlbHBlckZhY3Rvcnkge1xyXG4gICAgc3RhdGljIGNyZWF0ZShjb2xsZWN0aW9uOiBzdHJpbmcsIGluZGV4OiBudW1iZXIsIGFnZ3JlZ2F0aW9uOiBGaWVsZEFnZ3JlZ2F0aW9uKTogQWdncmVnYXRpb25IZWxwZXIge1xyXG4gICAgICAgIGNvbnN0IGZpZWxkID0gc2NhbGFyRmllbGRzLmdldChgJHtjb2xsZWN0aW9ufS4ke2FnZ3JlZ2F0aW9uLmZpZWxkIHx8ICdpZCd9YCkgfHwgY291bnRGaWVsZDtcclxuICAgICAgICBjb25zdCBmbiA9IGFnZ3JlZ2F0aW9uLmZuIHx8IEFnZ3JlZ2F0aW9uRm4uQ09VTlQ7XHJcbiAgICAgICAgY29uc3QgY29udGV4dDogQWdncmVnYXRpb25Db250ZXh0ID0ge1xyXG4gICAgICAgICAgICBpbmRleCxcclxuICAgICAgICAgICAgZmllbGQsXHJcbiAgICAgICAgICAgIGZuLFxyXG4gICAgICAgICAgICBiaWdJbnRQcmVmaXg6IChmaWVsZC50eXBlID09PSAndWludDEwMjQnKSA/IDIgOiAoZmllbGQudHlwZSA9PT0gJ3VpbnQ2NCcgPyAxIDogMCksXHJcbiAgICAgICAgICAgIGlzQXJyYXk6IGZpZWxkLnBhdGguaW5jbHVkZXMoJ1sqXScpLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChjb250ZXh0LmZuID09PSBBZ2dyZWdhdGlvbkZuLkNPVU5UKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0LFxyXG4gICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogY291bnQsXHJcbiAgICAgICAgICAgICAgICBjb252ZXJ0UmVzdWx0OiBjb252ZXJ0Tm9uZSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjb250ZXh0LmZpZWxkLnBhdGggPT09ICcnKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgWyR7YWdncmVnYXRpb24uZmllbGR9XSBjYW4ndCBiZSBhZ2dyZWdhdGVkYCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZm4gPT09IEFnZ3JlZ2F0aW9uRm4uTUlOIHx8IGZuID09PSBBZ2dyZWdhdGlvbkZuLk1BWCkge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgY29udGV4dCxcclxuICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IHNpbXBsZSxcclxuICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGNvbnRleHQuYmlnSW50UHJlZml4ID4gMFxyXG4gICAgICAgICAgICAgICAgICAgID8gYmlnSW50U3RyaW5nXHJcbiAgICAgICAgICAgICAgICAgICAgOiBjb252ZXJ0Tm9uZSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChmaWVsZC50eXBlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgY29udGV4dCxcclxuICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IHNpbXBsZSxcclxuICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGNvbnZlcnROb25lLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGNvbnRleHQuYmlnSW50UHJlZml4ID4gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gKGNvbnRleHQuZm4gPT09IEFnZ3JlZ2F0aW9uRm4uQVZFUkFHRSlcclxuICAgICAgICAgICAgICAgID8ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQsXHJcbiAgICAgICAgICAgICAgICAgICAgYnVpbGRRdWVyeTogYmlnSW50QXZnLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnRSZXN1bHQ6IGJpZ0ludFBhcnRzQXZnLFxyXG4gICAgICAgICAgICAgICAgfSA6IHtcclxuICAgICAgICAgICAgICAgICAgICBjb250ZXh0LFxyXG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkUXVlcnk6IGJpZ0ludFN1bSxcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJ0UmVzdWx0OiBiaWdJbnRQYXJ0cyxcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske2FnZ3JlZ2F0aW9uLmZpZWxkfV0gY2FuJ3QgYmUgdXNlZCB3aXRoIFske2ZufV1gKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgY3JlYXRlUXVlcnkoXHJcbiAgICAgICAgY29sbGVjdGlvbjogc3RyaW5nLFxyXG4gICAgICAgIGZpbHRlcjogc3RyaW5nLFxyXG4gICAgICAgIGZpZWxkczogRmllbGRBZ2dyZWdhdGlvbltdLFxyXG4gICAgKToge1xyXG4gICAgICAgIHRleHQ6IHN0cmluZyxcclxuICAgICAgICBoZWxwZXJzOiBBZ2dyZWdhdGlvbkhlbHBlcltdLFxyXG4gICAgfSB7XHJcbiAgICAgICAgY29uc3QgZmlsdGVyU2VjdGlvbiA9IGZpbHRlciA/IGBGSUxURVIgJHtmaWx0ZXJ9YCA6ICcnO1xyXG4gICAgICAgIGNvbnN0IGhlbHBlcnM6IEFnZ3JlZ2F0aW9uSGVscGVyW10gPSBmaWVsZHMubWFwKChhZ2dyZWdhdGlvbiwgaSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gQWdncmVnYXRpb25IZWxwZXJGYWN0b3J5LmNyZWF0ZShjb2xsZWN0aW9uLCBpLCBhZ2dyZWdhdGlvbik7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGxldCB0ZXh0O1xyXG4gICAgICAgIGNvbnN0IGlzU2luZ2xlQ291bnQgPSAoZmllbGRzLmxlbmd0aCA9PT0gMSkgJiYgKGZpZWxkc1swXS5mbiA9PT0gQWdncmVnYXRpb25Gbi5DT1VOVCk7XHJcbiAgICAgICAgaWYgKGlzU2luZ2xlQ291bnQpIHtcclxuICAgICAgICAgICAgaWYgKGZpbHRlclNlY3Rpb24gIT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICB0ZXh0ID0gYFxyXG4gICAgICAgICAgICAgICAgICAgIEZPUiBkb2MgSU4gJHtjb2xsZWN0aW9ufVxyXG4gICAgICAgICAgICAgICAgICAgICR7ZmlsdGVyU2VjdGlvbn1cclxuICAgICAgICAgICAgICAgICAgICBDT0xMRUNUIFdJVEggQ09VTlQgSU5UTyBhMFxyXG4gICAgICAgICAgICAgICAgICAgIFJFVFVSTiBbYTBdYDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRleHQgPSBgUkVUVVJOIFtMRU5HVEgoJHtjb2xsZWN0aW9ufSldYDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJpZXMgPSBoZWxwZXJzLm1hcCh4ID0+IHguYnVpbGRRdWVyeSh4LmNvbnRleHQpKTtcclxuICAgICAgICAgICAgdGV4dCA9IGBcclxuICAgICAgICAgICAgICAgIEZPUiBkb2MgSU4gJHtjb2xsZWN0aW9ufVxyXG4gICAgICAgICAgICAgICAgJHtmaWx0ZXJTZWN0aW9ufVxyXG4gICAgICAgICAgICAgICAgQ09MTEVDVCBBR0dSRUdBVEUgJHtxdWVyaWVzLm1hcCh4ID0+IHguY29sbGVjdCkuam9pbignLCAnKX1cclxuICAgICAgICAgICAgICAgIFJFVFVSTiBbJHtxdWVyaWVzLm1hcCh4ID0+IHgucmVzdWx0KS5qb2luKCcsICcpfV1gO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0ZXh0LFxyXG4gICAgICAgICAgICBoZWxwZXJzLFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGNvbnZlcnRSZXN1bHRzKHJlc3VsdHM6IGFueVtdLCBoZWxwZXJzOiBBZ2dyZWdhdGlvbkhlbHBlcltdKTogYW55W10ge1xyXG4gICAgICAgIHJldHVybiByZXN1bHRzLm1hcCgoeCwgaSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoeCA9PT0gdW5kZWZpbmVkIHx8IHggPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB4O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGhlbHBlciA9IGhlbHBlcnNbaV07XHJcbiAgICAgICAgICAgIHJldHVybiBoZWxwZXIuY29udmVydFJlc3VsdChoZWxwZXIuY29udGV4dCwgeCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG59XHJcblxyXG4iXX0=