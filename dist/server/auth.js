"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Auth = exports.deniedAccess = exports.grantedAccess = void 0;

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const grantedAccess = Object.freeze({
  granted: true,
  restrictToAccounts: []
});
exports.grantedAccess = grantedAccess;
const deniedAccess = Object.freeze({
  granted: false,
  restrictToAccounts: []
});
exports.deniedAccess = deniedAccess;

class Auth {
  constructor(config) {
    this.config = config;
  }

  static extractAccessKey(req, connection) {
    return req && req.headers && (req.headers.accessKey || req.headers.accesskey) || connection && connection.context && connection.context.accessKey;
  }

  static unauthorizedError() {
    return _utils.QError.unauthorized();
  }

  authServiceRequired() {
    if (!this.config.authorization.endpoint) {
      throw _utils.QError.authServiceUnavailable();
    }
  }

  async requireGrantedAccess(accessKey) {
    const access = await this.getAccessRights(accessKey);

    if (!access.granted) {
      throw Auth.unauthorizedError();
    }

    return access;
  }

  async getAccessRights(accessKey) {
    if (!this.config.authorization.endpoint) {
      return grantedAccess;
    }

    if ((accessKey || '') === '') {
      return deniedAccess;
    }

    const rights = await this.invokeAuth('getAccessRights', {
      accessKey
    });

    if (!rights.restrictToAccounts) {
      rights.restrictToAccounts = [];
    }

    return rights;
  }

  async getManagementAccessKey() {
    this.authServiceRequired();
    return this.invokeAuth('getManagementAccessKey', {});
  }

  async registerAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('registerAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async revokeAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('revokeAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async invokeAuth(method, params) {
    const res = await (0, _nodeFetch.default)(this.config.authorization.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: '1',
        method,
        params
      })
    });

    if (res.status !== 200) {
      throw new Error(`Auth service failed: ${await res.text()}`);
    }

    const response = await res.json();

    if (response.error) {
      throw _utils.QError.auth(response.error);
    }

    return response.result;
  }

}

exports.Auth = Auth;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hdXRoLmpzIl0sIm5hbWVzIjpbImdyYW50ZWRBY2Nlc3MiLCJPYmplY3QiLCJmcmVlemUiLCJncmFudGVkIiwicmVzdHJpY3RUb0FjY291bnRzIiwiZGVuaWVkQWNjZXNzIiwiQXV0aCIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwiZXh0cmFjdEFjY2Vzc0tleSIsInJlcSIsImNvbm5lY3Rpb24iLCJoZWFkZXJzIiwiYWNjZXNzS2V5IiwiYWNjZXNza2V5IiwiY29udGV4dCIsInVuYXV0aG9yaXplZEVycm9yIiwiUUVycm9yIiwidW5hdXRob3JpemVkIiwiYXV0aFNlcnZpY2VSZXF1aXJlZCIsImF1dGhvcml6YXRpb24iLCJlbmRwb2ludCIsImF1dGhTZXJ2aWNlVW5hdmFpbGFibGUiLCJyZXF1aXJlR3JhbnRlZEFjY2VzcyIsImFjY2VzcyIsImdldEFjY2Vzc1JpZ2h0cyIsInJpZ2h0cyIsImludm9rZUF1dGgiLCJnZXRNYW5hZ2VtZW50QWNjZXNzS2V5IiwicmVnaXN0ZXJBY2Nlc3NLZXlzIiwiYWNjb3VudCIsImtleXMiLCJzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IiwicmV2b2tlQWNjZXNzS2V5cyIsIm1ldGhvZCIsInBhcmFtcyIsInJlcyIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5IiwianNvbnJwYyIsImlkIiwic3RhdHVzIiwiRXJyb3IiLCJ0ZXh0IiwicmVzcG9uc2UiLCJqc29uIiwiZXJyb3IiLCJhdXRoIiwicmVzdWx0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBR0E7O0FBQ0E7Ozs7QUFZTyxNQUFNQSxhQUEyQixHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUNyREMsRUFBQUEsT0FBTyxFQUFFLElBRDRDO0FBRXJEQyxFQUFBQSxrQkFBa0IsRUFBRTtBQUZpQyxDQUFkLENBQXBDOztBQUtBLE1BQU1DLFlBQTBCLEdBQUdKLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0FBQ3BEQyxFQUFBQSxPQUFPLEVBQUUsS0FE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QURYLE9BRitDO0FBS3hEeUIsTUFBQUEsSUFBSSxFQUFFQyxJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUNqQkMsUUFBQUEsT0FBTyxFQUFFLEtBRFE7QUFFakJDLFFBQUFBLEVBQUUsRUFBRSxHQUZhO0FBR2pCUCxRQUFBQSxNQUhpQjtBQUlqQkMsUUFBQUE7QUFKaUIsT0FBZjtBQUxrRCxLQUExQyxDQUFsQjs7QUFhQSxRQUFJQyxHQUFHLENBQUNNLE1BQUosS0FBZSxHQUFuQixFQUF3QjtBQUNwQixZQUFNLElBQUlDLEtBQUosQ0FBVyx3QkFBdUIsTUFBTVAsR0FBRyxDQUFDUSxJQUFKLEVBQVcsRUFBbkQsQ0FBTjtBQUNIOztBQUVELFVBQU1DLFFBQVEsR0FBRyxNQUFNVCxHQUFHLENBQUNVLElBQUosRUFBdkI7O0FBQ0EsUUFBSUQsUUFBUSxDQUFDRSxLQUFiLEVBQW9CO0FBQ2hCLFlBQU05QixjQUFPK0IsSUFBUCxDQUFZSCxRQUFRLENBQUNFLEtBQXJCLENBQU47QUFDSDs7QUFFRCxXQUFPRixRQUFRLENBQUNJLE1BQWhCO0FBQ0g7O0FBckdhIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCB0eXBlIHsgUUNvbmZpZyB9IGZyb20gXCIuL2NvbmZpZ1wiO1xyXG5pbXBvcnQgZmV0Y2ggZnJvbSAnbm9kZS1mZXRjaCc7XHJcbmltcG9ydCB7IFFFcnJvciB9IGZyb20gXCIuL3V0aWxzXCI7XHJcblxyXG5leHBvcnQgdHlwZSBBY2Nlc3NLZXkgPSB7XHJcbiAgICBrZXk6IHN0cmluZyxcclxuICAgIHJlc3RyaWN0VG9BY2NvdW50cz86IHN0cmluZ1tdLFxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBBY2Nlc3NSaWdodHMgPSB7XHJcbiAgICBncmFudGVkOiBib29sLFxyXG4gICAgcmVzdHJpY3RUb0FjY291bnRzOiBzdHJpbmdbXSxcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGdyYW50ZWRBY2Nlc3M6IEFjY2Vzc1JpZ2h0cyA9IE9iamVjdC5mcmVlemUoe1xyXG4gICAgZ3JhbnRlZDogdHJ1ZSxcclxuICAgIHJlc3RyaWN0VG9BY2NvdW50czogW10sXHJcbn0pO1xyXG5cclxuZXhwb3J0IGNvbnN0IGRlbmllZEFjY2VzczogQWNjZXNzUmlnaHRzID0gT2JqZWN0LmZyZWV6ZSh7XHJcbiAgICBncmFudGVkOiBmYWxzZSxcclxuICAgIHJlc3RyaWN0VG9BY2NvdW50czogW10sXHJcbn0pO1xyXG5cclxuZXhwb3J0IGNsYXNzIEF1dGgge1xyXG4gICAgY29uZmlnOiBRQ29uZmlnO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGNvbmZpZzogUUNvbmZpZykge1xyXG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBleHRyYWN0QWNjZXNzS2V5KHJlcTogYW55LCBjb25uZWN0aW9uOiBhbnkpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiAocmVxICYmIHJlcS5oZWFkZXJzICYmIChyZXEuaGVhZGVycy5hY2Nlc3NLZXkgfHwgcmVxLmhlYWRlcnMuYWNjZXNza2V5KSlcclxuICAgICAgICAgICAgfHwgKGNvbm5lY3Rpb24gJiYgY29ubmVjdGlvbi5jb250ZXh0ICYmIGNvbm5lY3Rpb24uY29udGV4dC5hY2Nlc3NLZXkpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyB1bmF1dGhvcml6ZWRFcnJvcigpOiBFcnJvciB7XHJcbiAgICAgICAgcmV0dXJuIFFFcnJvci51bmF1dGhvcml6ZWQoKTtcclxuICAgIH1cclxuXHJcbiAgICBhdXRoU2VydmljZVJlcXVpcmVkKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5jb25maWcuYXV0aG9yaXphdGlvbi5lbmRwb2ludCkge1xyXG4gICAgICAgICAgICB0aHJvdyBRRXJyb3IuYXV0aFNlcnZpY2VVbmF2YWlsYWJsZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyByZXF1aXJlR3JhbnRlZEFjY2VzcyhhY2Nlc3NLZXk6IHN0cmluZyB8IHR5cGVvZiB1bmRlZmluZWQpOiBQcm9taXNlPEFjY2Vzc1JpZ2h0cz4ge1xyXG4gICAgICAgIGNvbnN0IGFjY2VzcyA9IGF3YWl0IHRoaXMuZ2V0QWNjZXNzUmlnaHRzKGFjY2Vzc0tleSk7XHJcbiAgICAgICAgaWYgKCFhY2Nlc3MuZ3JhbnRlZCkge1xyXG4gICAgICAgICAgICB0aHJvdyBBdXRoLnVuYXV0aG9yaXplZEVycm9yKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBhY2Nlc3M7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgZ2V0QWNjZXNzUmlnaHRzKGFjY2Vzc0tleTogc3RyaW5nIHwgdHlwZW9mIHVuZGVmaW5lZCk6IFByb21pc2U8QWNjZXNzUmlnaHRzPiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5hdXRob3JpemF0aW9uLmVuZHBvaW50KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBncmFudGVkQWNjZXNzO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoKGFjY2Vzc0tleSB8fCAnJykgPT09ICcnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBkZW5pZWRBY2Nlc3M7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHJpZ2h0cyA9IGF3YWl0IHRoaXMuaW52b2tlQXV0aCgnZ2V0QWNjZXNzUmlnaHRzJywge1xyXG4gICAgICAgICAgICBhY2Nlc3NLZXksXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKCFyaWdodHMucmVzdHJpY3RUb0FjY291bnRzKSB7XHJcbiAgICAgICAgICAgIHJpZ2h0cy5yZXN0cmljdFRvQWNjb3VudHMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJpZ2h0cztcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBnZXRNYW5hZ2VtZW50QWNjZXNzS2V5KCk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICAgICAgdGhpcy5hdXRoU2VydmljZVJlcXVpcmVkKCk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlQXV0aCgnZ2V0TWFuYWdlbWVudEFjY2Vzc0tleScsIHt9KTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyByZWdpc3RlckFjY2Vzc0tleXMoXHJcbiAgICAgICAgYWNjb3VudDogc3RyaW5nLFxyXG4gICAgICAgIGtleXM6IEFjY2Vzc0tleVtdLFxyXG4gICAgICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXk6IHN0cmluZ1xyXG4gICAgKTogUHJvbWlzZTxudW1iZXI+IHtcclxuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlUmVxdWlyZWQoKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5pbnZva2VBdXRoKCdyZWdpc3RlckFjY2Vzc0tleXMnLCB7XHJcbiAgICAgICAgICAgIGFjY291bnQsXHJcbiAgICAgICAgICAgIGtleXMsXHJcbiAgICAgICAgICAgIHNpZ25lZE1hbmFnZW1lbnRBY2Nlc3NLZXlcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyByZXZva2VBY2Nlc3NLZXlzKFxyXG4gICAgICAgIGFjY291bnQ6IHN0cmluZyxcclxuICAgICAgICBrZXlzOiBzdHJpbmdbXSxcclxuICAgICAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5OiBzdHJpbmdcclxuICAgICk6IFByb21pc2U8bnVtYmVyPiB7XHJcbiAgICAgICAgdGhpcy5hdXRoU2VydmljZVJlcXVpcmVkKCk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlQXV0aCgncmV2b2tlQWNjZXNzS2V5cycsIHtcclxuICAgICAgICAgICAgYWNjb3VudCxcclxuICAgICAgICAgICAga2V5cyxcclxuICAgICAgICAgICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGludm9rZUF1dGgobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCh0aGlzLmNvbmZpZy5hdXRob3JpemF0aW9uLmVuZHBvaW50LCB7XHJcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxyXG4gICAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcclxuICAgICAgICAgICAgICAgIGlkOiAnMScsXHJcbiAgICAgICAgICAgICAgICBtZXRob2QsXHJcbiAgICAgICAgICAgICAgICBwYXJhbXNcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBdXRoIHNlcnZpY2UgZmFpbGVkOiAke2F3YWl0IHJlcy50ZXh0KCl9YCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcy5qc29uKCk7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7XHJcbiAgICAgICAgICAgIHRocm93IFFFcnJvci5hdXRoKHJlc3BvbnNlLmVycm9yKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByZXNwb25zZS5yZXN1bHQ7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==