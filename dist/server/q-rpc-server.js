"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QRpcServer = void 0;

var _ws = _interopRequireDefault(require("ws"));

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class QRpcServer {
  constructor(options) {
    this.db = options.db;
    this.auth = options.auth;
    this.resolvers = new Map();
    this.db.collections.forEach(c => {
      this.resolvers.set(c.name, c.queryResolver());
    });
    this.port = options.port || 0;
  }

  start() {
    if (this.port === 0) {
      throw new Error('QRpcServer port hasn\'t specified');
    }

    this.wss = new _ws.default.Server({
      port: this.port
    });
    this.wss.on('connection', (ws, req) => {
      const connection = {
        socket: ws,
        remoteAddress: req.connection.remoteAddress
      };
      ws.on('close', () => {});
      ws.on('message', data => {
        (async () => {
          try {
            await this.rpc(connection, data);
          } catch (error) {
            console.error(error);
          }
        })();
      });
    });
  }

  async rpc(connection, data) {
    const request = JSON.parse(data);
    let response;

    try {
      response = {
        jsonrpc: '2.0',
        id: request.id,
        result: await this.dispatch(connection, request.method, request.params)
      };
    } catch (error) {
      response = {
        jsonrpc: '2.0',
        id: request.id,
        error: {
          code: error.code || 500,
          message: error.message
        }
      };
    }

    connection.socket.send(JSON.stringify(response));
  }

  async dispatch(connection, method, params) {
    switch (method) {
      case 'transactions':
      case 'accounts':
      case 'blocks':
      case 'messages':
      case 'block_signatures':
        return this.query(connection, this.db.collectionsByName.get(method), params);

      default:
        throw new Error(`Unknown method [${method}]`);
    }
  }

  async query(connection, collection, params) {
    const resolver = this.resolvers.get(collection.name);
    const docs = await resolver(null, params, {
      auth: this.auth,
      remoteAddress: connection.remoteAddress
    }, {
      operation: {
        selectionSet: params.selection
      }
    });
    return docs;
  }

}

exports.QRpcServer = QRpcServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9xLXJwYy1zZXJ2ZXIuanMiXSwibmFtZXMiOlsiUVJwY1NlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImRiIiwiYXV0aCIsInJlc29sdmVycyIsIk1hcCIsImNvbGxlY3Rpb25zIiwiZm9yRWFjaCIsImMiLCJzZXQiLCJuYW1lIiwicXVlcnlSZXNvbHZlciIsInBvcnQiLCJzdGFydCIsIkVycm9yIiwid3NzIiwiV2ViU29ja2V0IiwiU2VydmVyIiwib24iLCJ3cyIsInJlcSIsImNvbm5lY3Rpb24iLCJzb2NrZXQiLCJyZW1vdGVBZGRyZXNzIiwiZGF0YSIsInJwYyIsImVycm9yIiwiY29uc29sZSIsInJlcXVlc3QiLCJKU09OIiwicGFyc2UiLCJyZXNwb25zZSIsImpzb25ycGMiLCJpZCIsInJlc3VsdCIsImRpc3BhdGNoIiwibWV0aG9kIiwicGFyYW1zIiwiY29kZSIsIm1lc3NhZ2UiLCJzZW5kIiwic3RyaW5naWZ5IiwicXVlcnkiLCJjb2xsZWN0aW9uc0J5TmFtZSIsImdldCIsImNvbGxlY3Rpb24iLCJyZXNvbHZlciIsImRvY3MiLCJvcGVyYXRpb24iLCJzZWxlY3Rpb25TZXQiLCJzZWxlY3Rpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7OztBQTBDTyxNQUFNQSxVQUFOLENBQWlCO0FBTXBCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFJUjtBQUNDLFNBQUtDLEVBQUwsR0FBVUQsT0FBTyxDQUFDQyxFQUFsQjtBQUNBLFNBQUtDLElBQUwsR0FBWUYsT0FBTyxDQUFDRSxJQUFwQjtBQUNBLFNBQUtDLFNBQUwsR0FBaUIsSUFBSUMsR0FBSixFQUFqQjtBQUNBLFNBQUtILEVBQUwsQ0FBUUksV0FBUixDQUFvQkMsT0FBcEIsQ0FBNkJDLENBQUQsSUFBTztBQUMvQixXQUFLSixTQUFMLENBQWVLLEdBQWYsQ0FBbUJELENBQUMsQ0FBQ0UsSUFBckIsRUFBMkJGLENBQUMsQ0FBQ0cs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L0QsRUFBb0Y7QUFDaEYsVUFBTVMsUUFLVSxHQUFHLEtBQUsxQyxTQUFMLENBQWV3QyxHQUFmLENBQW1CQyxVQUFVLENBQUNuQyxJQUE5QixDQUxuQjtBQU1BLFVBQU1xQyxJQUFJLEdBQUcsTUFBTUQsUUFBUSxDQUN2QixJQUR1QixFQUV2QlQsTUFGdUIsRUFHdkI7QUFDSWxDLE1BQUFBLElBQUksRUFBRSxLQUFLQSxJQURmO0FBRUlvQixNQUFBQSxhQUFhLEVBQUVGLFVBQVUsQ0FBQ0U7QUFGOUIsS0FIdUIsRUFPdkI7QUFDSXlCLE1BQUFBLFNBQVMsRUFBRTtBQUNQQyxRQUFBQSxZQUFZLEVBQUVaLE1BQU0sQ0FBQ2E7QUFEZDtBQURmLEtBUHVCLENBQTNCO0FBWUEsV0FBT0gsSUFBUDtBQUNIOztBQW5HbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcclxuaW1wb3J0IEFyYW5nbyBmcm9tICcuL2FyYW5nbyc7XHJcbmltcG9ydCB0eXBlIHtHcmFwaFFMUmVxdWVzdENvbnRleHR9IGZyb20gJy4vYXJhbmdvLWNvbGxlY3Rpb24nO1xyXG5pbXBvcnQge0NvbGxlY3Rpb259IGZyb20gJy4vYXJhbmdvLWNvbGxlY3Rpb24nO1xyXG5pbXBvcnQge0F1dGh9IGZyb20gJy4vYXV0aCc7XHJcbmltcG9ydCB0eXBlIHtGaWVsZFNlbGVjdGlvbiwgT3JkZXJCeX0gZnJvbSAnLi9kYi10eXBlcyc7XHJcblxyXG50eXBlIFJwY1JlcXVlc3QgPSB7XHJcbiAgICBqc29ucnBjOiAnMi4wJyxcclxuICAgIG1ldGhvZDogc3RyaW5nLFxyXG4gICAgcGFyYW1zPzogYW55LFxyXG4gICAgaWQ/OiBzdHJpbmcgfCBudW1iZXIgfCBudWxsLFxyXG59XHJcblxyXG50eXBlIFJwY1Jlc3VsdCA9IHtcclxuICAgIHJlc3VsdDogYW55XHJcbn1cclxuXHJcbnR5cGUgUnBjRXJyb3IgPSB7XHJcbiAgICBlcnJvcjoge1xyXG4gICAgICAgIGNvZGU6IG51bWJlcixcclxuICAgICAgICBtZXNzYWdlOiBzdHJpbmcsXHJcbiAgICAgICAgZGF0YT86IGFueVxyXG4gICAgfVxyXG59XHJcblxyXG50eXBlIFJwY1Jlc3BvbnNlID0ge1xyXG4gICAganNvbnJwYzogJzIuMCcsXHJcbiAgICBpZDogc3RyaW5nIHwgbnVtYmVyIHwgbnVsbCxcclxufSAmIChScGNSZXN1bHQgfCBScGNFcnJvcilcclxuXHJcbnR5cGUgUXVlcnlQYXJhbXMgPSB7XHJcbiAgICBmaWx0ZXI6IGFueSxcclxuICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcclxuICAgIG9yZGVyQnk/OiBPcmRlckJ5W10sXHJcbiAgICBsaW1pdD86IG51bWJlcixcclxuICAgIHRpbWVvdXQ/OiBudW1iZXIsXHJcbiAgICBhY2Nlc3NLZXk/OiBzdHJpbmcsXHJcbiAgICBvcGVyYXRpb25JZD86IHN0cmluZyxcclxufVxyXG5cclxudHlwZSBScGNDb25uZWN0aW9uID0ge1xyXG4gICAgc29ja2V0OiBXZWJTb2NrZXQsXHJcbiAgICByZW1vdGVBZGRyZXNzOiBzdHJpbmcsXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBRUnBjU2VydmVyIHtcclxuICAgIGRiOiBBcmFuZ287XHJcbiAgICBhdXRoOiBBdXRoO1xyXG4gICAgcmVzb2x2ZXJzOiBNYXA8c3RyaW5nLCAoKSA9PiBQcm9taXNlPjtcclxuICAgIHBvcnQ6IG51bWJlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiB7XHJcbiAgICAgICAgZGI6IEFyYW5nbyxcclxuICAgICAgICBhdXRoOiBBdXRoLFxyXG4gICAgICAgIHBvcnQ/OiBudW1iZXIsXHJcbiAgICB9KSB7XHJcbiAgICAgICAgdGhpcy5kYiA9IG9wdGlvbnMuZGI7XHJcbiAgICAgICAgdGhpcy5hdXRoID0gb3B0aW9ucy5hdXRoO1xyXG4gICAgICAgIHRoaXMucmVzb2x2ZXJzID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIHRoaXMuZGIuY29sbGVjdGlvbnMuZm9yRWFjaCgoYykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnJlc29sdmVycy5zZXQoYy5uYW1lLCBjLnF1ZXJ5UmVzb2x2ZXIoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5wb3J0ID0gb3B0aW9ucy5wb3J0IHx8IDA7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhcnQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucG9ydCA9PT0gMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1FScGNTZXJ2ZXIgcG9ydCBoYXNuXFwndCBzcGVjaWZpZWQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy53c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7cG9ydDogdGhpcy5wb3J0fSk7XHJcbiAgICAgICAgdGhpcy53c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MsIHJlcSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb25uZWN0aW9uOiBScGNDb25uZWN0aW9uID0ge1xyXG4gICAgICAgICAgICAgICAgc29ja2V0OiB3cyxcclxuICAgICAgICAgICAgICAgIHJlbW90ZUFkZHJlc3M6IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3MsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHdzLm9uKCdjbG9zZScsICgpID0+IHtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHdzLm9uKCdtZXNzYWdlJywgKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgIChhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5ycGMoY29ubmVjdGlvbiwgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSkoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgcnBjKGNvbm5lY3Rpb246IFJwY0Nvbm5lY3Rpb24sIGRhdGE6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHJlcXVlc3Q6IFJwY1JlcXVlc3QgPSBKU09OLnBhcnNlKGRhdGEpO1xyXG4gICAgICAgIGxldCByZXNwb25zZTogUnBjUmVzcG9uc2U7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcmVzcG9uc2UgPSB7XHJcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcclxuICAgICAgICAgICAgICAgIGlkOiByZXF1ZXN0LmlkLFxyXG4gICAgICAgICAgICAgICAgcmVzdWx0OiBhd2FpdCB0aGlzLmRpc3BhdGNoKGNvbm5lY3Rpb24sIHJlcXVlc3QubWV0aG9kLCByZXF1ZXN0LnBhcmFtcyksXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgcmVzcG9uc2UgPSB7XHJcbiAgICAgICAgICAgICAgICBqc29ucnBjOiAnMi4wJyxcclxuICAgICAgICAgICAgICAgIGlkOiByZXF1ZXN0LmlkLFxyXG4gICAgICAgICAgICAgICAgZXJyb3I6IHtcclxuICAgICAgICAgICAgICAgICAgICBjb2RlOiBlcnJvci5jb2RlIHx8IDUwMCxcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25uZWN0aW9uLnNvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgZGlzcGF0Y2goY29ubmVjdGlvbjogUnBjQ29ubmVjdGlvbiwgbWV0aG9kOiBzdHJpbmcsIHBhcmFtczogYW55KSB7XHJcbiAgICAgICAgc3dpdGNoIChtZXRob2QpIHtcclxuICAgICAgICBjYXNlICd0cmFuc2FjdGlvbnMnOlxyXG4gICAgICAgIGNhc2UgJ2FjY291bnRzJzpcclxuICAgICAgICBjYXNlICdibG9ja3MnOlxyXG4gICAgICAgIGNhc2UgJ21lc3NhZ2VzJzpcclxuICAgICAgICBjYXNlICdibG9ja19zaWduYXR1cmVzJzpcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVlcnkoY29ubmVjdGlvbiwgdGhpcy5kYi5jb2xsZWN0aW9uc0J5TmFtZS5nZXQobWV0aG9kKSwgcGFyYW1zKTtcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gbWV0aG9kIFske21ldGhvZH1dYCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHF1ZXJ5KGNvbm5lY3Rpb246IFJwY0Nvbm5lY3Rpb24sIGNvbGxlY3Rpb246IENvbGxlY3Rpb24sIHBhcmFtczogUXVlcnlQYXJhbXMpIHtcclxuICAgICAgICBjb25zdCByZXNvbHZlcjogKFxyXG4gICAgICAgICAgICBwYXJlbnQ6IGFueSxcclxuICAgICAgICAgICAgYXJnczogYW55LFxyXG4gICAgICAgICAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHQsXHJcbiAgICAgICAgICAgIGluZm86IGFueSxcclxuICAgICAgICApID0+IFByb21pc2U8W10+ID0gdGhpcy5yZXNvbHZlcnMuZ2V0KGNvbGxlY3Rpb24ubmFtZSk7XHJcbiAgICAgICAgY29uc3QgZG9jcyA9IGF3YWl0IHJlc29sdmVyKFxyXG4gICAgICAgICAgICBudWxsLFxyXG4gICAgICAgICAgICBwYXJhbXMsXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGF1dGg6IHRoaXMuYXV0aCxcclxuICAgICAgICAgICAgICAgIHJlbW90ZUFkZHJlc3M6IGNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzcyxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgb3BlcmF0aW9uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uU2V0OiBwYXJhbXMuc2VsZWN0aW9uLFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZG9jcztcclxuICAgIH1cclxufVxyXG4iXX0=